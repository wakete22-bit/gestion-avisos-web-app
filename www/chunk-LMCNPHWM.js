import{a as j}from"./chunk-I4V5EUSG.js";import"./chunk-L7R4HPYP.js";import{a as T}from"./chunk-X25QJQMB.js";import"./chunk-52VVF7TW.js";import"./chunk-JNUN2KTT.js";import"./chunk-3NJZR3TT.js";import"./chunk-N4FKO75N.js";import"./chunk-KYCVJEX4.js";import"./chunk-FK6H3RFT.js";import"./chunk-7FW4253V.js";import{a as L}from"./chunk-ZLE3SS2Y.js";import"./chunk-ZFUZ5UD4.js";import{Ca as o,Da as u,Ea as k,L as P,M as y,Ra as O,Ta as M,X as s,Y as p,_ as I,c as w,ca as b,ha as l,la as n,ma as i,na as f,ob as R,ra as F,rb as U,sa as D,ta as g,u as E,z as v}from"./chunk-QQQKELKR.js";import"./chunk-FMBN6UXO.js";import"./chunk-QUJFQN2Y.js";import"./chunk-T4LV2MRW.js";import"./chunk-QZ7DKK3O.js";import"./chunk-7NXYYB6M.js";import"./chunk-G2E2NLL6.js";import"./chunk-HZSDEEV2.js";import"./chunk-AO65UGJX.js";import"./chunk-MYMWTHTI.js";import"./chunk-YNWT2DLU.js";import"./chunk-2ELISCRH.js";import"./chunk-BV4CTHEE.js";import"./chunk-XPQFWPU3.js";import"./chunk-6SS6CZRK.js";import"./chunk-LBMIQEU6.js";import"./chunk-WI5MSH4N.js";import"./chunk-CGQGPWKF.js";import"./chunk-CKP3SGE2.js";import"./chunk-FAIKFHLE.js";import"./chunk-NBD2MYJO.js";import"./chunk-3SBX7V6R.js";import"./chunk-SQKDQBOS.js";import"./chunk-SWRJZAEI.js";import"./chunk-JCSW2JUV.js";import"./chunk-FXFZIWDD.js";import"./chunk-36KMLI7A.js";import"./chunk-C5RQ2IC2.js";import"./chunk-42C7ZIID.js";import{k as x}from"./chunk-CRC5ZNR6.js";function A(r,d){if(r&1&&(n(0,"div",12)(1,"h3"),o(2,"Informaci\xF3n de la Factura"),i(),n(3,"div",13)(4,"div",14)(5,"span",15),o(6,"Cliente:"),i(),n(7,"span",16),o(8),i()(),n(9,"div",14)(10,"span",15),o(11,"Fecha:"),i(),n(12,"span",16),o(13),O(14,"date"),i()(),n(15,"div",14)(16,"span",15),o(17,"Total:"),i(),n(18,"span",16),o(19),O(20,"currency"),i()()()()),r&2){let c=g(2);s(8),u(c.datosFactura.nombre_cliente),s(5),u(M(14,3,c.datosFactura.fecha_emision,"dd/MM/yyyy")),s(6),u(M(20,6,c.datosFactura.total,"EUR"))}}function $(r,d){r&1&&f(0,"ion-icon",17)}function z(r,d){r&1&&f(0,"ion-icon",18)}function V(r,d){if(r&1){let c=F();n(0,"div",4)(1,"div",5)(2,"h1"),o(3,"\u{1F4C4} Descarga de Factura"),i(),n(4,"p"),o(5,"Factura: "),n(6,"strong"),o(7),i()()(),b(8,A,21,9,"div",6),n(9,"div",7)(10,"button",8),D("click",function(){P(c);let t=g();return y(t.descargarPDF())}),b(11,$,1,0,"ion-icon",9)(12,z,1,0,"ion-icon",10),o(13),i()(),n(14,"div",11)(15,"p"),o(16,"T\xC9CNICOS CLIMATIZACI\xD3N S.L."),i(),n(17,"p"),o(18,"\u{1F4E7} info@tecnicosclimatizacion.es | \u{1F4DE} +34 91 123 45 67"),i()()()}if(r&2){let c=g();s(7),u(c.numeroFactura),s(),l("ngIf",c.datosFactura),s(2),l("disabled",c.descargando),s(),l("ngIf",!c.descargando),s(),l("ngIf",c.descargando),s(),k(" ",c.descargando?"Generando PDF...":"Descargar PDF"," ")}}function N(r,d){r&1&&(n(0,"div",19),f(1,"ion-icon",18),n(2,"p"),o(3,"Cargando factura..."),i()())}function q(r,d){if(r&1){let c=F();n(0,"div",20),f(1,"ion-icon",21),n(2,"h3"),o(3,"Error"),i(),n(4,"p"),o(5),i(),n(6,"button",22),D("click",function(){P(c);let t=g();return y(t.reintentar())}),o(7,"Reintentar"),i()()}if(r&2){let c=g();s(5),u(c.error)}}var Q=(()=>{let d=class d{constructor(e,t,a,m,_){this.route=e,this.router=t,this.pdfService=a,this.facturasService=m,this.unifiedReconnectionService=_,this.numeroFactura="",this.datosFactura=null,this.cargando=!0,this.descargando=!1,this.error=null,this.destroy$=new w}ngOnInit(){console.log("\u{1F504} DescargaPublicaComponent inicializado"),this.unifiedReconnectionService.appResumed.pipe(v(this.destroy$),E()).subscribe(e=>{e&&(console.log("\u{1F504} DescargaPublicaComponent: App reanudada, recargando factura..."),this.numeroFactura&&this.cargarFactura())}),this.unifiedReconnectionService.connectionState.pipe(v(this.destroy$)).subscribe(e=>{console.log("\u{1F504} DescargaPublicaComponent: Estado de conexi\xF3n:",e),e==="connected"&&this.numeroFactura&&!this.datosFactura&&this.cargarFactura()}),this.route.queryParams.subscribe(e=>{this.numeroFactura=e.factura||"";let t=e.file,a=e.name;this.numeroFactura&&t?this.descargarPDFDesdeBase64(t,a):this.numeroFactura?this.cargarFactura():(this.error="N\xFAmero de factura no proporcionado",this.cargando=!1)})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}descargarPDFDesdeBase64(e,t){return x(this,null,function*(){try{this.cargando=!0,this.error=null;let a=atob(e),m=new Array(a.length);for(let h=0;h<a.length;h++)m[h]=a.charCodeAt(h);let _=new Uint8Array(m),B=new Blob([_],{type:"application/pdf"}),S=URL.createObjectURL(B),C=document.createElement("a");C.href=S,C.download=t||`factura_${this.numeroFactura}.pdf`,C.click(),URL.revokeObjectURL(S),this.datosFactura={nombre_cliente:"Cliente",fecha_emision:new Date,total:0}}catch(a){console.error("Error al descargar PDF desde base64:",a),this.error="Error al procesar el archivo PDF"}finally{this.cargando=!1}})}cargarFactura(){return x(this,null,function*(){try{this.cargando=!0,this.error=null,console.log("\u{1F504} Cargando factura para descarga p\xFAblica:",this.numeroFactura);let e=yield this.facturasService.buscarFacturasDirect(this.numeroFactura).toPromise(),t=e==null?void 0:e.find(a=>a.numero_factura===this.numeroFactura);t?(console.log("\u2705 Factura encontrada para descarga p\xFAblica:",t),this.datosFactura=t):(console.log("\u274C Factura no encontrada para descarga p\xFAblica"),this.error="Factura no encontrada")}catch(e){console.error("\u274C Error al cargar factura para descarga p\xFAblica:",e),this.error="Error al cargar la factura"}finally{this.cargando=!1}})}descargarPDF(){return x(this,null,function*(){if(this.datosFactura)try{this.descargando=!0;let e=yield this.pdfService.generarPdfBlob(this.datosFactura,`factura_${this.numeroFactura}.pdf`),t=URL.createObjectURL(e),a=document.createElement("a");a.href=t,a.download=`factura_${this.numeroFactura}.pdf`,a.click(),URL.revokeObjectURL(t)}catch(e){console.error("Error al descargar PDF:",e),this.error="Error al generar el PDF"}finally{this.descargando=!1}})}reintentar(){this.cargarFactura()}};d.\u0275fac=function(t){return new(t||d)(p(R),p(U),p(j),p(T),p(L))},d.\u0275cmp=I({type:d,selectors:[["app-descarga-publica"]],decls:4,vars:3,consts:[[1,"descarga-container"],["class","descarga-content",4,"ngIf"],["class","loading",4,"ngIf"],["class","error",4,"ngIf"],[1,"descarga-content"],[1,"header"],["class","factura-info",4,"ngIf"],[1,"download-section"],[1,"btn-download",3,"click","disabled"],["name","download-outline",4,"ngIf"],["name","refresh-outline","class","spinning",4,"ngIf"],[1,"footer"],[1,"factura-info"],[1,"info-grid"],[1,"info-item"],[1,"label"],[1,"value"],["name","download-outline"],["name","refresh-outline",1,"spinning"],[1,"loading"],[1,"error"],["name","alert-circle-outline"],[1,"btn-retry",3,"click"]],template:function(t,a){t&1&&(n(0,"div",0),b(1,V,19,6,"div",1)(2,N,4,0,"div",2)(3,q,8,1,"div",3),i()),t&2&&(s(),l("ngIf",!a.cargando&&!a.error),s(),l("ngIf",a.cargando),s(),l("ngIf",a.error))},styles:[".descarga-container[_ngcontent-%COMP%]{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea,#764ba2);padding:20px}.descarga-content[_ngcontent-%COMP%]{background:#fff;border-radius:15px;padding:40px;box-shadow:0 20px 40px #0000001a;max-width:500px;width:100%;text-align:center}.header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{color:#2563eb;margin-bottom:10px;font-size:28px}.header[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:#666;font-size:16px;margin-bottom:30px}.factura-info[_ngcontent-%COMP%]{background:#f8fafc;border-radius:10px;padding:20px;margin:20px 0;text-align:left}.factura-info[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{color:#2563eb;margin-bottom:15px;text-align:center}.info-grid[_ngcontent-%COMP%]{display:grid;gap:10px}.info-item[_ngcontent-%COMP%]{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e5e7eb}.info-item[_ngcontent-%COMP%]:last-child{border-bottom:none}.label[_ngcontent-%COMP%]{font-weight:600;color:#374151}.value[_ngcontent-%COMP%]{color:#6b7280}.download-section[_ngcontent-%COMP%]{margin:30px 0}.btn-download[_ngcontent-%COMP%]{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;border:none;padding:15px 30px;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:10px;margin:0 auto;transition:all .3s ease}.btn-download[_ngcontent-%COMP%]:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 10px 20px #2563eb4d}.btn-download[_ngcontent-%COMP%]:disabled{opacity:.7;cursor:not-allowed}.footer[_ngcontent-%COMP%]{margin-top:30px;padding-top:20px;border-top:1px solid #e5e7eb;color:#6b7280;font-size:14px}.loading[_ngcontent-%COMP%], .error[_ngcontent-%COMP%]{text-align:center;color:#fff}.loading[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%], .error[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:48px;margin-bottom:20px}.spinning[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_spin 1s linear infinite}@keyframes _ngcontent-%COMP%_spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.error[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:20px 0 10px;color:#ef4444}.btn-retry[_ngcontent-%COMP%]{background:#ef4444;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;margin-top:15px}"]});let r=d;return r})();export{Q as DescargaPublicaComponent};
