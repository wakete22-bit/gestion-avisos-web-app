import{a as M}from"./chunk-PP5OIZL5.js";import{a as y}from"./chunk-NVYZAR2B.js";import{a as $}from"./chunk-4OHMYGXZ.js";import{a as F}from"./chunk-Z5X5YNR5.js";import{a as x}from"./chunk-LZ7UC2UF.js";import{b as w}from"./chunk-QYHMYRPA.js";import{C as _,F as h,c as z,e as l,j as u,m as S,q as m,w as c,y as j}from"./chunk-JSLDYZN7.js";import{a as T,b as E,d as D}from"./chunk-CRC5ZNR6.js";var k=(()=>{let p=class p{constructor(e,a){this.inventarioService=e,this.supabaseClientService=a,this.materialesSubject=new z([]),this.materiales$=this.materialesSubject.asObservable(),this.supabase=this.supabaseClientService.getClient()}getMaterialesTrabajo(e){return l(this.supabase.from("materiales_trabajo").select(`
          *,
          material:inventario(*)
        `).eq("trabajo_id",e).order("id",{ascending:!0})).pipe(u(({data:a,error:t})=>{if(t)throw t;let r=a;return this.materialesSubject.next(r),r}),m(a=>{throw console.error("Error al obtener materiales del trabajo:",a),a}))}agregarMateriales(e,a){if(a.length===0)return l([[]]);let t=a.map(r=>({trabajo_id:e,material_id:r.material_id,cantidad_utilizada:r.cantidad_utilizada,precio_neto_al_momento:r.precio_neto_al_momento}));return l(this.supabase.from("materiales_trabajo").insert(t).select(`
          *,
          material:inventario(*)
        `)).pipe(c(({data:r,error:i})=>{if(i)throw i;let o=r,s=this.materialesSubject.value;this.materialesSubject.next([...s,...o]);let n=o.map(d=>{let b=d.material.cantidad_disponible-d.cantidad_utilizada;return this.inventarioService.actualizarStock(d.material_id,b)});return S(n).pipe(u(()=>o))}),m(r=>{throw console.error("Error al agregar materiales al trabajo:",r),r}))}actualizarMaterial(e,a){return l(this.supabase.from("materiales_trabajo").select(`
          *,
          material:inventario(*)
        `).eq("id",e).single()).pipe(c(({data:t,error:r})=>{if(r)throw r;let i=t,o=i.cantidad_utilizada,n=(a.cantidad_utilizada||o)-o,d={cantidad_utilizada:a.cantidad_utilizada,precio_neto_al_momento:a.precio_neto_al_momento};return l(this.supabase.from("materiales_trabajo").update(d).eq("id",e).select(`
              *,
              material:inventario(*)
            `).single()).pipe(c(({data:b,error:g})=>{if(g)throw g;let v=b,A=this.materialesSubject.value,P=A.findIndex(C=>C.id===e);if(P!==-1&&(A[P]=v,this.materialesSubject.next([...A])),n!==0){let C=i.material.cantidad_disponible-n;return this.inventarioService.actualizarStock(i.material_id,C).pipe(u(()=>v))}return l([v])}))}),m(t=>{throw console.error("Error al actualizar material:",t),t}))}eliminarMaterial(e){return l(this.supabase.from("materiales_trabajo").select(`
          *,
          material:inventario(*)
        `).eq("id",e).single()).pipe(c(({data:a,error:t})=>{if(t)throw t;let r=a;return l(this.supabase.from("materiales_trabajo").delete().eq("id",e)).pipe(c(({error:i})=>{if(i)throw i;let s=this.materialesSubject.value.filter(d=>d.id!==e);this.materialesSubject.next(s);let n=r.material.cantidad_disponible+r.cantidad_utilizada;return this.inventarioService.actualizarStock(r.material_id,n).pipe(u(()=>{}))}))}),m(a=>{throw console.error("Error al eliminar material:",a),a}))}eliminarMaterialesTrabajo(e){return l(this.supabase.from("materiales_trabajo").select(`
          *,
          material:inventario(*)
        `).eq("trabajo_id",e)).pipe(c(({data:a,error:t})=>{if(t)throw t;let r=a;return l(this.supabase.from("materiales_trabajo").delete().eq("trabajo_id",e)).pipe(c(({error:i})=>{if(i)throw i;let s=this.materialesSubject.value.filter(n=>n.trabajo_id!==e);if(this.materialesSubject.next(s),r.length>0){let n=r.map(d=>{let b=d.material.cantidad_disponible+d.cantidad_utilizada;return this.inventarioService.actualizarStock(d.material_id,b)});return S(n).pipe(u(()=>{}))}return l([void 0])}))}),m(a=>{throw console.error("Error al eliminar materiales del trabajo:",a),a}))}calcularCostoMateriales(e){return e.reduce((a,t)=>a+t.cantidad_utilizada*t.precio_neto_al_momento,0)}getMaterialesActuales(){return this.materialesSubject.value}limpiarMateriales(){this.materialesSubject.next([])}};p.\u0275fac=function(a){return new(a||p)(h($),h(w))},p.\u0275prov=_({token:p,factory:p.\u0275fac,providedIn:"root"});let f=p;return f})();var O=(()=>{let p=class p{constructor(e,a,t){this.materialesTrabajoService=e,this.supabaseClientService=a,this.dataUpdateService=t,this.trabajosSubject=new z([]),this.trabajos$=this.trabajosSubject.asObservable(),this.supabase=this.supabaseClientService.getClient()}getTrabajosAviso(e,a=1,t=10){let r=(a-1)*t;return l(this.supabase.from("trabajos_realizados").select("*",{count:"exact"}).eq("aviso_id",e).order("fecha_trabajo",{ascending:!1}).range(r,r+t-1)).pipe(u(({data:i,error:o,count:s})=>{if(o)throw o;let n=i;return this.trabajosSubject.next(n),{trabajos:n,total:s||0,pagina:a,por_pagina:t}}),m(i=>{throw console.error("Error al obtener trabajos:",i),i}))}getTrabajo(e){return l(this.supabase.from("trabajos_realizados").select("*").eq("id",e).single()).pipe(c(({data:a,error:t})=>{if(t)throw t;let r=a;return this.materialesTrabajoService.getMaterialesTrabajo(e).pipe(u(i=>({trabajo:r,materiales:i})))}),m(a=>{throw console.error("Error al obtener trabajo:",a),a}))}crearTrabajo(e){let i=e,{materiales:a}=i,t=D(i,["materiales"]),r=E(T({},t),{fecha_creacion:new Date().toISOString(),fecha_actualizacion:new Date().toISOString()});return l(this.supabase.from("trabajos_realizados").insert([r]).select().single()).pipe(c(({data:o,error:s})=>{if(s)throw s;let n=o,d=this.trabajosSubject.value;return this.trabajosSubject.next([n,...d]),this.dataUpdateService.notifyCreated("trabajos"),!a||a.length===0?l([{trabajo:n,materiales:[]}]):this.materialesTrabajoService.agregarMateriales(n.id,a).pipe(u(b=>({trabajo:n,materiales:b})))}),m(o=>{throw console.error("Error al crear trabajo:",o),o}))}actualizarTrabajo(e,a){let o=a,{materiales:t}=o,r=D(o,["materiales"]),i=E(T({},r),{fecha_actualizacion:new Date().toISOString()});return l(this.supabase.from("trabajos_realizados").update(i).eq("id",e).select().single()).pipe(c(({data:s,error:n})=>{if(n)throw n;let d=s,b=this.trabajosSubject.value,g=b.findIndex(v=>v.id===e);return g!==-1&&(b[g]=d,this.trabajosSubject.next([...b])),this.dataUpdateService.notifyUpdated("trabajos"),t?this.materialesTrabajoService.eliminarMaterialesTrabajo(e).pipe(c(()=>t.length===0?l([{trabajo:d,materiales:[]}]):this.materialesTrabajoService.agregarMateriales(e,t).pipe(u(v=>({trabajo:d,materiales:v}))))):this.getTrabajo(e)}),m(s=>{throw console.error("Error al actualizar trabajo:",s),s}))}eliminarTrabajo(e){return this.materialesTrabajoService.eliminarMaterialesTrabajo(e).pipe(c(()=>l(this.supabase.from("trabajos_realizados").delete().eq("id",e))),u(({error:a})=>{if(a)throw a;let r=this.trabajosSubject.value.filter(i=>i.id!==e);this.trabajosSubject.next(r),this.dataUpdateService.notifyDeleted("trabajos")}),m(a=>{throw console.error("Error al eliminar trabajo:",a),a}))}getEstadisticasTrabajos(e){return l(this.supabase.from("trabajos_realizados").select("*").eq("aviso_id",e)).pipe(u(({data:a,error:t})=>{if(t)throw t;let r=a;return{totalTrabajos:r.length,trabajosCompletados:r.filter(o=>o.estado==="Completado").length,trabajosPendientes:r.filter(o=>o.estado==="Pendiente").length,trabajosEnCurso:r.filter(o=>o.estado==="En curso").length,trabajosCancelados:r.filter(o=>o.estado==="Cancelado").length,totalHoras:r.reduce((o,s)=>{let n=new Date(`2000-01-01T${s.hora_inicio}`),b=(new Date(`2000-01-01T${s.hora_fin}`).getTime()-n.getTime())/(1e3*60*60);return o+Math.max(0,b)},0)}}))}getTrabajosActuales(){return this.trabajosSubject.value}limpiarTrabajos(){this.trabajosSubject.next([]),this.materialesTrabajoService.limpiarMateriales()}actualizarEstadoTrabajo(e,a,t){let r={estado:a,fecha_actualizacion:new Date().toISOString()};return t&&(r.albaran_id=t),l(this.supabase.from("trabajos_realizados").update(r).eq("id",e).select().single()).pipe(u(({data:i,error:o})=>{if(o)throw o;let s=i,n=this.trabajosSubject.value,d=n.findIndex(b=>b.id===e);return d!==-1&&(n[d]=s,this.trabajosSubject.next([...n])),this.dataUpdateService.notifyUpdated("trabajos"),s}),m(i=>{throw console.error("Error al actualizar estado del trabajo:",i),i}))}};p.\u0275fac=function(a){return new(a||p)(h(k),h(w),h(F))},p.\u0275prov=_({token:p,factory:p.\u0275fac,providedIn:"root"});let f=p;return f})();var Z=(()=>{let p=class p{constructor(e,a,t,r){this.avisosService=e,this.facturasService=a,this.presupuestosService=t,this.trabajosService=r}obtenerEstadoFlujo(e){return this.avisosService.getResumenCompletoAviso(e).pipe(u(a=>({avisoId:e,estadoActual:a.estado,puedeCrearPresupuesto:this.puedeCrearPresupuesto(a),puedeAprobarPresupuesto:this.puedeAprobarPresupuesto(a),puedeFacturarPresupuesto:this.puedeFacturarPresupuesto(a),puedeFacturarTrabajos:this.puedeFacturarTrabajos(a),puedeCompletarAviso:this.puedeCompletarAviso(a),resumen:a})))}ejecutarFlujoCompleto(e,a=!0){return a?this.flujoConPresupuesto(e):this.flujoDirectoSinPresupuesto(e)}flujoDirectoSinPresupuesto(e){return this.avisosService.actualizarAviso(e,{estado:"En curso",requiere_presupuesto:!1}).pipe(j(()=>console.log("\u2705 Aviso actualizado para trabajo directo")),c(()=>this.avisosService.getResumenCompletoAviso(e)),u(a=>({paso:"flujo_directo_iniciado",avisoId:e,mensaje:"Flujo directo iniciado. El t\xE9cnico puede comenzar a trabajar.",resumen:a})))}flujoConPresupuesto(e){return this.avisosService.actualizarAviso(e,{estado:"Pendiente de presupuesto",requiere_presupuesto:!0}).pipe(j(()=>console.log("\u2705 Aviso marcado como requiere presupuesto")),c(()=>this.presupuestosService.crearPresupuesto({aviso_id:e,horas_estimadas:2,total_estimado:0})),j(()=>console.log("\u2705 Presupuesto creado")),u(a=>({paso:"presupuesto_creado",avisoId:e,presupuestoId:a.id,mensaje:"Presupuesto creado. Pendiente de evaluaci\xF3n y aprobaci\xF3n.",presupuesto:a})))}aprobarPresupuesto(e){return this.presupuestosService.cambiarEstado(e,"Completado").pipe(c(a=>this.avisosService.actualizarAviso(a.aviso_id,{estado:"En curso"})),j(()=>console.log("\u2705 Presupuesto aprobado y aviso en curso")),u(a=>({paso:"presupuesto_aprobado",avisoId:a.id,mensaje:"Presupuesto aprobado. El t\xE9cnico puede comenzar a trabajar.",aviso:a})))}facturarPresupuesto(e){return this.facturasService.crearFacturaDesdePresupuesto(e).pipe(j(()=>console.log("\u2705 Factura creada desde presupuesto")),c(a=>this.avisosService.actualizarEstadoAutomatico(a.factura.aviso_id).pipe(u(()=>a))),u(a=>({paso:"factura_desde_presupuesto",avisoId:a.factura.aviso_id,facturaId:a.factura.id,mensaje:"Factura generada autom\xE1ticamente desde presupuesto aprobado.",factura:a})))}facturarTrabajos(e){return console.log("\u{1F527} Iniciando facturaci\xF3n de trabajos para aviso:",e),this.avisosService.getResumenCompletoAviso(e).pipe(c(a=>{var i;if(console.log("\u{1F527} Resumen completo obtenido:",a),!a.estadisticas.trabajosFinalizados)throw new Error("No hay trabajos finalizados para facturar. Debes crear un albar\xE1n primero.");let t=((i=a.trabajos)==null?void 0:i.filter(o=>{var s;return!o.albaran_id||!((s=o.albaran)!=null&&s.estado_cierre)||o.albaran.estado_cierre==="Otra visita"}))||[];if(t.length>0){let o=t.map(s=>{var n;return`Trabajo #${(n=s.id)==null?void 0:n.substring(0,8)} (${s.descripcion})`}).join(", ");throw new Error(`No se puede facturar. Los siguientes trabajos no tienen albaranes cerrados: ${o}. Debes cerrar todos los albaranes antes de facturar.`)}console.log("\u{1F527} Cliente del resumen:",a.cliente);let r=this.convertirDatosAFactura({avisoId:e,cliente:a.cliente,resumen:a});return this.facturasService.getSiguienteNumero().pipe(c(o=>(r.numero_factura=o,console.log("\u{1F527} N\xFAmero de factura generado:",o),this.facturasService.crearFactura(r))))}),j(()=>console.log("\u2705 Factura creada desde trabajos realizados")),c(()=>this.avisosService.getResumenCompletoAviso(e)),u(a=>({paso:"factura_creada_desde_trabajos",avisoId:e,mensaje:"Factura creada exitosamente desde trabajos realizados",resumen:a})))}verificarEstadoFactura(e,a){return this.avisosService.getResumenCompletoAviso(a).pipe(c(t=>t.estado==="Completado"?this.facturasService.cambiarEstado(e,"Completado"):t.estado==="Listo para facturar"?this.facturasService.cambiarEstado(e,"En curso"):l([{id:e,estado:"Pendiente"}])))}sincronizarEstadosFacturas(e){return this.avisosService.getResumenCompletoAviso(e).pipe(c(a=>{if(!a.facturas||a.facturas.length===0)return l([{mensaje:"No hay facturas para sincronizar"}]);let t;a.estado==="Completado"?t="Completado":a.estado==="Listo para facturar"?t="En curso":t="Pendiente";let r=a.facturas.map(i=>this.facturasService.cambiarEstado(i.id,t));return S(r).pipe(u(()=>({mensaje:`Estados de ${a.facturas.length} factura(s) sincronizados a "${t}"`,avisoId:e,nuevoEstado:t})))}))}completarAviso(e){return this.avisosService.getResumenCompletoAviso(e).pipe(c(a=>{var r;if(!this.puedeCompletarAviso(a))throw new Error("No se puede completar el aviso. Verifica que haya trabajos finalizados y facturas generadas.");let t=((r=a.trabajos)==null?void 0:r.filter(i=>{var o;return!i.albaran_id||!((o=i.albaran)!=null&&o.estado_cierre)||i.albaran.estado_cierre==="Otra visita"}))||[];if(t.length>0){let i=t.map(o=>{var s;return`Trabajo #${(s=o.id)==null?void 0:s.substring(0,8)} (${o.descripcion})`}).join(", ");throw new Error(`No se puede completar el aviso. Los siguientes trabajos no tienen albaranes cerrados: ${i}. Debes cerrar todos los albaranes antes de completar el aviso.`)}return this.avisosService.actualizarAviso(e,{estado:"Completado",fecha_finalizacion:new Date}).pipe(c(i=>{if(a.facturas&&a.facturas.length>0){let o=a.facturas.map(s=>this.facturasService.cambiarEstado(s.id,"Completado"));return S(o).pipe(u(()=>i))}return l([i])}))}),j(()=>console.log("\u2705 Aviso completado exitosamente")),c(()=>this.avisosService.getResumenCompletoAviso(e)),u(a=>({paso:"aviso_completado",avisoId:e,mensaje:"Aviso marcado como completado",resumen:a})))}obtenerAccionesDisponibles(e){return this.obtenerEstadoFlujo(e).pipe(u(a=>{let t=[];return a.puedeFacturarTrabajos&&t.push("facturar_trabajos"),a.puedeCompletarAviso&&t.push("completar_aviso"),t}))}puedeCrearPresupuesto(e){return!1}puedeAprobarPresupuesto(e){return!1}puedeFacturarPresupuesto(e){return!1}puedeFacturarTrabajos(e){var t;let a=((t=e.trabajos)==null?void 0:t.every(r=>{var i;return r.albaran_id&&((i=r.albaran)==null?void 0:i.estado_cierre)&&r.albaran.estado_cierre!=="Otra visita"}))||!1;return e.estadisticas.trabajosFinalizados>0&&e.estadisticas.facturasPendientes===0&&a}puedeCompletarAviso(e){var t;let a=((t=e.trabajos)==null?void 0:t.every(r=>{var i;return r.albaran_id&&((i=r.albaran)==null?void 0:i.estado_cierre)&&r.albaran.estado_cierre!=="Otra visita"}))||!1;return e.estadisticas.trabajosFinalizados>0&&e.estadisticas.totalFacturas>0&&a}convertirDatosAFactura(e){var o;if(console.log("\u{1F527} Datos de factura recibidos:",e),!e.cliente||!e.cliente.id)throw new Error("Datos de cliente incompletos para crear factura");let a=[],t=0;e.resumen.albaranes&&e.resumen.albaranes.length>0&&e.resumen.albaranes.forEach(s=>{if(s.estado_cierre==="Finalizado"){let n=new Date(`2000-01-01T${s.hora_entrada}`),b=(new Date(`2000-01-01T${s.hora_salida}`).getTime()-n.getTime())/(1e3*60*60);t+=Math.max(0,b)}}),t>0&&a.push({tipo:"mano_obra",nombre:"Mano de obra t\xE9cnica",cantidad:Math.round(t*10)/10,precio_pvp:50,descripcion:`${Math.round(t*10)/10} horas de trabajo t\xE9cnico`});let r=new Map;e.resumen.albaranes&&e.resumen.albaranes.forEach(s=>{s.repuestos_utilizados&&s.repuestos_utilizados.length>0&&s.repuestos_utilizados.forEach(n=>{let d=r.get(n)||0;r.set(n,d+1)})}),r.forEach((s,n)=>{a.push({tipo:"repuesto",nombre:n,cantidad:s,precio_pvp:25,descripcion:`Repuesto utilizado: ${n}`})}),a.length===0&&a.push({tipo:"mano_obra",nombre:"Servicio t\xE9cnico b\xE1sico",cantidad:1,precio_pvp:50,descripcion:"Servicio t\xE9cnico realizado"}),console.log("\u{1F527} L\xEDneas de factura creadas:",a),console.log("\u{1F527} Horas totales calculadas:",t);let i=this.facturasService.calcularTotales(a);return console.log("\u{1F527} Totales calculados:",i),{numero_factura:"",fecha_emision:new Date().toISOString().split("T")[0],cliente_id:e.cliente.id,nombre_cliente:e.cliente.nombre_completo,direccion_cliente:e.cliente.direccion||"Sin direcci\xF3n",cif_cliente:"Sin CIF",email_cliente:e.cliente.email||"Sin email",aviso_id:e.avisoId,subtotal:i.subtotal,iva:i.iva,total:i.total,estado:"En curso",notas:`Factura generada desde ${((o=e.resumen.albaranes)==null?void 0:o.length)||0} albar\xE1n(es) con ${Math.round(t*10)/10}h de trabajo t\xE9cnico`,lineas:a}}};p.\u0275fac=function(a){return new(a||p)(h(x),h(M),h(y),h(O))},p.\u0275prov=_({token:p,factory:p.\u0275fac,providedIn:"root"});let f=p;return f})();export{O as a,Z as b};
