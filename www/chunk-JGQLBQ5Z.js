import{Bc as R,F as g,I as a,S as b,Wc as S,d as v,o as s,p,q as f}from"./chunk-GZDKEEK6.js";import{k as r}from"./chunk-CRC5ZNR6.js";var E=(()=>{let i=class i{constructor(e,n,o){this.platform=e,this.ngZone=n,this.supabaseService=o,this.appResumed$=new v(!1),this.subscriptions=[],this.isProcessingResume=!1,this.lastVisibilityState=document.visibilityState,this.lastActiveTime=Date.now(),this.isMobile=!1,this.connectionCheckTimer=null,console.log("\u{1F527} ReconnectionService: Inicializando..."),this.isMobile=this.platform.is("mobile")||this.platform.is("hybrid"),console.log("\u{1F527} ReconnectionService: Es m\xF3vil?",this.isMobile),this.initReconnectionListeners()}initReconnectionListeners(){console.log("\u{1F527} ReconnectionService: Configurando listeners...");let e=s(document,"visibilitychange"),n=s(window,"focus"),o=s(window,"blur"),h=s(window,"pageshow"),u=s(window,"pagehide"),m=f(e,n,o,h,u).subscribe(c=>{if(console.log("\u{1F527} ReconnectionService: Evento detectado:",c.type),c.type==="visibilitychange"){let d=document.visibilityState;console.log("\u{1F527} ReconnectionService: Estado de visibilidad:",this.lastVisibilityState,"->",d),this.lastVisibilityState==="hidden"&&d==="visible"&&(console.log("\u{1F527} ReconnectionService: Documento se volvi\xF3 visible"),this.handleAppResume()),this.lastVisibilityState=d}else c.type==="focus"?(console.log("\u{1F527} ReconnectionService: Ventana enfocada"),this.handleAppResume()):c.type==="pageshow"&&(console.log("\u{1F527} ReconnectionService: P\xE1gina mostrada"),this.handleAppResume())});this.subscriptions.push(m),this.platform.is("hybrid")&&(console.log("\u{1F527} ReconnectionService: Configurando listeners para app nativa"),document.addEventListener("resume",()=>{console.log("\u{1F527} ReconnectionService: App nativa resumida"),this.handleAppResume()})),this.isMobile&&(console.log("\u{1F527} ReconnectionService: Configurando detecci\xF3n espec\xEDfica para m\xF3viles"),this.setupMobileDetection()),console.log("\u{1F527} ReconnectionService: Listeners configurados correctamente")}setupMobileDetection(){["touchstart","touchend","mousedown","mousemove","keypress","scroll"].forEach(t=>{document.addEventListener(t,()=>{this.lastActiveTime=Date.now()},{passive:!0})});let o=p(1e3).subscribe(()=>{Date.now()-this.lastActiveTime>3e3&&document.visibilityState==="visible"&&(document.hasFocus()||window.navigator.onLine)&&(console.log("\u{1F527} ReconnectionService: M\xF3vil detectado como activo tras inactividad"),this.handleAppResume())});this.subscriptions.push(o),window.addEventListener("orientationchange",()=>{console.log("\u{1F527} ReconnectionService: Cambio de orientaci\xF3n detectado"),setTimeout(()=>{this.handleAppResume()},200)}),"onpagevisibilitychange"in document&&document.addEventListener("pagevisibilitychange",()=>{console.log("\u{1F527} ReconnectionService: Page visibility change (m\xF3vil)"),document.visibilityState==="visible"&&this.handleAppResume()}),"onfreeze"in document&&document.addEventListener("freeze",()=>{console.log("\u{1F527} ReconnectionService: App congelada (m\xF3vil)")}),"onresume"in document&&document.addEventListener("resume",()=>{console.log("\u{1F527} ReconnectionService: App resumida (m\xF3vil)"),this.handleAppResume()}),console.log("\u{1F527} ReconnectionService: Configurando verificaci\xF3n inteligente para m\xF3viles");let u=p(15e3).subscribe(()=>r(this,null,function*(){if(document.visibilityState==="visible"&&document.hasFocus()&&!this.isProcessingResume){console.log("\u{1F527} ReconnectionService: Verificaci\xF3n inteligente de conexi\xF3n (m\xF3vil)");try{(yield this.supabaseService.testConnection(3e3))||(console.log("\u{1F527} ReconnectionService: Conexi\xF3n perdida detectada en verificaci\xF3n inteligente"),this.handleAppResume())}catch(t){console.log("\u{1F527} ReconnectionService: Error en verificaci\xF3n inteligente:",t)}}}));this.subscriptions.push(u)}handleAppResume(){return r(this,null,function*(){if(this.isProcessingResume){console.log("\u{1F504} Ya se est\xE1 procesando una reconexi\xF3n, saltando...");return}try{this.isProcessingResume=!0,console.log("\u{1F504} App resumed - verificando conexiones..."),this.ngZone.run(()=>r(this,null,function*(){try{console.log("\u{1F504} Verificando conexi\xF3n Supabase (timeout r\xE1pido)..."),(yield this.supabaseService.testConnection(2e3))?(console.log("\u2705 Supabase connection OK"),this.appResumed$.next(!0)):(console.log("\u274C Supabase connection failed, intentando reconexi\xF3n r\xE1pida..."),yield this.attemptQuickReconnection())}catch(e){console.error("\u274C Error en verificaci\xF3n de conexi\xF3n:",e),yield this.attemptQuickReconnection()}}))}catch(e){console.error("\u274C Error en handleAppResume:",e),this.forceAppRefresh()}finally{this.isProcessingResume=!1}})}attemptQuickReconnection(){return r(this,null,function*(){try{console.log("\u{1F504} Intentando reconexi\xF3n r\xE1pida..."),this.supabaseService.getClient().removeAllChannels(),yield new Promise(o=>setTimeout(o,500)),(yield this.supabaseService.testConnection(1500))?(console.log("\u2705 Reconexi\xF3n r\xE1pida exitosa"),this.appResumed$.next(!0)):(console.log("\u274C Reconexi\xF3n r\xE1pida fall\xF3, forzando refresh"),this.forceAppRefresh())}catch(e){console.error("\u274C Error en reconexi\xF3n r\xE1pida:",e),this.forceAppRefresh()}})}forceAppRefresh(){console.log("\u{1F504} Forzando refresh de la app...");try{window.location.reload()}catch(e){console.error("\u274C Error forzando refresh:",e)}}get appResumed(){return this.appResumed$.asObservable()}get connectionStatus(){return this.supabaseService.getConnectionStatus()}cleanup(){this.subscriptions.forEach(e=>e.unsubscribe()),this.subscriptions=[],console.log("\u{1F527} ReconnectionService: Recursos limpiados")}};i.\u0275fac=function(n){return new(n||i)(a(R),a(b),a(S))},i.\u0275prov=g({token:i,factory:i.\u0275fac,providedIn:"root"});let l=i;return l})();export{E as a};
