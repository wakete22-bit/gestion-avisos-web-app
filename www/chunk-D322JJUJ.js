import{a as q}from"./chunk-VBMSTODI.js";import{a as y}from"./chunk-V7KIGSPH.js";import{a as x}from"./chunk-4SM7WR35.js";import{a as M}from"./chunk-5FXVTEKZ.js";import{a as D}from"./chunk-KH26CASC.js";import{D as w,G as _,Sc as E,d as T,f as p,k as b,n as C,r as v,x as d,z as S}from"./chunk-EYPZOMIL.js";import{a as F,b as P,d as $}from"./chunk-CRC5ZNR6.js";var k=(()=>{let m=class m{constructor(e,a){this.inventarioService=e,this.supabaseClientService=a,this.materialesSubject=new T([]),this.materiales$=this.materialesSubject.asObservable(),this.supabase=this.supabaseClientService.getClient()}getMaterialesTrabajo(e){return p(this.supabase.from("materiales_trabajo").select(`
          *,
          material:inventario(*)
        `).eq("trabajo_id",e).order("id",{ascending:!0})).pipe(b(({data:a,error:t})=>{if(t)throw t;let o=a;return this.materialesSubject.next(o),o}),v(a=>{throw console.error("Error al obtener materiales del trabajo:",a),a}))}agregarMateriales(e,a){if(a.length===0)return p([[]]);let t=a.map(o=>({trabajo_id:e,material_id:o.material_id,cantidad_utilizada:o.cantidad_utilizada,precio_neto_al_momento:o.precio_neto_al_momento}));return p(this.supabase.from("materiales_trabajo").insert(t).select(`
          *,
          material:inventario(*)
        `)).pipe(d(({data:o,error:i})=>{if(i)throw i;let s=o,n=this.materialesSubject.value;this.materialesSubject.next([...n,...s]);let c=s.map(r=>{let l=r.material.cantidad_disponible-r.cantidad_utilizada;return this.inventarioService.actualizarStock(r.material_id,l)});return C(c).pipe(b(()=>s))}),v(o=>{throw console.error("Error al agregar materiales al trabajo:",o),o}))}actualizarMaterial(e,a){return p(this.supabase.from("materiales_trabajo").select(`
          *,
          material:inventario(*)
        `).eq("id",e).single()).pipe(d(({data:t,error:o})=>{if(o)throw o;let i=t,s=i.cantidad_utilizada,c=(a.cantidad_utilizada||s)-s,r={cantidad_utilizada:a.cantidad_utilizada,precio_neto_al_momento:a.precio_neto_al_momento};return p(this.supabase.from("materiales_trabajo").update(r).eq("id",e).select(`
              *,
              material:inventario(*)
            `).single()).pipe(d(({data:l,error:u})=>{if(u)throw u;let h=l,j=this.materialesSubject.value,f=j.findIndex(z=>z.id===e);if(f!==-1&&(j[f]=h,this.materialesSubject.next([...j])),c!==0){let z=i.material.cantidad_disponible-c;return this.inventarioService.actualizarStock(i.material_id,z).pipe(b(()=>h))}return p([h])}))}),v(t=>{throw console.error("Error al actualizar material:",t),t}))}eliminarMaterial(e){return p(this.supabase.from("materiales_trabajo").select(`
          *,
          material:inventario(*)
        `).eq("id",e).single()).pipe(d(({data:a,error:t})=>{if(t)throw t;let o=a;return p(this.supabase.from("materiales_trabajo").delete().eq("id",e)).pipe(d(({error:i})=>{if(i)throw i;let n=this.materialesSubject.value.filter(r=>r.id!==e);this.materialesSubject.next(n);let c=o.material.cantidad_disponible+o.cantidad_utilizada;return this.inventarioService.actualizarStock(o.material_id,c).pipe(b(()=>{}))}))}),v(a=>{throw console.error("Error al eliminar material:",a),a}))}eliminarMaterialesTrabajo(e){return p(this.supabase.from("materiales_trabajo").select(`
          *,
          material:inventario(*)
        `).eq("trabajo_id",e)).pipe(d(({data:a,error:t})=>{if(t)throw t;let o=a;return p(this.supabase.from("materiales_trabajo").delete().eq("trabajo_id",e)).pipe(d(({error:i})=>{if(i)throw i;let n=this.materialesSubject.value.filter(c=>c.trabajo_id!==e);if(this.materialesSubject.next(n),o.length>0){let c=o.map(r=>{let l=r.material.cantidad_disponible+r.cantidad_utilizada;return this.inventarioService.actualizarStock(r.material_id,l)});return C(c).pipe(b(()=>{}))}return p([void 0])}))}),v(a=>{throw console.error("Error al eliminar materiales del trabajo:",a),a}))}calcularCostoMateriales(e){return e.reduce((a,t)=>a+t.cantidad_utilizada*t.precio_neto_al_momento,0)}getMaterialesActuales(){return this.materialesSubject.value}limpiarMateriales(){this.materialesSubject.next([])}};m.\u0275fac=function(a){return new(a||m)(_(q),_(E))},m.\u0275prov=w({token:m,factory:m.\u0275fac,providedIn:"root"});let g=m;return g})();var L=(()=>{let m=class m{constructor(e,a,t){this.materialesTrabajoService=e,this.supabaseClientService=a,this.dataUpdateService=t,this.trabajosSubject=new T([]),this.trabajos$=this.trabajosSubject.asObservable(),this.supabase=this.supabaseClientService.getClient()}getTrabajosAviso(e){return console.log("\u{1F50D} TrabajosService.getTrabajosAviso() ejecut\xE1ndose para aviso:",e),p(this.supabase.from("trabajos_realizados").select(`
            *,
            materiales:materiales_trabajo(
              id,
              cantidad_utilizada,
              precio_neto_al_momento,
              material:inventario(
                id,
                nombre,
                unidad,
                precio_neto,
                pvp,
                codigo
              )
            )
          `).eq("aviso_id",e).order("fecha_creacion",{ascending:!1})).pipe(b(a=>{var t;if(console.log("\u{1F50D} Respuesta de Supabase para trabajos:",a),a.error)throw a.error;return console.log("\u2705 Trabajos obtenidos exitosamente:",((t=a.data)==null?void 0:t.length)||0,"trabajos"),{trabajos:a.data||[]}}))}getTrabajo(e){return p(this.supabase.from("trabajos_realizados").select("*").eq("id",e).single()).pipe(d(({data:a,error:t})=>{if(t)throw t;let o=a;return this.materialesTrabajoService.getMaterialesTrabajo(e).pipe(b(i=>({trabajo:o,materiales:i})))}),v(a=>{throw console.error("Error al obtener trabajo:",a),a}))}crearTrabajo(e){let i=e,{materiales:a}=i,t=$(i,["materiales"]),o=P(F({},t),{fecha_creacion:new Date().toISOString(),fecha_actualizacion:new Date().toISOString()});return p(this.supabase.from("trabajos_realizados").insert([o]).select().single()).pipe(d(({data:s,error:n})=>{if(n)throw n;let c=s,r=this.trabajosSubject.value;return this.trabajosSubject.next([c,...r]),this.dataUpdateService.notifyCreated("trabajos"),!a||a.length===0?p([{trabajo:c,materiales:[]}]):this.materialesTrabajoService.agregarMateriales(c.id,a).pipe(b(l=>({trabajo:c,materiales:l})))}),v(s=>{throw console.error("Error al crear trabajo:",s),s}))}actualizarTrabajo(e,a){let s=a,{materiales:t}=s,o=$(s,["materiales"]),i=P(F({},o),{fecha_actualizacion:new Date().toISOString()});return p(this.supabase.from("trabajos_realizados").update(i).eq("id",e).select().single()).pipe(d(({data:n,error:c})=>{if(c)throw c;let r=n,l=this.trabajosSubject.value,u=l.findIndex(h=>h.id===e);return u!==-1&&(l[u]=r,this.trabajosSubject.next([...l])),this.dataUpdateService.notifyUpdated("trabajos"),t?this.materialesTrabajoService.eliminarMaterialesTrabajo(e).pipe(d(()=>t.length===0?p([{trabajo:r,materiales:[]}]):this.materialesTrabajoService.agregarMateriales(e,t).pipe(b(h=>({trabajo:r,materiales:h}))))):this.getTrabajo(e)}),v(n=>{throw console.error("Error al actualizar trabajo:",n),n}))}eliminarTrabajo(e){return this.materialesTrabajoService.eliminarMaterialesTrabajo(e).pipe(d(()=>p(this.supabase.from("trabajos_realizados").delete().eq("id",e))),b(({error:a})=>{if(a)throw a;let o=this.trabajosSubject.value.filter(i=>i.id!==e);this.trabajosSubject.next(o),this.dataUpdateService.notifyDeleted("trabajos")}),v(a=>{throw console.error("Error al eliminar trabajo:",a),a}))}getEstadisticasTrabajos(e){return p(this.supabase.from("trabajos_realizados").select("*").eq("aviso_id",e)).pipe(b(({data:a,error:t})=>{if(t)throw t;let o=a;return{totalTrabajos:o.length,trabajosCompletados:o.filter(s=>s.estado==="Completado").length,trabajosPendientes:o.filter(s=>s.estado==="Pendiente").length,trabajosEnCurso:o.filter(s=>s.estado==="En curso").length,trabajosCancelados:o.filter(s=>s.estado==="Cancelado").length,totalHoras:o.reduce((s,n)=>{let c=new Date(`2000-01-01T${n.hora_inicio}`),l=(new Date(`2000-01-01T${n.hora_fin}`).getTime()-c.getTime())/(1e3*60*60);return s+Math.max(0,l)},0)}}))}getTrabajosActuales(){return this.trabajosSubject.value}limpiarTrabajos(){this.trabajosSubject.next([]),this.materialesTrabajoService.limpiarMateriales()}actualizarEstadoTrabajo(e,a,t){let o={estado:a,fecha_actualizacion:new Date().toISOString()};return t&&(o.albaran_id=t),p(this.supabase.from("trabajos_realizados").update(o).eq("id",e).select().single()).pipe(b(({data:i,error:s})=>{if(s)throw s;let n=i,c=this.trabajosSubject.value,r=c.findIndex(l=>l.id===e);return r!==-1&&(c[r]=n,this.trabajosSubject.next([...c])),this.dataUpdateService.notifyUpdated("trabajos"),n}),v(i=>{throw console.error("Error al actualizar estado del trabajo:",i),i}))}};m.\u0275fac=function(a){return new(a||m)(_(k),_(E),_(D))},m.\u0275prov=w({token:m,factory:m.\u0275fac,providedIn:"root"});let g=m;return g})();var aa=(()=>{let m=class m{constructor(e,a,t,o){this.avisosService=e,this.facturasService=a,this.presupuestosService=t,this.trabajosService=o}obtenerEstadoFlujo(e){return this.avisosService.getResumenCompletoAviso(e).pipe(b(a=>({avisoId:e,estadoActual:a.estado,puedeCrearPresupuesto:this.puedeCrearPresupuesto(a),puedeAprobarPresupuesto:this.puedeAprobarPresupuesto(a),puedeFacturarPresupuesto:this.puedeFacturarPresupuesto(a),puedeFacturarTrabajos:this.puedeFacturarTrabajos(a),puedeCompletarAviso:this.puedeCompletarAviso(a),resumen:a})))}ejecutarFlujoCompleto(e,a=!0){return a?this.flujoConPresupuesto(e):this.flujoDirectoSinPresupuesto(e)}flujoDirectoSinPresupuesto(e){return this.avisosService.actualizarAviso(e,{estado:"En curso",requiere_presupuesto:!1}).pipe(S(()=>console.log("\u2705 Aviso actualizado para trabajo directo")),d(()=>this.avisosService.getResumenCompletoAviso(e)),b(a=>({paso:"flujo_directo_iniciado",avisoId:e,mensaje:"Flujo directo iniciado. El t\xE9cnico puede comenzar a trabajar.",resumen:a})))}flujoConPresupuesto(e){return this.avisosService.actualizarAviso(e,{estado:"Pendiente de presupuesto",requiere_presupuesto:!0}).pipe(S(()=>console.log("\u2705 Aviso marcado como requiere presupuesto")),d(()=>this.presupuestosService.crearPresupuesto({aviso_id:e,horas_estimadas:2,total_estimado:0})),S(()=>console.log("\u2705 Presupuesto creado")),b(a=>({paso:"presupuesto_creado",avisoId:e,presupuestoId:a.id,mensaje:"Presupuesto creado. Pendiente de evaluaci\xF3n y aprobaci\xF3n.",presupuesto:a})))}aprobarPresupuesto(e){return this.presupuestosService.cambiarEstado(e,"Completado").pipe(d(a=>this.avisosService.actualizarAviso(a.aviso_id,{estado:"En curso"})),S(()=>console.log("\u2705 Presupuesto aprobado y aviso en curso")),b(a=>({paso:"presupuesto_aprobado",avisoId:a.id,mensaje:"Presupuesto aprobado. El t\xE9cnico puede comenzar a trabajar.",aviso:a})))}facturarPresupuesto(e){return this.facturasService.crearFacturaDesdePresupuesto(e).pipe(S(()=>console.log("\u2705 Factura creada desde presupuesto")),d(a=>this.avisosService.actualizarEstadoAutomatico(a.factura.aviso_id).pipe(b(()=>a))),b(a=>({paso:"factura_desde_presupuesto",avisoId:a.factura.aviso_id,facturaId:a.factura.id,mensaje:"Factura generada autom\xE1ticamente desde presupuesto aprobado.",factura:a})))}facturarTrabajos(e){return console.log("\u{1F527} Iniciando facturaci\xF3n de trabajos para aviso:",e),this.avisosService.getResumenCompletoAviso(e).pipe(d(a=>{var i;if(console.log("\u{1F527} Resumen completo obtenido:",a),!a.estadisticas.trabajosFinalizados)throw new Error("No hay trabajos finalizados para facturar. Debes crear un albar\xE1n primero.");let t=((i=a.trabajos)==null?void 0:i.filter(s=>{var n;return!s.albaran_id||!((n=s.albaran)!=null&&n.estado_cierre)||s.albaran.estado_cierre==="Otra visita"}))||[];if(t.length>0){let s=t.map(n=>{var c;return`Trabajo #${(c=n.id)==null?void 0:c.substring(0,8)} (${n.descripcion})`}).join(", ");throw new Error(`No se puede facturar. Los siguientes trabajos no tienen albaranes cerrados: ${s}. Debes cerrar todos los albaranes antes de facturar.`)}console.log("\u{1F527} Cliente del resumen:",a.cliente);let o=this.convertirDatosAFactura({avisoId:e,cliente:a.cliente,resumen:a});return this.facturasService.getSiguienteNumero().pipe(d(s=>(o.numero_factura=s,console.log("\u{1F527} N\xFAmero de factura generado:",s),this.facturasService.crearFactura(o))))}),S(()=>console.log("\u2705 Factura creada desde trabajos realizados")),d(()=>this.avisosService.getResumenCompletoAviso(e)),b(a=>({paso:"factura_creada_desde_trabajos",avisoId:e,mensaje:"Factura creada exitosamente desde trabajos realizados",resumen:a})))}verificarEstadoFactura(e,a){return this.avisosService.getResumenCompletoAviso(a).pipe(d(t=>t.estado==="Completado"?this.facturasService.cambiarEstado(e,"Completado"):t.estado==="Listo para facturar"?this.facturasService.cambiarEstado(e,"En curso"):p([{id:e,estado:"Pendiente"}])))}sincronizarEstadosFacturas(e){return this.avisosService.getResumenCompletoAviso(e).pipe(d(a=>{if(!a.facturas||a.facturas.length===0)return p([{mensaje:"No hay facturas para sincronizar"}]);let t;a.estado==="Completado"?t="Completado":a.estado==="Listo para facturar"?t="En curso":t="Pendiente";let o=a.facturas.map(i=>this.facturasService.cambiarEstado(i.id,t));return C(o).pipe(b(()=>({mensaje:`Estados de ${a.facturas.length} factura(s) sincronizados a "${t}"`,avisoId:e,nuevoEstado:t})))}))}completarAviso(e){return this.avisosService.getResumenCompletoAviso(e).pipe(d(a=>{var o;if(!this.puedeCompletarAviso(a))throw new Error("No se puede completar el aviso. Verifica que haya trabajos finalizados y facturas generadas.");let t=((o=a.trabajos)==null?void 0:o.filter(i=>{var s;return!i.albaran_id||!((s=i.albaran)!=null&&s.estado_cierre)}))||[];if(t.length>0){let i=t.map(s=>{var n;return`Trabajo #${(n=s.id)==null?void 0:n.substring(0,8)} (${s.descripcion})`}).join(", ");throw new Error(`No se puede completar el aviso. Los siguientes trabajos no tienen albaranes cerrados: ${i}. Debes cerrar todos los albaranes antes de completar el aviso.`)}return this.avisosService.actualizarAviso(e,{estado:"Completado",fecha_finalizacion:new Date}).pipe(d(i=>{if(a.facturas&&a.facturas.length>0){let s=a.facturas.map(n=>this.facturasService.cambiarEstado(n.id,"Completado"));return C(s).pipe(b(()=>i))}return p([i])}))}),S(()=>console.log("\u2705 Aviso completado exitosamente")),d(()=>this.avisosService.getResumenCompletoAviso(e)),b(a=>({paso:"aviso_completado",avisoId:e,mensaje:"Aviso marcado como completado",resumen:a})))}obtenerAccionesDisponibles(e){return this.obtenerEstadoFlujo(e).pipe(b(a=>{let t=[];return a.puedeFacturarTrabajos&&t.push("facturar_trabajos"),a.puedeCompletarAviso&&t.push("completar_aviso"),t}))}puedeCrearPresupuesto(e){return!1}puedeAprobarPresupuesto(e){return!1}puedeFacturarPresupuesto(e){return!1}puedeFacturarTrabajos(e){var t;let a=((t=e.trabajos)==null?void 0:t.every(o=>{var i;return o.albaran_id&&((i=o.albaran)==null?void 0:i.estado_cierre)}))||!1;return e.estadisticas.trabajosFinalizados>0&&e.estadisticas.facturasPendientes===0&&a}puedeCompletarAviso(e){var t;let a=((t=e.trabajos)==null?void 0:t.every(o=>{var i;return o.albaran_id&&((i=o.albaran)==null?void 0:i.estado_cierre)}))||!1;return e.estadisticas.trabajosFinalizados>0&&e.estadisticas.totalFacturas>0&&a}convertirDatosAFactura(e){var c;if(console.log("\u{1F527} Datos de factura recibidos:",e),!e.cliente||!e.cliente.id)throw new Error("Datos de cliente incompletos para crear factura");let a=[],t=0;e.resumen.trabajos&&e.resumen.trabajos.length>0&&(console.log("\u{1F527} Calculando horas totales de todos los trabajos:",e.resumen.trabajos.length,"trabajos"),e.resumen.trabajos.forEach((r,l)=>{if(r.hora_inicio&&r.hora_fin){let u=new Date(`2000-01-01T${r.hora_inicio}`),j=(new Date(`2000-01-01T${r.hora_fin}`).getTime()-u.getTime())/(1e3*60*60),f=Math.max(0,j);console.log(`\u{1F527} Trabajo #${l+1}: ${r.hora_inicio} - ${r.hora_fin} = ${f.toFixed(2)} horas`),t+=f}}),console.log("\u{1F527} Horas totales acumuladas:",t.toFixed(2),"horas")),t>0&&a.push({tipo:"mano_obra",nombre:"Mano de obra",cantidad:t,precio_neto:50,precio_pvp:50,descripcion:`Trabajo realizado: ${t.toFixed(2)} horas (${((c=e.resumen.trabajos)==null?void 0:c.length)||0} trabajos)`});let o=new Map;e.resumen.trabajos&&e.resumen.trabajos.length>0&&(console.log("\u{1F527} Consolidando repuestos de todos los trabajos..."),e.resumen.trabajos.forEach((r,l)=>{console.log(`\u{1F527} Procesando trabajo #${l+1}:`,r.id),r.materiales&&r.materiales.length>0&&r.materiales.forEach(u=>{var h,j;if(u&&u.cantidad_utilizada&&u.cantidad_utilizada>0){let f=((h=u.material)==null?void 0:h.nombre)||"Material sin nombre",z=f.toLowerCase();if(o.has(z)){let A=o.get(z);A.cantidad_total+=parseFloat(u.cantidad_utilizada),A.precio_total+=parseFloat(u.precio_neto_al_momento||0)*parseFloat(u.cantidad_utilizada),A.trabajos.push(l+1),console.log(`\u{1F527} Material consolidado: ${f} - Cantidad total: ${A.cantidad_total}`)}else o.set(z,{nombre:f,cantidad_total:parseFloat(u.cantidad_utilizada),precio_unitario:parseFloat(u.precio_neto_al_momento||0),precio_total:parseFloat(u.precio_neto_al_momento||0)*parseFloat(u.cantidad_utilizada),unidad:((j=u.material)==null?void 0:j.unidad)||"unidad",trabajos:[l+1]}),console.log(`\u{1F527} Nuevo material: ${f} - Cantidad: ${u.cantidad_utilizada}`)}}),r.repuestos&&r.repuestos.length>0&&r.repuestos.forEach(u=>{if(u){let h=typeof u=="string"?u:u.nombre||"Repuesto sin nombre",j=h.toLowerCase();if(o.has(j)){let f=o.get(j);f.cantidad_total+=1,f.trabajos.push(l+1),console.log(`\u{1F527} Repuesto consolidado: ${h} - Cantidad total: ${f.cantidad_total}`)}else o.set(j,{nombre:h,cantidad_total:1,precio_unitario:0,precio_total:0,unidad:"unidad",trabajos:[l+1]}),console.log(`\u{1F527} Nuevo repuesto: ${h}`)}})})),o.forEach((r,l)=>{a.push({tipo:"repuesto",nombre:r.nombre,cantidad:r.cantidad_total,precio_neto:r.precio_unitario,precio_pvp:r.precio_unitario>0?r.precio_unitario:0,descripcion:`${r.nombre} - ${r.cantidad_total} ${r.unidad} (usado en trabajos: ${r.trabajos.join(", ")})`})});let i=a.reduce((r,l)=>{let u=(l.precio_pvp||0)*(l.cantidad||0);return r+u},0),s=+(i*.21).toFixed(2),n=+(i+s).toFixed(2);return console.log("\u{1F527} L\xEDneas de factura consolidadas:",a.length,"l\xEDneas"),console.log("\u{1F527} Subtotal consolidado:",i.toFixed(2),"\u20AC"),console.log("\u{1F527} IVA:",s.toFixed(2),"\u20AC"),console.log("\u{1F527} Total consolidado:",n.toFixed(2),"\u20AC"),a.forEach((r,l)=>{console.log(`\u{1F527} L\xEDnea ${l+1}:`,{tipo:r.tipo,nombre:r.nombre,cantidad:r.cantidad,precio_neto:r.precio_neto,precio_pvp:r.precio_pvp,descripcion:r.descripcion})}),{cliente_id:e.cliente.id,nombre_cliente:e.cliente.nombre_completo,direccion_cliente:e.cliente.direccion||"",cif_cliente:e.cliente.cif||"",email_cliente:e.cliente.email||"",aviso_id:e.avisoId,fecha_emision:new Date().toISOString().split("T")[0],estado:"Pendiente",subtotal:i,iva:s,total:n,lineas:a}}};m.\u0275fac=function(a){return new(a||m)(_(x),_(M),_(y),_(L))},m.\u0275prov=w({token:m,factory:m.\u0275fac,providedIn:"root"});let g=m;return g})();export{L as a,aa as b};
