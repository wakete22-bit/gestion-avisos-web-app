import{a as U}from"./chunk-7FW4253V.js";import{a as v,b as H}from"./chunk-ZFUZ5UD4.js";import{E as R,H as y,d as O,f as d,j as f,m as q,r as m,y as w}from"./chunk-QQQKELKR.js";import{a as D,b as j,k as F}from"./chunk-CRC5ZNR6.js";var G=(()=>{let T=class T{constructor(o,e){this.supabaseClientService=o,this.cacheService=e,this.avisosSubject=new O([]),this.avisos$=this.avisosSubject.asObservable()}getSupabaseClient(){return console.log("\u{1F50D} AvisosService: Obteniendo cliente Supabase actualizado..."),this.supabaseClientService.getClient()}debugConnection(){return console.log("\u{1F50D} AvisosService: Probando conexi\xF3n b\xE1sica..."),d(this.getSupabaseClient().from("avisos").select("id").limit(1)).pipe(f(({data:o,error:e})=>{if(e)throw console.error("\u274C AvisosService: Error en conexi\xF3n:",e),e;return console.log("\u2705 AvisosService: Conexi\xF3n exitosa, datos:",o),{success:!0,data:o}}),m(o=>(console.error("\u274C AvisosService: Error cr\xEDtico:",o),d(Promise.resolve({success:!1,error:o})))))}getAvisos(o=1,e=15,t,a,r,s,n=!1){let i=this.getSupabaseClient().from("avisos").select(`
                id,
                numero_secuencial,
                cliente_id,
                tecnico_asignado_id,
                fecha_creacion,
                nombre_cliente_aviso,
                direccion_cliente_aviso,
                telefono_cliente_aviso,
                nombre_contacto,
                tipo,
                descripcion_problema,
                estado,
                urgencia,
                es_urgente,
                latitud,
                longitud,
                cliente:clientes!inner(id, nombre_completo, direccion, telefono_contacto),
                tecnico_asignado:usuarios(id, nombre_completo, email)
            `,{count:"exact"});t&&(i=i.or(`nombre_cliente_aviso.ilike.%${t}%,descripcion_problema.ilike.%${t}%`)),s?i=i.eq("estado",s):n||(i=i.neq("estado","Completado"));let c=(o-1)*e;return i=i.range(c,c+e-1).order(a||"numero_secuencial",{ascending:r==="asc"}),d(i).pipe(f(({data:u,error:p,count:h})=>{if(p)throw p;let l=u;return this.avisosSubject.next(l),{avisos:l,total:h||0,pagina:o,por_pagina:e}}),m(u=>{throw console.error("Error al obtener avisos:",u),u}))}getAvisosDirect(o=1,e=15,t,a,r,s,n=!1){return console.log("\u{1F680} AvisosService: Usando FETCH DIRECTO para avisos..."),d(this.fetchAvisosDirect(o,e,t,a,r,s,n)).pipe(f(i=>(console.log("\u2705 AvisosService: FETCH DIRECTO completado, avisos:",i.avisos.length),this.avisosSubject.next(i.avisos),i)),m(i=>{throw console.error("\u274C AvisosService: Error en FETCH DIRECTO:",i),i}))}fetchAvisosDirect(o=1,e=15,t,a,r,s,n=!1){return F(this,null,function*(){console.log("\u{1F680} AvisosService: Ejecutando fetch directo para avisos...");try{let i=`${v.supabaseUrl}/rest/v1/avisos?select=*,cliente:clientes(*)`,c=[];t&&c.push(`or=(nombre_cliente_aviso.ilike.*${t}*,descripcion_problema.ilike.*${t}*)`),s?c.push(`estado=eq.${s}`):n||(c.push("or=(estado.eq.Pendiente,estado.eq.En%20curso,estado.eq.Pendiente%20de%20presupuesto,estado.eq.Listo%20para%20facturar)"),console.log("\u{1F50D} Filtro aplicado: Mostrando avisos activos (excluyendo Completado)")),c.length>0&&(i+="&"+c.join("&"));let u=(o-1)*e,p=u+e-1;i+=`&limit=${e}&offset=${u}`,i+=`&order=${a||"fecha_creacion"}.${r==="asc"?"asc":"desc"}`;let h={apikey:v.supabaseServiceKey,Authorization:`Bearer ${v.supabaseServiceKey}`,"Content-Type":"application/json",Prefer:"count=exact"};console.log("\u{1F680} URL construida:",i),console.log("\u{1F680} Headers:",h);let l=Date.now(),g=yield fetch(i,{method:"GET",headers:h}),C=Date.now()-l;if(console.log("\u{1F680} Fetch completado en",C,"ms"),console.log("\u{1F680} Status:",g.status),console.log("\u{1F680} Response headers:",g.headers),!g.ok){let $=yield g.text();throw console.error("\u{1F680} Error response body:",$),new Error(`HTTP ${g.status}: ${g.statusText}`)}let b=yield g.json(),A=g.headers.get("content-range"),E=A?parseInt(A.split("/")[1]):b.length;return console.log("\u{1F680} Datos recibidos:",(b==null?void 0:b.length)||0,"avisos, total:",E),console.log("\u{1F680} Primer aviso (si existe):",b[0]),{avisos:b,total:E,pagina:o,por_pagina:e}}catch(i){throw console.error("\u{1F680} Error en fetch directo:",i),i}})}getAviso(o){return d(this.getSupabaseClient().from("avisos").select(`
                    *,
                    cliente:clientes!inner(*),
                    tecnico_asignado:usuarios(*),
                    fotos:fotos_aviso(id, url, descripcion, fecha_subida)
                `).eq("id",o).single()).pipe(f(({data:e,error:t})=>{if(t)throw t;return e}),m(e=>{throw console.error("Error al obtener aviso:",e),e}))}crearAviso(o){let e=j(D({},o),{urgencia:o.es_urgente?"Alta":"Normal",fecha_creacion:new Date().toISOString(),estado:"Pendiente",requiere_presupuesto:!1,requiere_nueva_visita:!1});return d(this.getSupabaseClient().from("avisos").insert([e]).select(`
          *,
          cliente:clientes(*),
          tecnico_asignado:usuarios(*),
          fotos:fotos_aviso(*)
        `).single()).pipe(f(({data:t,error:a})=>{if(a)throw a;let r=t,s=this.avisosSubject.value;return this.avisosSubject.next([r,...s]),this.cacheService.clearCache("avisos"),r}))}actualizarAvisoDirect(o,e){return console.log("\u{1F680} AvisosService: Usando FETCH DIRECTO para actualizar aviso..."),d(this.fetchActualizarAvisoDirect(o,e)).pipe(f(t=>(console.log("\u2705 AvisosService: FETCH DIRECTO completado, aviso actualizado:",t.id),t)),m(t=>{throw console.error("\u274C AvisosService: Error en FETCH DIRECTO:",t),t}))}fetchActualizarAvisoDirect(o,e){return F(this,null,function*(){console.log("\u{1F680} AvisosService: Ejecutando fetch directo para actualizar aviso:",o);try{let t=j(D({},e),{fecha_actualizacion:new Date().toISOString()}),a=`${v.supabaseUrl}/rest/v1/avisos?id=eq.${o}`,r={apikey:v.supabaseServiceKey,Authorization:`Bearer ${v.supabaseServiceKey}`,"Content-Type":"application/json",Prefer:"return=representation"};console.log("\u{1F680} URL construida:",a),console.log("\u{1F680} Datos a actualizar:",t);let s=Date.now(),n=yield fetch(a,{method:"PATCH",headers:r,body:JSON.stringify(t)}),i=Date.now()-s;if(console.log("\u{1F680} Fetch completado en",i,"ms"),console.log("\u{1F680} Status:",n.status),!n.ok){let l=yield n.text();throw console.error("\u{1F680} Error response body:",l),new Error(`HTTP ${n.status}: ${n.statusText}`)}let c=yield n.json();if(console.log("\u{1F680} Datos recibidos:",(c==null?void 0:c.length)||0,"avisos"),!c||c.length===0)throw new Error("Aviso no encontrado");let u=c[0];console.log("\u{1F680} Aviso actualizado:",u);let p=this.avisosSubject.value,h=p.findIndex(l=>l.id===o);return h!==-1&&(p[h]=u,this.avisosSubject.next([...p])),this.cacheService.clearCache("avisos"),u}catch(t){throw console.error("\u{1F680} Error en fetch directo:",t),t}})}actualizarAviso(o,e){let t=j(D({},e),{fecha_actualizacion:new Date().toISOString()});return d(this.getSupabaseClient().from("avisos").update(t).eq("id",o).select(`
          *,
          cliente:clientes(*),
          tecnico_asignado:usuarios(*),
          fotos:fotos_aviso(*)
        `).single()).pipe(f(({data:a,error:r})=>{if(r)throw r;let s=a,n=this.avisosSubject.value,i=n.findIndex(c=>c.id===o);return i!==-1&&(n[i]=s,this.avisosSubject.next([...n])),this.cacheService.clearCache("avisos"),s}))}verificarDependenciasAviso(o){return console.log("\u{1F50D} Verificando dependencias para aviso:",o),d(Promise.all([this.getSupabaseClient().from("presupuestos").select("id").eq("aviso_id",o),this.getSupabaseClient().from("facturas").select("id").eq("aviso_id",o),this.getSupabaseClient().from("albaranes").select("id").eq("aviso_id",o),this.getSupabaseClient().from("historial_flujo").select("id").eq("aviso_id",o)])).pipe(f(([e,t,a,r])=>{var c,u,p,h,l;console.log("\u{1F4CA} Resultados de verificaci\xF3n:",{presupuestos:((c=e.data)==null?void 0:c.length)||0,facturas:((u=t.data)==null?void 0:u.length)||0,albaranes:((p=a.data)==null?void 0:p.length)||0,historialFlujo:((h=r.data)==null?void 0:h.length)||0,errores:{presupuestos:e.error,facturas:t.error,albaranes:a.error,historialFlujo:r.error}});let s=[];!e.error&&e.data&&e.data.length>0&&s.push(`${e.data.length} presupuesto(s)`),!t.error&&t.data&&t.data.length>0&&s.push(`${t.data.length} factura(s)`),!a.error&&a.data&&a.data.length>0&&s.push(`${a.data.length} albar\xE1n(es)`),!r.error&&r.data&&r.data.length>0&&console.log(`\u2139\uFE0F Historial encontrado: ${r.data.length} registro(s) (se eliminar\xE1n autom\xE1ticamente por CASCADE)`);let n=e.error||t.error||a.error,i=s.length===0||n&&s.length===0;return console.log("\u2705 Resultado de verificaci\xF3n:",{puedeEliminar:i,dependencias:s,historialFlujo:((l=r.data)==null?void 0:l.length)||0,historialSeEliminaAutomaticamente:!0,tieneErroresPermisos:n}),{puedeEliminar:i!=null?i:!1,dependencias:s}}))}eliminarAviso(o){return console.log("\u{1F5D1}\uFE0F Iniciando eliminaci\xF3n de aviso:",o),this.eliminarAvisoConDependencias(o)}eliminarAvisoConDependencias(o){console.log("\u{1F504} Eliminando dependencias del aviso:",o);let e=[d(this.getSupabaseClient().from("historial_flujo").delete().eq("aviso_id",o)),d(this.getSupabaseClient().from("albaranes").delete().eq("aviso_id",o)),d(this.getSupabaseClient().from("presupuestos").delete().eq("aviso_id",o)),d(this.getSupabaseClient().from("facturas").delete().eq("aviso_id",o)),this.eliminarFotosAviso(o)];return q(e).pipe(w(()=>(console.log("\u2705 Dependencias eliminadas, eliminando aviso..."),d(this.getSupabaseClient().from("avisos").delete().eq("id",o)))),f(({error:t})=>{if(t)throw console.error("\u274C Error al eliminar aviso despu\xE9s de limpiar dependencias:",t),t;console.log("\u2705 Aviso eliminado exitosamente"),this.actualizarEstadoLocal(o)}),m(t=>{throw console.error("\u274C Error en eliminaci\xF3n en cascada:",t),t}))}actualizarEstadoLocal(o){let t=this.avisosSubject.value.filter(a=>a.id!==o);this.avisosSubject.next(t),this.cacheService.clearCache("avisos")}eliminarFotosAviso(o){return d(this.getSupabaseClient().from("fotos_aviso").select("*").eq("aviso_id",o)).pipe(w(({data:e,error:t})=>{if(t)throw t;let a=e;if(a.length===0)return d(this.getSupabaseClient().from("fotos_aviso").delete().eq("aviso_id",o)).pipe(f(({error:s})=>{if(s)throw s}));let r=a.map(s=>{let n=s.url.split("/"),i=n[n.length-1];return`${o}/${i}`});return d(this.getSupabaseClient().storage.from("fotos-avisos").remove(r)).pipe(w(({error:s})=>(s&&console.warn("Error al eliminar archivos del storage:",s),d(this.getSupabaseClient().from("fotos_aviso").delete().eq("aviso_id",o)))),f(({error:s})=>{if(s)throw s}))}),m(e=>{throw console.error("Error al eliminar fotos del aviso:",e),e}))}subirFoto(o,e,t){let a=this.sanitizeFileName(e.name),r=`${o}/${Date.now()}_${a}`;return d(this.getSupabaseClient().storage.from("fotos-avisos").upload(r,e)).pipe(f(({data:s,error:n})=>{if(n)throw console.error("Error al subir archivo a storage:",n),n.message==="Bucket not found"?new Error("El bucket de storage no est\xE1 configurado. Contacta al administrador."):n;let{data:i}=this.getSupabaseClient().storage.from("fotos-avisos").getPublicUrl(r);return i.publicUrl}),w(s=>d(this.getSupabaseClient().from("fotos_aviso").insert([{aviso_id:o,url:s,descripcion:t}]).select().single())),f(({data:s,error:n})=>{if(n)throw n;return s}),m(s=>{throw console.error("Error completo al subir foto:",s),s}))}eliminarFoto(o){return d(this.getSupabaseClient().from("fotos_aviso").select("*").eq("id",o).single()).pipe(w(({data:e,error:t})=>{if(t)throw t;let a=e,r=a.url.split("/"),s=r[r.length-1],i=`${a.aviso_id}/${s}`;return d(this.getSupabaseClient().storage.from("fotos-avisos").remove([i])).pipe(w(({error:c})=>(c&&console.warn("Error al eliminar archivo del storage:",c),d(this.getSupabaseClient().from("fotos_aviso").delete().eq("id",o)))),f(({error:c})=>{if(c)throw c}))}),m(e=>{throw console.error("Error al eliminar foto:",e),e}))}buscarAvisos(o){return d(this.getSupabaseClient().from("avisos").select(`
          *,
          cliente:clientes(*),
          tecnico_asignado:usuarios(*),
          fotos:fotos_aviso(*)
        `).or(`nombre_cliente_aviso.ilike.%${o}%,descripcion_problema.ilike.%${o}%`).neq("estado","Completado").limit(10)).pipe(f(({data:e,error:t})=>{if(t)throw t;return e}))}getAvisosActivos(o=1,e=10,t,a,r,s){return this.getAvisos(o,e,t,a,r,s,!1)}getAvisosCompletados(o=1,e=10,t,a,r){return this.getAvisos(o,e,t,a,r,"Completado",!0)}getAvisosActuales(){return this.avisosSubject.value}limpiarAvisos(){this.avisosSubject.next([])}subirFotoDirect(o,e,t){return console.log("\u{1F680} AvisosService: Usando FETCH DIRECTO para subir foto..."),d(this.fetchSubirFotoDirect(o,e,t)).pipe(f(a=>(console.log("\u2705 AvisosService: FETCH DIRECTO completado, foto subida:",a.id),a)),m(a=>{throw console.error("\u274C AvisosService: Error en FETCH DIRECTO:",a),a}))}fetchSubirFotoDirect(o,e,t){return F(this,null,function*(){console.log("\u{1F680} AvisosService: Ejecutando fetch directo para subir foto...");try{let a=this.sanitizeFileName(e.name),r=`${o}/${Date.now()}_${a}`,s=`${v.supabaseUrl}/storage/v1/object/fotos-avisos/${r}`,n={Authorization:`Bearer ${v.supabaseServiceKey}`,"Content-Type":e.type};console.log("\u{1F680} Subiendo archivo a:",s);let i=yield fetch(s,{method:"POST",headers:n,body:e});if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);let c=`${v.supabaseUrl}/storage/v1/object/public/fotos-avisos/${r}`,u=`${v.supabaseUrl}/rest/v1/fotos_aviso`,p={aviso_id:o,url:c,descripcion:t||null},h={apikey:v.supabaseServiceKey,Authorization:`Bearer ${v.supabaseServiceKey}`,"Content-Type":"application/json",Prefer:"return=representation"};console.log("\u{1F680} Creando registro de foto:",u);let l=yield fetch(u,{method:"POST",headers:h,body:JSON.stringify(p)});if(!l.ok){let C=yield l.text();throw console.error("\u{1F680} Error response body:",C),new Error(`HTTP ${l.status}: ${l.statusText}`)}let g=yield l.json();return console.log("\u{1F680} Foto creada:",g),g[0]}catch(a){throw console.error("\u{1F680} Error en fetch directo:",a),a}})}eliminarFotoDirect(o){return console.log("\u{1F680} AvisosService: Usando FETCH DIRECTO para eliminar foto..."),d(this.fetchEliminarFotoDirect(o)).pipe(f(()=>{console.log("\u2705 AvisosService: FETCH DIRECTO completado, foto eliminada")}),m(e=>{throw console.error("\u274C AvisosService: Error en FETCH DIRECTO:",e),e}))}fetchEliminarFotoDirect(o){return F(this,null,function*(){console.log("\u{1F680} AvisosService: Ejecutando fetch directo para eliminar foto:",o);try{let e=`${v.supabaseUrl}/rest/v1/fotos_aviso?select=*&id=eq.${o}`,t={apikey:v.supabaseServiceKey,Authorization:`Bearer ${v.supabaseServiceKey}`,"Content-Type":"application/json"};console.log("\u{1F680} Obteniendo informaci\xF3n de la foto:",e);let a=yield fetch(e,{method:"GET",headers:t});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);let r=yield a.json();if(!r||r.length===0)throw new Error("Foto no encontrada");let s=r[0];console.log("\u{1F680} Foto obtenida:",s);let n=s.url.split("/"),i=n[n.length-1],u=`${s.aviso_id}/${i}`,p=`${v.supabaseUrl}/storage/v1/object/fotos-avisos/${u}`,h=yield fetch(p,{method:"DELETE",headers:{Authorization:`Bearer ${v.supabaseServiceKey}`}});h.ok?console.log("\u2705 Archivo eliminado del storage"):console.warn("\u26A0\uFE0F Error al eliminar archivo del storage:",h.status);let l=`${v.supabaseUrl}/rest/v1/fotos_aviso?id=eq.${o}`,g=yield fetch(l,{method:"DELETE",headers:t});if(!g.ok)throw new Error(`HTTP ${g.status}: ${g.statusText}`);console.log("\u2705 Foto eliminada exitosamente")}catch(e){throw console.error("\u{1F680} Error en fetch directo:",e),e}})}sanitizeFileName(o){return o.replace(/[^a-zA-Z0-9.-]/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,"").toLowerCase()}crearFacturaDesdeTrabajos(o){return d(this.getSupabaseClient().from("avisos").select(`
                    *,
                    cliente:clientes(*),
                    trabajos:trabajos_realizados(
                        *,
                        materiales:materiales_trabajo(
                            *,
                            material:inventario(*)
                        ),
                        albaran:albaranes!trabajos_realizados_albaran_id_fkey(*)
                    )
                `).eq("id",o).single()).pipe(f(({data:e,error:t})=>{var n;if(t)throw t;let a=e,r=((n=a.trabajos)==null?void 0:n.filter(i=>{var c;return i.estado==="Finalizado"||((c=i.albaran)==null?void 0:c.estado_cierre)==="Finalizado"}))||[];if(r.length===0)throw new Error("No hay trabajos finalizados para facturar. Debes crear un albar\xE1n primero.");return{avisoId:a.id,cliente:a.cliente||{nombre_completo:a.nombre_cliente_aviso,direccion:a.direccion_cliente_aviso,email:"sin-email@ejemplo.com",cif:"Sin CIF"},trabajos:r,resumen:this.calcularResumenFacturacion(r)}}),m(e=>{throw console.error("Error al preparar factura desde trabajos:",e),e}))}calcularResumenFacturacion(o){let e=[],t=0;return o.forEach(a=>{var i;let r=new Date(`2000-01-01T${a.hora_inicio}`),n=(new Date(`2000-01-01T${a.hora_fin}`).getTime()-r.getTime())/(1e3*60*60);t+=Math.max(0,n),(i=a.materiales)==null||i.forEach(c=>{var p,h;let u=e.find(l=>l.material_id===c.material_id);u?u.cantidad_total+=c.cantidad_utilizada:e.push({material_id:c.material_id,nombre:((p=c.material)==null?void 0:p.nombre)||"Material desconocido",cantidad_total:c.cantidad_utilizada,precio_unitario:c.precio_neto_al_momento,descripcion:((h=c.material)==null?void 0:h.descripcion)||""})})}),{materiales:e,horasTotales:t,numeroTrabajos:o.length}}getResumenCompletoAvisoDirect(o){return console.log("\u{1F680} AvisosService: Usando FETCH DIRECTO para resumen completo de aviso..."),d(this.fetchResumenCompletoAvisoDirect(o)).pipe(f(e=>(console.log("\u2705 AvisosService: FETCH DIRECTO completado, aviso:",e==null?void 0:e.id),e)),m(e=>{throw console.error("\u274C AvisosService: Error en FETCH DIRECTO:",e),e}))}fetchResumenCompletoAvisoDirect(o){return F(this,null,function*(){var e,t,a,r,s,n,i,c;console.log("\u{1F680} AvisosService: Ejecutando fetch directo para resumen completo de aviso:",o);try{let u=`${v.supabaseUrl}/rest/v1/avisos?select=*,cliente:clientes(*),tecnico_asignado:usuarios(*),fotos:fotos_aviso(*),albaranes:albaranes(*,repuestos:repuestos_albaran(*)),presupuestos:presupuestos(*),facturas:facturas(*)&id=eq.${o}`,p={apikey:v.supabaseServiceKey,Authorization:`Bearer ${v.supabaseServiceKey}`,"Content-Type":"application/json"};console.log("\u{1F680} URL construida:",u);let h=Date.now(),l=yield fetch(u,{method:"GET",headers:p}),g=Date.now()-h;if(console.log("\u{1F680} Fetch completado en",g,"ms"),console.log("\u{1F680} Status:",l.status),!l.ok){let S=yield l.text();throw console.error("\u{1F680} Error response body:",S),new Error(`HTTP ${l.status}: ${l.statusText}`)}let C=yield l.json();if(console.log("\u{1F680} Datos recibidos:",(C==null?void 0:C.length)||0,"avisos"),!C||C.length===0)throw new Error("Aviso no encontrado");let b=C[0];console.log("\u{1F680} Estructura de aviso recibida:",b);let A=((e=b.albaranes)==null?void 0:e.filter(S=>S.estado_cierre==="Finalizado"))||[],E=((t=b.albaranes)==null?void 0:t.filter(S=>S.estado_cierre==="Presupuesto pendiente"))||[],$=((a=b.albaranes)==null?void 0:a.filter(S=>S.estado_cierre==="Otra visita"))||[],z=[...A,...E],_=((r=b.facturas)==null?void 0:r.filter(S=>S.estado!=="Completado"))||[],k=((s=b.facturas)==null?void 0:s.filter(S=>S.estado==="Completado"))||[],x=E.length>0,I=$.length>0;return j(D({},b),{estadisticas:{totalAlbaranes:((n=b.albaranes)==null?void 0:n.length)||0,albaranesCerrados:z.length,albaranesFinalizados:A.length,albaranesPresupuestoPendiente:E.length,albaranesOtraVisita:$.length,tienePresupuesto:x,requiereOtraVisita:I,estadoPresupuesto:x?"Pendiente":null,totalFacturas:((i=b.facturas)==null?void 0:i.length)||0,facturasPendientes:_.length,facturasCompletadas:k.length,totalTrabajos:((c=b.albaranes)==null?void 0:c.length)||0,trabajosConAlbaran:z.length,trabajosFinalizados:A.length,puedeFacturar:A.length>0&&_.length===0}})}catch(u){throw console.error("\u{1F680} Error en fetch directo:",u),u}})}getResumenCompletoAviso(o){return d(this.getSupabaseClient().from("avisos").select(`
                    *,
                    cliente:clientes(*),
                    tecnico_asignado:usuarios(*),
                    fotos:fotos_aviso(*),
                    albaranes:albaranes(
                        *,
                        repuestos_utilizados,
                        repuestos:repuestos_albaran(*)
                    ),
                    presupuestos:presupuestos(*),
                    facturas:facturas(*)
                `).eq("id",o).single()).pipe(f(({data:e,error:t})=>{var l,g,C,b,A,E,$,z;if(t)throw t;let a=e,r=((l=a.albaranes)==null?void 0:l.filter(_=>_.estado_cierre==="Finalizado"))||[],s=((g=a.albaranes)==null?void 0:g.filter(_=>_.estado_cierre==="Presupuesto pendiente"))||[],n=((C=a.albaranes)==null?void 0:C.filter(_=>_.estado_cierre==="Otra visita"))||[],i=[...r,...s],c=((b=a.facturas)==null?void 0:b.filter(_=>_.estado!=="Completado"))||[],u=((A=a.facturas)==null?void 0:A.filter(_=>_.estado==="Completado"))||[],p=s.length>0,h=n.length>0;return j(D({},a),{estadisticas:{totalAlbaranes:((E=a.albaranes)==null?void 0:E.length)||0,albaranesCerrados:i.length,albaranesFinalizados:r.length,albaranesPresupuestoPendiente:s.length,albaranesOtraVisita:n.length,tienePresupuesto:p,requiereOtraVisita:h,estadoPresupuesto:p?"Pendiente":null,totalFacturas:(($=a.facturas)==null?void 0:$.length)||0,facturasPendientes:c.length,facturasCompletadas:u.length,totalTrabajos:((z=a.albaranes)==null?void 0:z.length)||0,trabajosConAlbaran:i.length,trabajosFinalizados:r.length,puedeFacturar:r.length>0&&c.length===0}})}),m(e=>{throw console.error("Error al obtener resumen completo:",e),e}))}actualizarEstadoAutomatico(o){return this.getResumenCompletoAvisoDirect(o).pipe(w(e=>{var a,r;let t=e.estado;return console.log("\u{1F50D} Analizando estado del aviso:",{estadoActual:e.estado,trabajosFinalizados:e.estadisticas.trabajosFinalizados,totalFacturas:e.estadisticas.totalFacturas,facturasPendientes:e.estadisticas.facturasPendientes,facturasCompletadas:e.estadisticas.facturasCompletadas,trabajos:((a=e.trabajos)==null?void 0:a.length)||0,albaranes:((r=e.albaranes)==null?void 0:r.length)||0}),e.estadisticas.trabajosFinalizados>0&&e.estadisticas.totalFacturas>0&&e.estadisticas.facturasPendientes===0?t="Completado":e.estadisticas.trabajosFinalizados>0&&e.estadisticas.facturasPendientes===0?t="Listo para facturar":e.estadisticas.trabajosPresupuestoPendiente>0?t="Pendiente de presupuesto":e.estadisticas.trabajosOtraVisita>0?t="Otra visita requerida":e.estadisticas.trabajosConAlbaran>0&&e.estadisticas.tienePresupuesto?t="Pendiente de presupuesto":e.estadisticas.trabajosConAlbaran>0||e.estadisticas.totalTrabajos>0?t="En curso":e.estadisticas.totalTrabajos===0&&e.estadisticas.trabajosConAlbaran===0&&(e.estado==="Pendiente"?t=e.estado:t="Pendiente"),console.log("\u{1F50D} Estado calculado:",{estadoAnterior:e.estado,estadoNuevo:t,cambio:e.estado!==t}),t!==e.estado?(console.log(`\u{1F504} Actualizando estado del aviso ${o} de "${e.estado}" a "${t}"`),this.actualizarAviso(o,{estado:t})):d([e])}))}};T.\u0275fac=function(e){return new(e||T)(y(H),y(U))},T.\u0275prov=R({token:T,factory:T.\u0275fac,providedIn:"root"});let P=T;return P})();export{G as a};
