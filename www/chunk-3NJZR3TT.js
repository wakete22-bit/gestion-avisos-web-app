import{a as n,b as j}from"./chunk-ZFUZ5UD4.js";import{E as T,H as v,d as D,f as t,j as m,r as f,y as _}from"./chunk-QQQKELKR.js";import{a as h,b as C,k as u}from"./chunk-CRC5ZNR6.js";var y=(()=>{let d=class d{constructor(e){this.supabaseClientService=e,this.ajustesSubject=new D(null),this.ajustes$=this.ajustesSubject.asObservable()}getSupabaseClient(){return console.log("\u2699\uFE0F AjustesService: Obteniendo cliente Supabase actualizado..."),this.supabaseClientService.getClient()}getAjustesCompletos(){return console.log("\u{1F680} AjustesService: Usando FETCH DIRECTO para obtener ajustes completos..."),t(this.fetchAjustesCompletosDirect()).pipe(m(e=>(console.log("\u2705 AjustesService: FETCH DIRECTO completado para ajustes completos"),this.ajustesSubject.next(e),e)),f(e=>{throw console.error("\u274C AjustesService: Error en FETCH DIRECTO para ajustes completos:",e),e}))}fetchAjustesCompletosDirect(){return u(this,null,function*(){console.log("\u{1F680} AjustesService: Ejecutando fetch directo para ajustes completos...");try{let e={apikey:n.supabaseServiceKey,Authorization:`Bearer ${n.supabaseServiceKey}`,"Content-Type":"application/json"},[o,a,i,r,s]=yield Promise.all([this.fetchConfiguracionDirect("configuracion_empresa",e),this.fetchConfiguracionDirect("configuracion_facturacion",e),this.fetchConfiguracionDirect("configuracion_notificaciones",e),this.fetchConfiguracionDirect("configuracion_avisos",e),this.fetchConfiguracionDirect("configuracion_sistema",e)]),c={empresa:o,facturacion:a,notificaciones:i,avisos:r,sistema:s};return console.log("\u2705 Ajustes completos obtenidos con FETCH DIRECTO:",c),c}catch(e){throw console.error("\u{1F680} Error en fetch directo para ajustes completos:",e),e}})}fetchConfiguracionDirect(e,o){return u(this,null,function*(){let a=`${n.supabaseUrl}/rest/v1/${e}?select=*&limit=1`,i=yield fetch(a,{method:"GET",headers:o});if(!i.ok){let s=yield i.text();throw new Error(`HTTP ${i.status}: ${i.statusText} - ${s}`)}let r=yield i.json();return!r||r.length===0?yield this.crearConfiguracionPorDefecto(e,o):r[0]})}crearConfiguracionPorDefecto(e,o){return u(this,null,function*(){console.log(`\u{1F195} Creando configuraci\xF3n por defecto para ${e}...`);let a;switch(e){case"configuracion_empresa":a={nombre_empresa:"Mi Empresa",cif:"",direccion:"",telefono:"",email:"",web:"",logo_url:"",precio_hora_mano_obra:50,fecha_creacion:new Date().toISOString(),fecha_actualizacion:new Date().toISOString()};break;case"configuracion_facturacion":a={iva_por_defecto:21,moneda:"EUR",formato_numero_factura:"FAC-{YEAR}-{NUMBER}",dias_vencimiento:30,texto_pie_factura:"Gracias por confiar en nuestros servicios",condiciones_pago:"Pago a 30 d\xEDas",fecha_creacion:new Date().toISOString(),fecha_actualizacion:new Date().toISOString()};break;case"configuracion_notificaciones":a={email_notificaciones:!0,email_avisos_nuevos:!0,email_facturas_generadas:!0,email_recordatorios:!1,sms_notificaciones:!1,sms_avisos_urgentes:!1,fecha_creacion:new Date().toISOString(),fecha_actualizacion:new Date().toISOString()};break;case"configuracion_avisos":a={tipos_urgencia:["Baja","Media","Alta","Cr\xEDtica"],estados_disponibles:["Pendiente","En curso","Completado","Cancelado"],tiempo_maximo_respuesta:24,asignacion_automatica:!1,fecha_creacion:new Date().toISOString(),fecha_actualizacion:new Date().toISOString()};break;case"configuracion_sistema":a={backup_automatico:!0,frecuencia_backup:"diario",retencion_backup_dias:30,modo_mantenimiento:!1,mensaje_mantenimiento:"Sistema en mantenimiento. Volveremos pronto.",fecha_creacion:new Date().toISOString(),fecha_actualizacion:new Date().toISOString()};break;default:throw new Error(`Tabla no reconocida: ${e}`)}let i=`${n.supabaseUrl}/rest/v1/${e}`,r=yield fetch(i,{method:"POST",headers:C(h({},o),{Prefer:"return=representation"}),body:JSON.stringify(a)});if(!r.ok){let c=yield r.text();throw new Error(`HTTP ${r.status}: ${r.statusText} - ${c}`)}let s=yield r.json();return console.log(`\u2705 Configuraci\xF3n por defecto creada para ${e}:`,s[0]),s[0]})}getConfiguracionEmpresa(){return console.log("\u{1F680} AjustesService: Usando FETCH DIRECTO para configuraci\xF3n de empresa..."),t(this.fetchConfiguracionEmpresaDirect()).pipe(m(e=>(console.log("\u2705 AjustesService: FETCH DIRECTO completado para configuraci\xF3n de empresa"),e)),f(e=>{throw console.error("\u274C AjustesService: Error en FETCH DIRECTO para configuraci\xF3n de empresa:",e),e}))}fetchConfiguracionEmpresaDirect(){return u(this,null,function*(){console.log("\u{1F680} AjustesService: Ejecutando fetch directo para configuraci\xF3n de empresa...");try{let e={apikey:n.supabaseServiceKey,Authorization:`Bearer ${n.supabaseServiceKey}`,"Content-Type":"application/json"},o=`${n.supabaseUrl}/rest/v1/configuracion_empresa?select=*&limit=1`,a=yield fetch(o,{method:"GET",headers:e});if(!a.ok){let r=yield a.text();throw new Error(`HTTP ${a.status}: ${a.statusText} - ${r}`)}let i=yield a.json();return!i||i.length===0?(console.log("No hay configuraci\xF3n de empresa, creando por defecto..."),yield this.crearConfiguracionPorDefecto("configuracion_empresa",e)):(console.log("\u2705 Configuraci\xF3n de empresa obtenida con FETCH DIRECTO:",i[0]),i[0])}catch(e){throw console.error("\u{1F680} Error en fetch directo para configuraci\xF3n de empresa:",e),e}})}getConfiguracionFacturacion(){return t(this.getSupabaseClient().from("configuracion_facturacion").select("*").limit(1)).pipe(_(({data:e,error:o})=>{if(o)throw console.error("Error al obtener configuraci\xF3n de facturaci\xF3n:",o),o;return!e||e.length===0?(console.log("No hay configuraci\xF3n de facturaci\xF3n, creando por defecto..."),t(this.crearConfiguracionFacturacionPorDefecto())):t(Promise.resolve(e[0]))}),f(e=>(console.error("Error al obtener configuraci\xF3n de facturaci\xF3n:",e),t(this.crearConfiguracionFacturacionPorDefecto()))))}getConfiguracionNotificaciones(){return t(this.getSupabaseClient().from("configuracion_notificaciones").select("*").limit(1)).pipe(_(({data:e,error:o})=>{if(o)throw console.error("Error al obtener configuraci\xF3n de notificaciones:",o),o;return!e||e.length===0?(console.log("No hay configuraci\xF3n de notificaciones, creando por defecto..."),t(this.crearConfiguracionNotificacionesPorDefecto())):t(Promise.resolve(e[0]))}),f(e=>(console.error("Error al obtener configuraci\xF3n de notificaciones:",e),t(this.crearConfiguracionNotificacionesPorDefecto()))))}getConfiguracionAvisos(){return t(this.getSupabaseClient().from("configuracion_avisos").select("*").limit(1)).pipe(_(({data:e,error:o})=>{if(o)throw console.error("Error al obtener configuraci\xF3n de avisos:",o),o;return!e||e.length===0?(console.log("No hay configuraci\xF3n de avisos, creando por defecto..."),t(this.crearConfiguracionAvisosPorDefecto())):t(Promise.resolve(e[0]))}),f(e=>(console.error("Error al obtener configuraci\xF3n de avisos:",e),t(this.crearConfiguracionAvisosPorDefecto()))))}getConfiguracionSistema(){return t(this.getSupabaseClient().from("configuracion_sistema").select("*").limit(1)).pipe(_(({data:e,error:o})=>{if(o)throw console.error("Error al obtener configuraci\xF3n del sistema:",o),o;return!e||e.length===0?(console.log("No hay configuraci\xF3n del sistema, creando por defecto..."),t(this.crearConfiguracionSistemaPorDefecto())):t(Promise.resolve(e[0]))}),f(e=>(console.error("Error al obtener configuraci\xF3n del sistema:",e),t(this.crearConfiguracionSistemaPorDefecto()))))}actualizarConfiguracionEmpresa(e){return console.log("\u{1F680} AjustesService: Usando FETCH DIRECTO para actualizar configuraci\xF3n de empresa..."),t(this.fetchActualizarConfiguracionEmpresaDirect(e)).pipe(m(o=>(console.log("\u2705 AjustesService: FETCH DIRECTO completado, configuraci\xF3n de empresa actualizada"),o)),f(o=>{throw console.error("\u274C AjustesService: Error en FETCH DIRECTO para actualizar configuraci\xF3n de empresa:",o),o}))}fetchActualizarConfiguracionEmpresaDirect(e){return u(this,null,function*(){console.log("\u{1F680} AjustesService: Ejecutando fetch directo para actualizar configuraci\xF3n de empresa...");try{let o=C(h({},e),{fecha_actualizacion:new Date().toISOString()}),a={apikey:n.supabaseServiceKey,Authorization:`Bearer ${n.supabaseServiceKey}`,"Content-Type":"application/json",Prefer:"return=representation"},i=`${n.supabaseUrl}/rest/v1/configuracion_empresa?select=id&limit=1`,r=yield fetch(i,{method:"GET",headers:a});if(!r.ok){let g=yield r.text();throw new Error(`HTTP ${r.status}: ${r.statusText} - ${g}`)}let s=yield r.json(),c;if(s&&s.length>0){let g=s[0].id;console.log("\u2705 Actualizando configuraci\xF3n existente con ID:",g);let S=`${n.supabaseUrl}/rest/v1/configuracion_empresa?id=eq.${g}`;c=yield fetch(S,{method:"PATCH",headers:a,body:JSON.stringify(o)})}else{console.log("\u{1F195} Creando nueva configuraci\xF3n de empresa");let g=`${n.supabaseUrl}/rest/v1/configuracion_empresa`;c=yield fetch(g,{method:"POST",headers:a,body:JSON.stringify(C(h({},o),{fecha_creacion:new Date().toISOString()}))})}if(!c.ok){let g=yield c.text();throw new Error(`HTTP ${c.status}: ${c.statusText} - ${g}`)}let l=(yield c.json())[0];return console.log("\u2705 Configuraci\xF3n de empresa actualizada con FETCH DIRECTO:",l),this.actualizarAjustesLocales("empresa",l),l}catch(o){throw console.error("\u{1F680} Error en fetch directo para actualizar configuraci\xF3n de empresa:",o),o}})}fetchActualizarConfiguracionDirect(e,o,a){return u(this,null,function*(){console.log(`\u{1F680} AjustesService: Ejecutando fetch directo para actualizar ${e}...`);try{let i=C(h({},o),{fecha_actualizacion:new Date().toISOString()}),r={apikey:n.supabaseServiceKey,Authorization:`Bearer ${n.supabaseServiceKey}`,"Content-Type":"application/json",Prefer:"return=representation"},s=`${n.supabaseUrl}/rest/v1/${e}?select=id&limit=1`,c=yield fetch(s,{method:"GET",headers:r});if(!c.ok){let p=yield c.text();throw new Error(`HTTP ${c.status}: ${c.statusText} - ${p}`)}let E=yield c.json(),l;if(E&&E.length>0){let p=E[0].id;console.log(`\u2705 Actualizando configuraci\xF3n existente de ${e} con ID:`,p);let b=`${n.supabaseUrl}/rest/v1/${e}?id=eq.${p}`;l=yield fetch(b,{method:"PATCH",headers:r,body:JSON.stringify(i)})}else{console.log(`\u{1F195} Creando nueva configuraci\xF3n de ${e}`);let p=`${n.supabaseUrl}/rest/v1/${e}`;l=yield fetch(p,{method:"POST",headers:r,body:JSON.stringify(C(h({},i),{fecha_creacion:new Date().toISOString()}))})}if(!l.ok){let p=yield l.text();throw new Error(`HTTP ${l.status}: ${l.statusText} - ${p}`)}let S=(yield l.json())[0];return console.log(`\u2705 Configuraci\xF3n de ${e} actualizada con FETCH DIRECTO:`,S),this.actualizarAjustesLocales(a,S),S}catch(i){throw console.error(`\u{1F680} Error en fetch directo para actualizar ${e}:`,i),i}})}actualizarConfiguracionFacturacion(e){return console.log("\u{1F680} AjustesService: Usando FETCH DIRECTO para actualizar configuraci\xF3n de facturaci\xF3n..."),t(this.fetchActualizarConfiguracionDirect("configuracion_facturacion",e,"facturacion")).pipe(m(o=>(console.log("\u2705 AjustesService: FETCH DIRECTO completado, configuraci\xF3n de facturaci\xF3n actualizada"),o)),f(o=>{throw console.error("\u274C AjustesService: Error en FETCH DIRECTO para actualizar configuraci\xF3n de facturaci\xF3n:",o),o}))}actualizarConfiguracionNotificaciones(e){return console.log("\u{1F680} AjustesService: Usando FETCH DIRECTO para actualizar configuraci\xF3n de notificaciones..."),t(this.fetchActualizarConfiguracionDirect("configuracion_notificaciones",e,"notificaciones")).pipe(m(o=>(console.log("\u2705 AjustesService: FETCH DIRECTO completado, configuraci\xF3n de notificaciones actualizada"),o)),f(o=>{throw console.error("\u274C AjustesService: Error en FETCH DIRECTO para actualizar configuraci\xF3n de notificaciones:",o),o}))}actualizarConfiguracionAvisos(e){return console.log("\u{1F680} AjustesService: Usando FETCH DIRECTO para actualizar configuraci\xF3n de avisos..."),t(this.fetchActualizarConfiguracionDirect("configuracion_avisos",e,"avisos")).pipe(m(o=>(console.log("\u2705 AjustesService: FETCH DIRECTO completado, configuraci\xF3n de avisos actualizada"),o)),f(o=>{throw console.error("\u274C AjustesService: Error en FETCH DIRECTO para actualizar configuraci\xF3n de avisos:",o),o}))}actualizarConfiguracionSistema(e){return console.log("\u{1F680} AjustesService: Usando FETCH DIRECTO para actualizar configuraci\xF3n del sistema..."),t(this.fetchActualizarConfiguracionDirect("configuracion_sistema",e,"sistema")).pipe(m(o=>(console.log("\u2705 AjustesService: FETCH DIRECTO completado, configuraci\xF3n del sistema actualizada"),o)),f(o=>{throw console.error("\u274C AjustesService: Error en FETCH DIRECTO para actualizar configuraci\xF3n del sistema:",o),o}))}actualizarAjustesLocales(e,o){let a=this.ajustesSubject.value;a&&(a[e]=o,this.ajustesSubject.next(h({},a)),console.log("\u2705 Ajustes locales actualizados:",e,o))}crearConfiguracionEmpresaPorDefecto(){return u(this,null,function*(){let e={nombre_empresa:"Mi Empresa",cif:"",direccion:"",telefono:"",email:"",web:"",logo_url:"",precio_hora_mano_obra:50,fecha_creacion:new Date().toISOString(),fecha_actualizacion:new Date().toISOString()},{data:o,error:a}=yield this.getSupabaseClient().from("configuracion_empresa").insert([e]).select().single();if(a)throw a;return o})}crearConfiguracionFacturacionPorDefecto(){return u(this,null,function*(){let e={iva_por_defecto:21,moneda:"EUR",formato_numero_factura:"FAC-{YEAR}-{NUMBER}",dias_vencimiento:30,texto_pie_factura:"Gracias por confiar en nuestros servicios",condiciones_pago:"Pago a 30 d\xEDas",fecha_creacion:new Date().toISOString(),fecha_actualizacion:new Date().toISOString()},{data:o,error:a}=yield this.getSupabaseClient().from("configuracion_facturacion").insert([e]).select().single();if(a)throw a;return o})}crearConfiguracionNotificacionesPorDefecto(){return u(this,null,function*(){let e={email_notificaciones:!0,email_avisos_nuevos:!0,email_facturas_generadas:!0,email_recordatorios:!1,sms_notificaciones:!1,sms_avisos_urgentes:!1,fecha_creacion:new Date().toISOString(),fecha_actualizacion:new Date().toISOString()},{data:o,error:a}=yield this.getSupabaseClient().from("configuracion_notificaciones").insert([e]).select().single();if(a)throw a;return o})}crearConfiguracionAvisosPorDefecto(){return u(this,null,function*(){let e={tipos_urgencia:["Baja","Media","Alta","Cr\xEDtica"],estados_disponibles:["Pendiente","En curso","Completado","Cancelado"],tiempo_maximo_respuesta:24,asignacion_automatica:!1,fecha_creacion:new Date().toISOString(),fecha_actualizacion:new Date().toISOString()},{data:o,error:a}=yield this.getSupabaseClient().from("configuracion_avisos").insert([e]).select().single();if(a)throw a;return o})}crearConfiguracionSistemaPorDefecto(){return u(this,null,function*(){let e={backup_automatico:!0,frecuencia_backup:"diario",retencion_backup_dias:30,modo_mantenimiento:!1,mensaje_mantenimiento:"Sistema en mantenimiento. Volveremos pronto.",fecha_creacion:new Date().toISOString(),fecha_actualizacion:new Date().toISOString()},{data:o,error:a}=yield this.getSupabaseClient().from("configuracion_sistema").insert([e]).select().single();if(a)throw a;return o})}getAjustesActuales(){return this.ajustesSubject.value}limpiarAjustes(){this.ajustesSubject.next(null)}};d.\u0275fac=function(o){return new(o||d)(v(j))},d.\u0275prov=T({token:d,factory:d.\u0275fac,providedIn:"root"});let w=d;return w})();export{y as a};
