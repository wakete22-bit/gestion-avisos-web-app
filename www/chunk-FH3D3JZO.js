import{a as q}from"./chunk-5ZJTCSBL.js";import{a as y}from"./chunk-5YRB7RVB.js";import{a as $}from"./chunk-VQH6GBOE.js";import{b as x}from"./chunk-GDHKTYOW.js";import{B as D,F as I,I as _,d as N,f as n,g as j,j as u,s as g,z as f}from"./chunk-4AY4VQCP.js";import{a as v,b,d as F}from"./chunk-CRC5ZNR6.js";var R=(()=>{let h=class h{constructor(e,a,i,t){this.supabaseClientService=e,this.dataUpdateService=a,this.configuracionService=i,this.avisosService=t,this.facturasSubject=new N([]),this.facturas$=this.facturasSubject.asObservable(),this.supabase=this.supabaseClientService.getClient()}getFacturas(e=1,a=10,i,t,o,s){let r=this.supabase.from("facturas").select(`
        *,
        cliente:clientes(*),
        aviso:avisos(*)
      `,{count:"exact"});i&&(r=r.or(`numero_factura.ilike.%${i}%,nombre_cliente.ilike.%${i}%`)),s&&(r=r.eq("estado",s));let l=(e-1)*a;return r=r.range(l,l+a-1).order(t||"fecha_creacion",{ascending:o==="asc"}),n(r).pipe(u(({data:c,error:d,count:p})=>{if(d)throw d;let m=c;return this.facturasSubject.next(m),{facturas:m,total:p||0,pagina:e,por_pagina:a}}),g(c=>{throw console.error("Error al obtener facturas:",c),c}))}getFactura(e){return n(this.supabase.from("facturas").select(`
          *,
          cliente:clientes(*),
          aviso:avisos(*)
        `).eq("id",e).single()).pipe(f(({data:a,error:i})=>{if(i)throw i;return n(this.supabase.from("lineas_factura").select("*").eq("factura_id",e).order("fecha_creacion",{ascending:!0})).pipe(u(({data:t,error:o})=>{if(o)throw o;return{factura:a,lineas:t}}))}))}crearFactura(e){let o=e,{lineas:a}=o,i=F(o,["lineas"]),t=b(v({},i),{subtotal:i.subtotal||0,iva:i.iva||0,total:i.total||0,fecha_creacion:new Date().toISOString(),fecha_actualizacion:new Date().toISOString()});return(isNaN(t.subtotal)||!isFinite(t.subtotal))&&(console.error("\u274C Subtotal inv\xE1lido:",t.subtotal),t.subtotal=0),(isNaN(t.iva)||!isFinite(t.iva))&&(console.error("\u274C IVA inv\xE1lido:",t.iva),t.iva=0),(isNaN(t.total)||!isFinite(t.total))&&(console.error("\u274C Total inv\xE1lido:",t.total),t.total=0),console.log("\u{1F4CB} Insertando factura con datos:",t),n(this.supabase.from("facturas").insert([t]).select(`
          *,
          cliente:clientes(*),
          aviso:avisos(*)
        `).single()).pipe(f(({data:s,error:r})=>{if(r){if(r.code==="23505"&&r.message.includes("numero_factura"))return console.warn("N\xFAmero de factura duplicado, generando nuevo n\xFAmero..."),this.getSiguienteNumero().pipe(f(l=>{let c=b(v({},t),{numero_factura:l});return n(this.supabase.from("facturas").insert([c]).select(`
                      *,
                      cliente:clientes(*),
                      aviso:avisos(*)
                    `).single()).pipe(f(({data:d,error:p})=>{if(p)throw p;return this.procesarLineasFactura(d,a)}))}));throw r}return this.procesarLineasFactura(s,a)}))}procesarLineasFactura(e,a){if(!a||a.length===0){let t=this.facturasSubject.value;return this.facturasSubject.next([e,...t]),this.dataUpdateService.notifyCreated("facturas"),n([{factura:e,lineas:[]}])}let i=a.map(t=>b(v({},t),{factura_id:e.id,fecha_creacion:new Date().toISOString()}));return n(this.supabase.from("lineas_factura").insert(i).select()).pipe(u(({data:t,error:o})=>{if(o)throw o;let s=this.facturasSubject.value;return this.facturasSubject.next([e,...s]),this.dataUpdateService.notifyCreated("facturas"),{factura:e,lineas:t}}))}actualizarFactura(e,a){let s=a,{lineas:i}=s,t=F(s,["lineas"]),o=b(v({},t),{fecha_actualizacion:new Date().toISOString()});return n(this.supabase.from("facturas").update(o).eq("id",e).select(`
          *,
          cliente:clientes(*),
          aviso:avisos(*)
        `).single()).pipe(f(({data:r,error:l})=>{if(l)throw l;let c=r;return i?n(this.supabase.from("lineas_factura").delete().eq("factura_id",e)).pipe(f(({error:d})=>{if(d)throw d;if(i.length===0)return n([{factura:c,lineas:[]}]);let p=i.map(m=>b(v({},m),{factura_id:e,fecha_creacion:new Date().toISOString()}));return n(this.supabase.from("lineas_factura").insert(p).select()).pipe(u(({data:m,error:A})=>{if(A)throw A;let w=this.facturasSubject.value,C=w.findIndex(z=>z.id===e);return C!==-1&&(w[C]=c,this.facturasSubject.next([...w])),this.dataUpdateService.notifyUpdated("facturas"),{factura:c,lineas:m}}))})):this.getFactura(e)}))}eliminarFactura(e){return n(this.supabase.from("facturas").select("aviso_id").eq("id",e).single()).pipe(f(({data:a,error:i})=>{if(i)throw i;let t=a.aviso_id;return console.log("\u{1F5D1}\uFE0F Eliminando factura y actualizando aviso:",t),n(this.supabase.from("lineas_factura").delete().eq("factura_id",e)).pipe(f(({error:o})=>{if(o)throw o;return n(this.supabase.from("facturas").delete().eq("id",e)).pipe(u(({error:s})=>{if(s)throw s;let l=this.facturasSubject.value.filter(c=>c.id!==e);return this.facturasSubject.next(l),this.dataUpdateService.notifyDeleted("facturas"),t}))}))}),f(a=>(console.log("\u{1F504} Actualizando estado del aviso despu\xE9s de eliminar factura:",a),this.avisosService.actualizarEstadoAutomatico(a).pipe(u(()=>{}),g(i=>(console.error("\u274C Error al actualizar estado del aviso:",i),j(void 0)))))))}buscarFacturas(e){return n(this.supabase.from("facturas").select(`
          *,
          cliente:clientes(*),
          aviso:avisos(*)
        `).or(`numero_factura.ilike.%${e}%,nombre_cliente.ilike.%${e}%`).limit(10)).pipe(u(({data:a,error:i})=>{if(i)throw i;return a}))}getFacturasPorEstado(e){return n(this.supabase.from("facturas").select(`
          *,
          cliente:clientes(*),
          aviso:avisos(*)
        `).eq("estado",e).order("fecha_creacion",{ascending:!1})).pipe(u(({data:a,error:i})=>{if(i)throw i;return a}))}getFacturasPorCliente(e){return n(this.supabase.from("facturas").select(`
          *,
          cliente:clientes(*),
          aviso:avisos(*)
        `).eq("cliente_id",e).order("fecha_creacion",{ascending:!1})).pipe(u(({data:a,error:i})=>{if(i)throw i;return a}))}getFacturasPorAviso(e){return n(this.supabase.from("facturas").select(`
          *,
          cliente:clientes(*),
          aviso:avisos(*)
        `).eq("aviso_id",e).order("fecha_creacion",{ascending:!1})).pipe(u(({data:a,error:i})=>{if(i)throw i;return a}))}cambiarEstado(e,a){return n(this.supabase.from("facturas").update({estado:a,fecha_actualizacion:new Date().toISOString()}).eq("id",e).select(`
          *,
          cliente:clientes(*),
          aviso:avisos(*)
        `).single()).pipe(u(({data:i,error:t})=>{if(t)throw t;let o=i,s=this.facturasSubject.value,r=s.findIndex(l=>l.id===e);return r!==-1&&(s[r]=o,this.facturasSubject.next([...s])),this.dataUpdateService.notifyUpdated("facturas"),o}))}getSiguienteNumero(){return n(this.supabase.rpc("obtener_siguiente_numero_factura")).pipe(u(({data:e,error:a})=>a?(console.error("Error al obtener n\xFAmero de factura:",a),this.getSiguienteNumeroFallback()):e),g(e=>(console.error("Error en RPC, usando fallback:",e),this.getSiguienteNumeroFallback())))}getSiguienteNumeroFallback(){let e=new Date().getFullYear();return n(this.supabase.from("facturas").select("numero_factura").like("numero_factura",`FAC-${e}-%`).order("numero_factura",{ascending:!1}).limit(1)).pipe(u(({data:a,error:i})=>{if(i)throw i;if(!a||a.length===0)return`FAC-${e}-001`;let o=a[0].numero_factura.match(/FAC-\d{4}-(\d{3})/);if(o){let s=parseInt(o[1])+1;return`FAC-${e}-${s.toString().padStart(3,"0")}`}return`FAC-${e}-001`}),D(()=>new Promise(a=>setTimeout(a,100))))}calcularTotales(e){return!e||!Array.isArray(e)||e.length===0?(console.warn("\u26A0\uFE0F No hay l\xEDneas de factura para calcular totales"),j({subtotal:0,iva:0,total:0})):this.configuracionService.getIvaPorDefecto().pipe(u(a=>{let i=e.reduce((s,r)=>{let l=r.cantidad||0,c=r.precio_pvp||0,d=l*c;return isNaN(d)||!isFinite(d)?(console.warn("\u26A0\uFE0F L\xEDnea con valores inv\xE1lidos:",r),s):s+d},0);if(isNaN(i)||!isFinite(i))return console.warn("\u26A0\uFE0F Subtotal calculado es inv\xE1lido, usando 0"),{subtotal:0,iva:0,total:0};let t=+(i*(a/100)).toFixed(2),o=+(i+t).toFixed(2);return console.log("\u{1F9EE} C\xE1lculo de totales:",{lineas:e.length,subtotal:i,iva:t,total:o,ivaPorcentaje:a}),{subtotal:i,iva:t,total:o}}))}getFacturasActuales(){return this.facturasSubject.value}limpiarFacturas(){this.facturasSubject.next([])}crearFacturaDesdePresupuesto(e){return n(this.supabase.from("presupuestos").select(`
          *,
          aviso:avisos(
            *,
            cliente:clientes(*)
          ),
          materiales_estimados
        `).eq("id",e).single()).pipe(f(({data:a,error:i})=>{if(i)throw i;let t=a;if(t.estado!=="Completado")throw new Error("Solo se pueden facturar presupuestos aprobados");if(!t.aviso)throw new Error("El presupuesto no tiene un aviso asociado");return this.getSiguienteNumero().pipe(f(o=>{let s=[];return t.materiales_estimados&&Array.isArray(t.materiales_estimados)&&t.materiales_estimados.forEach(r=>{s.push({tipo:"repuesto",nombre:r.nombre||"Material desconocido",cantidad:r.cantidad||0,precio_neto:r.precio_neto||0,precio_pvp:r.precio_pvp||0,descripcion:`Material del presupuesto: ${r.descripcion||""}`})}),t.horas_estimadas&&t.horas_estimadas>0?this.configuracionService.getPrecioHoraManoObra().pipe(f(r=>(s.push({tipo:"mano_obra",nombre:"Mano de obra",cantidad:t.horas_estimadas,precio_pvp:r,descripcion:`${t.horas_estimadas} horas de trabajo t\xE9cnico`}),this.calcularTotales(s))),f(r=>this.crearFacturaConDatos(t,o,s,r,e))):this.calcularTotales(s).pipe(f(r=>this.crearFacturaConDatos(t,o,s,r,e)))}))}),g(a=>{throw console.error("Error al crear factura desde presupuesto:",a),a}))}crearFacturaConDatos(e,a,i,t,o){let s=t.subtotal||0,r=t.iva||0,l=t.total||0;console.log("\u{1F4CA} Totales calculados:",{subtotal:s,iva:r,total:l});let c=e.aviso.cliente,d={numero_factura:a,fecha_emision:new Date().toISOString().split("T")[0],cliente_id:c==null?void 0:c.id,nombre_cliente:(c==null?void 0:c.nombre_completo)||e.aviso.nombre_cliente_aviso||"Cliente",direccion_cliente:(c==null?void 0:c.direccion)||e.aviso.direccion_cliente_aviso||"Sin direcci\xF3n",cif_cliente:(c==null?void 0:c.cif)||"Sin CIF",email_cliente:(c==null?void 0:c.email)||"sin-email@ejemplo.com",aviso_id:e.aviso_id,subtotal:s,iva:r,total:l,estado:"Pendiente",notas:`Factura generada desde presupuesto ${o}`,lineas:i};return console.log("\u{1F4CB} Datos de factura a crear:",d),this.crearFactura(d).pipe(f(p=>n(this.supabase.from("presupuestos").update({estado:"Facturado",fecha_actualizacion:new Date().toISOString()}).eq("id",o)).pipe(u(()=>p))))}getPresupuestosListosParaFacturar(){return n(this.supabase.from("presupuestos").select(`
          *,
          aviso:avisos(
            *,
            cliente:clientes(*)
          )
        `).eq("estado","Completado").order("fecha_creacion",{ascending:!1})).pipe(u(({data:e,error:a})=>{if(a)throw a;return e||[]}))}};h.\u0275fac=function(a){return new(a||h)(_(x),_(y),_(q),_($))},h.\u0275prov=I({token:h,factory:h.\u0275fac,providedIn:"root"});let S=h;return S})();export{R as a};
