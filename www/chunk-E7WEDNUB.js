import{b as j}from"./chunk-EZQHEP6E.js";import{B as w,E as k,c as S,e as s,i as u,p as g}from"./chunk-YCXETNVK.js";import{a as v,b}from"./chunk-CRC5ZNR6.js";var C=(()=>{let l=class l{constructor(e){this.supabaseClientService=e,this.inventarioSubject=new S([]),this.inventario$=this.inventarioSubject.asObservable(),this.supabase=this.supabaseClientService.getClient()}getInventario(e=1,t=10,i,r,n,a=!1){let o=this.supabase.from("inventario").select("*",{count:"exact"});i&&(o=o.or(`nombre.ilike.%${i}%,descripcion.ilike.%${i}%,codigo.ilike.%${i}%`)),a&&(o=o.gt("cantidad_disponible",0));let c=(e-1)*t;return o=o.range(c,c+t-1).order(r||"fecha_creacion",{ascending:n==="asc"}),s(o).pipe(u(({data:d,error:p,count:h})=>{if(p)throw p;let m=d;return this.inventarioSubject.next(m),{inventario:m,total:h||0,pagina:e,por_pagina:t}}),g(d=>{throw console.error("Error al obtener inventario:",d),d}))}getProducto(e){return s(this.supabase.from("inventario").select("*").eq("id",e).single()).pipe(u(({data:t,error:i})=>{if(i)throw i;return t}))}getProductoPorCodigo(e){return s(this.supabase.from("inventario").select("*").eq("codigo",e).single()).pipe(u(({data:t,error:i})=>{if(i)throw i;return t}))}crearProducto(e){let t=b(v({},e),{fecha_creacion:new Date().toISOString(),fecha_actualizacion:new Date().toISOString()});return s(this.supabase.from("inventario").insert([t]).select().single()).pipe(u(({data:i,error:r})=>{if(r)throw r;let n=i,a=this.inventarioSubject.value;return this.inventarioSubject.next([n,...a]),n}))}actualizarProducto(e,t){let i=b(v({},t),{fecha_actualizacion:new Date().toISOString()});return s(this.supabase.from("inventario").update(i).eq("id",e).select().single()).pipe(u(({data:r,error:n})=>{if(n)throw n;let a=r,o=this.inventarioSubject.value,c=o.findIndex(d=>d.id===e);return c!==-1&&(o[c]=a,this.inventarioSubject.next([...o])),a}))}eliminarProducto(e){return s(this.supabase.from("inventario").delete().eq("id",e)).pipe(u(({error:t})=>{if(t)throw t;let r=this.inventarioSubject.value.filter(n=>n.id!==e);this.inventarioSubject.next(r)}))}buscarProductos(e){return s(this.supabase.from("inventario").select("*").or(`nombre.ilike.%${e}%,descripcion.ilike.%${e}%,codigo.ilike.%${e}%`).order("fecha_creacion",{ascending:!1}).limit(10)).pipe(u(({data:t,error:i})=>{if(i)throw i;return t}))}getProductosStockBajo(){return s(this.supabase.from("inventario").select("*").lt("cantidad_disponible",5).gt("cantidad_disponible",0).order("cantidad_disponible",{ascending:!0})).pipe(u(({data:e,error:t})=>{if(t)throw t;return e}))}getProductosSinStock(){return s(this.supabase.from("inventario").select("*").eq("cantidad_disponible",0).order("nombre",{ascending:!0})).pipe(u(({data:e,error:t})=>{if(t)throw t;return e}))}actualizarStock(e,t){return this.actualizarProducto(e,{cantidad_disponible:t})}generarCodigoProducto(){let e=Date.now().toString(),t=Math.random().toString(36).substring(2,8).toUpperCase();return`P${e.slice(-6)}${t}`}verificarCodigoExistente(e){return s(this.supabase.from("inventario").select("codigo").eq("codigo",e).limit(1)).pipe(u(({data:t,error:i})=>{if(i)throw i;return t&&t.length>0}))}getEstadisticas(){return s(this.supabase.from("inventario").select("cantidad_disponible")).pipe(u(({data:e,error:t})=>{if(t)throw t;let i=e,r=i.length,n=i.filter(c=>c.cantidad_disponible>0).length,a=r-n,o=i.reduce((c,d)=>c+d.cantidad_disponible,0);return{totalProductos:r,productosConStock:n,productosSinStock:a,stockTotal:o}}))}getInventarioActual(){return this.inventarioSubject.value}limpiarInventario(){this.inventarioSubject.next([])}getProductosConStock(e=1,t=10,i,r,n){return this.getInventario(e,t,i,r,n,!0)}getProductosSinStockPaginated(e=1,t=10,i,r,n){let a=this.supabase.from("inventario").select("*",{count:"exact"}).eq("cantidad_disponible",0);i&&(a=a.or(`nombre.ilike.%${i}%,descripcion.ilike.%${i}%,codigo.ilike.%${i}%`));let o=(e-1)*t;return a=a.range(o,o+t-1).order(r||"fecha_creacion",{ascending:n==="asc"}),s(a).pipe(u(({data:c,error:d,count:p})=>{if(d)throw d;let h=c;return this.inventarioSubject.next(h),{inventario:h,total:p||0,pagina:e,por_pagina:t}}),g(c=>{throw console.error("Error al obtener productos sin stock:",c),c}))}};l.\u0275fac=function(t){return new(t||l)(k(j))},l.\u0275prov=w({token:l,factory:l.\u0275fac,providedIn:"root"});let f=l;return f})();export{C as a};
