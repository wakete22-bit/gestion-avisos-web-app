import{a as O}from"./chunk-52VVF7TW.js";import{a as x}from"./chunk-JNUN2KTT.js";import{a as k}from"./chunk-N4FKO75N.js";import{a as d,b as U}from"./chunk-ZFUZ5UD4.js";import{A as I,E as A,H as T,d as y,f as u,g as j,j as f,r as S,y as h}from"./chunk-QQQKELKR.js";import{a as _,b as C,d as $,k as E}from"./chunk-CRC5ZNR6.js";var B=(()=>{let F=class F{constructor(t,e,r,o){this.supabaseClientService=t,this.dataUpdateService=e,this.configuracionService=r,this.avisosService=o,this.facturasSubject=new y([]),this.facturas$=this.facturasSubject.asObservable()}getSupabaseClient(){return console.log("\u{1F4B0} FacturasService: Obteniendo cliente Supabase actualizado..."),this.supabaseClientService.getClient()}getFacturas(t=1,e=10,r,o,s,i){let a=this.getSupabaseClient().from("facturas").select(`
        *,
        cliente:clientes(*),
        aviso:avisos(*)
      `,{count:"exact"});r&&(a=a.or(`numero_factura.ilike.%${r}%,nombre_cliente.ilike.%${r}%`)),i&&(a=a.eq("estado",i));let n=(t-1)*e;return a=a.range(n,n+e-1).order(o||"fecha_creacion",{ascending:s==="asc"}),u(a).pipe(f(({data:c,error:l,count:m})=>{if(l)throw l;let p=c;return this.facturasSubject.next(p),{facturas:p,total:m||0,pagina:t,por_pagina:e}}),S(c=>{throw console.error("Error al obtener facturas:",c),c}))}getFacturasDirect(t=1,e=10,r,o,s,i){return console.log("\u{1F680} FacturasService: Usando FETCH DIRECTO para facturas..."),u(this.fetchFacturasDirect(t,e,r,o,s,i)).pipe(f(a=>(console.log("\u2705 FacturasService: FETCH DIRECTO completado, facturas:",a.facturas.length),this.facturasSubject.next(a.facturas),a)),S(a=>{throw console.error("\u274C FacturasService: Error en FETCH DIRECTO:",a),a}))}fetchFacturasDirect(t=1,e=10,r,o,s,i){return E(this,null,function*(){console.log("\u{1F680} FacturasService: Ejecutando fetch directo para facturas...");try{let a=`${d.supabaseUrl}/rest/v1/facturas?select=*,cliente:clientes(*),aviso:avisos(*)`,n=[];r&&n.push(`or=(numero_factura.ilike.*${r}*,nombre_cliente.ilike.*${r}*)`),i&&n.push(`estado=eq.${i}`),n.length>0&&(a+="&"+n.join("&"));let c=(t-1)*e;a+=`&limit=${e}&offset=${c}`,a+=`&order=${o||"fecha_creacion"}.${s==="asc"?"asc":"desc"}`;let l={apikey:d.supabaseServiceKey,Authorization:`Bearer ${d.supabaseServiceKey}`,"Content-Type":"application/json",Prefer:"count=exact"};console.log("\u{1F680} URL construida:",a);let m=Date.now(),p=yield fetch(a,{method:"GET",headers:l}),g=Date.now()-m;if(console.log("\u{1F680} Fetch completado en",g,"ms"),console.log("\u{1F680} Status:",p.status),!p.ok)throw new Error(`HTTP ${p.status}: ${p.statusText}`);let v=yield p.json(),b=p.headers.get("content-range"),w=b?parseInt(b.split("/")[1]):v.length;return console.log("\u{1F680} Datos recibidos:",(v==null?void 0:v.length)||0,"facturas, total:",w),{facturas:v,total:w,pagina:t,por_pagina:e}}catch(a){throw console.error("\u{1F680} Error en fetch directo:",a),a}})}getFacturaDirect(t){return console.log("\u{1F680} FacturasService: Usando FETCH DIRECTO para factura individual..."),u(this.fetchFacturaDirect(t)).pipe(f(e=>{var r;return console.log("\u2705 FacturasService: FETCH DIRECTO completado, factura:",(r=e==null?void 0:e.factura)==null?void 0:r.id),e}),S(e=>{throw console.error("\u274C FacturasService: Error en FETCH DIRECTO:",e),e}))}fetchFacturaDirect(t){return E(this,null,function*(){console.log("\u{1F680} FacturasService: Ejecutando fetch directo para factura:",t);try{let e=`${d.supabaseUrl}/rest/v1/facturas?select=*,cliente:clientes(*),aviso:avisos(*),lineas:lineas_factura(*)&id=eq.${t}`,r={apikey:d.supabaseServiceKey,Authorization:`Bearer ${d.supabaseServiceKey}`,"Content-Type":"application/json"};console.log("\u{1F680} URL construida:",e);let o=Date.now(),s=yield fetch(e,{method:"GET",headers:r}),i=Date.now()-o;if(console.log("\u{1F680} Fetch completado en",i,"ms"),console.log("\u{1F680} Status:",s.status),!s.ok){let c=yield s.text();throw console.error("\u{1F680} Error response body:",c),new Error(`HTTP ${s.status}: ${s.statusText}`)}let a=yield s.json();if(console.log("\u{1F680} Datos recibidos:",(a==null?void 0:a.length)||0,"facturas"),!a||a.length===0)throw new Error("Factura no encontrada");let n=a[0];return console.log("\u{1F680} Estructura de factura recibida:",n),{factura:n,lineas:n.lineas||[]}}catch(e){throw console.error("\u{1F680} Error en fetch directo:",e),e}})}getFactura(t){return u(this.getSupabaseClient().from("facturas").select(`
          *,
          cliente:clientes(*),
          aviso:avisos(*)
        `).eq("id",t).single()).pipe(h(({data:e,error:r})=>{if(r)throw r;return u(this.getSupabaseClient().from("lineas_factura").select("*").eq("factura_id",t).order("fecha_creacion",{ascending:!0})).pipe(f(({data:o,error:s})=>{if(s)throw s;return{factura:e,lineas:o}}))}))}crearFactura(t){let s=t,{lineas:e}=s,r=$(s,["lineas"]),o=C(_({},r),{subtotal:r.subtotal||0,iva:r.iva||0,total:r.total||0,fecha_creacion:new Date().toISOString(),fecha_actualizacion:new Date().toISOString()});return(isNaN(o.subtotal)||!isFinite(o.subtotal))&&(console.error("\u274C Subtotal inv\xE1lido:",o.subtotal),o.subtotal=0),(isNaN(o.iva)||!isFinite(o.iva))&&(console.error("\u274C IVA inv\xE1lido:",o.iva),o.iva=0),(isNaN(o.total)||!isFinite(o.total))&&(console.error("\u274C Total inv\xE1lido:",o.total),o.total=0),console.log("\u{1F4CB} Insertando factura con datos:",o),u(this.getSupabaseClient().from("facturas").insert([o]).select(`
          *,
          cliente:clientes(*),
          aviso:avisos(*)
        `).single()).pipe(h(({data:i,error:a})=>{if(a){if(a.code==="23505"&&a.message.includes("numero_factura"))return console.warn("N\xFAmero de factura duplicado, generando nuevo n\xFAmero..."),this.getSiguienteNumero().pipe(h(n=>{let c=C(_({},o),{numero_factura:n});return u(this.getSupabaseClient().from("facturas").insert([c]).select(`
                      *,
                      cliente:clientes(*),
                      aviso:avisos(*)
                    `).single()).pipe(h(({data:l,error:m})=>{if(m)throw m;return this.procesarLineasFactura(l,e)}))}));throw a}return this.procesarLineasFactura(i,e)}))}procesarLineasFactura(t,e){if(!e||e.length===0){let o=this.facturasSubject.value;return this.facturasSubject.next([t,...o]),this.dataUpdateService.notifyCreated("facturas"),u([{factura:t,lineas:[]}])}let r=e.map(o=>C(_({},o),{factura_id:t.id,fecha_creacion:new Date().toISOString()}));return u(this.getSupabaseClient().from("lineas_factura").insert(r).select()).pipe(f(({data:o,error:s})=>{if(s)throw s;let i=this.facturasSubject.value;return this.facturasSubject.next([t,...i]),this.dataUpdateService.notifyCreated("facturas"),{factura:t,lineas:o}}))}actualizarFactura(t,e){let i=e,{lineas:r}=i,o=$(i,["lineas"]),s=C(_({},o),{fecha_actualizacion:new Date().toISOString()});return u(this.getSupabaseClient().from("facturas").update(s).eq("id",t).select(`
          *,
          cliente:clientes(*),
          aviso:avisos(*)
        `).single()).pipe(h(({data:a,error:n})=>{if(n)throw n;let c=a;return r?u(this.getSupabaseClient().from("lineas_factura").delete().eq("factura_id",t)).pipe(h(({error:l})=>{if(l)throw l;if(r.length===0)return u([{factura:c,lineas:[]}]);let m=r.map(p=>C(_({},p),{factura_id:t,fecha_creacion:new Date().toISOString()}));return u(this.getSupabaseClient().from("lineas_factura").insert(m).select()).pipe(f(({data:p,error:g})=>{if(g)throw g;let v=this.facturasSubject.value,b=v.findIndex(w=>w.id===t);return b!==-1&&(v[b]=c,this.facturasSubject.next([...v])),this.dataUpdateService.notifyUpdated("facturas"),{factura:c,lineas:p}}))})):this.getFactura(t)}))}eliminarFacturaDirect(t){return console.log("\u{1F680} FacturasService: Usando FETCH DIRECTO para eliminar factura..."),u(this.fetchEliminarFacturaDirect(t)).pipe(f(()=>{console.log("\u2705 FacturasService: FETCH DIRECTO completado, factura eliminada")}),S(e=>{throw console.error("\u274C FacturasService: Error en FETCH DIRECTO:",e),e}))}fetchEliminarFacturaDirect(t){return E(this,null,function*(){console.log("\u{1F680} FacturasService: Ejecutando fetch directo para eliminar factura:",t);try{let e=`${d.supabaseUrl}/rest/v1/facturas?select=aviso_id&id=eq.${t}`,r={apikey:d.supabaseServiceKey,Authorization:`Bearer ${d.supabaseServiceKey}`,"Content-Type":"application/json"};console.log("\u{1F680} Obteniendo informaci\xF3n de la factura:",e);let o=yield fetch(e,{method:"GET",headers:r});if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);let s=yield o.json();if(!s||s.length===0)throw new Error("Factura no encontrada");let i=s[0].aviso_id;console.log("\u{1F5D1}\uFE0F Eliminando factura y actualizando aviso:",i);let a=`${d.supabaseUrl}/rest/v1/lineas_factura?factura_id=eq.${t}`;console.log("\u{1F680} Eliminando l\xEDneas de factura:",a);let n=yield fetch(a,{method:"DELETE",headers:r});n.ok?console.log("\u2705 L\xEDneas de factura eliminadas"):console.warn("\u26A0\uFE0F Error al eliminar l\xEDneas de factura:",n.status);let c=`${d.supabaseUrl}/rest/v1/facturas?id=eq.${t}`;console.log("\u{1F680} Eliminando factura:",c);let l=yield fetch(c,{method:"DELETE",headers:r});if(!l.ok)throw new Error(`HTTP ${l.status}: ${l.statusText}`);console.log("\u2705 Factura eliminada exitosamente");let p=this.facturasSubject.value.filter(g=>g.id!==t);if(this.facturasSubject.next(p),this.dataUpdateService.notifyDeleted("facturas"),i){console.log("\u{1F504} Verificando estado del aviso antes de actualizar:",i);try{let g=`${d.supabaseUrl}/rest/v1/avisos?select=estado&id=eq.${i}`,v=yield fetch(g,{method:"GET",headers:r});if(v.ok){let b=yield v.json();if(b&&b.length>0){let w=b[0].estado;console.log("\u{1F4CA} Estado actual del aviso:",w),w!=="Completado"?(console.log('\u{1F504} Actualizando estado del aviso a "En curso"...'),yield this.avisosService.actualizarAvisoDirect(i,{estado:"En curso"}).toPromise(),console.log('\u2705 Estado del aviso actualizado a "En curso"')):console.log("\u2139\uFE0F El aviso ya est\xE1 completado, no se actualiza el estado")}else console.log("\u26A0\uFE0F No se pudo obtener informaci\xF3n del aviso")}else console.log("\u26A0\uFE0F No se pudo verificar el estado del aviso")}catch(g){console.error("\u274C Error al verificar/actualizar estado del aviso:",g)}}}catch(e){throw console.error("\u{1F680} Error en fetch directo:",e),e}})}eliminarFactura(t){return this.eliminarFacturaDirect(t)}buscarFacturasDirect(t){return console.log("\u{1F680} FacturasService: Usando FETCH DIRECTO para b\xFAsqueda de facturas..."),u(this.fetchBuscarFacturasDirect(t)).pipe(f(e=>(console.log("\u2705 FacturasService: FETCH DIRECTO completado para b\xFAsqueda, facturas:",e.length),e)),S(e=>{throw console.error("\u274C FacturasService: Error en FETCH DIRECTO para b\xFAsqueda:",e),e}))}fetchBuscarFacturasDirect(t){return E(this,null,function*(){console.log("\u{1F680} FacturasService: Ejecutando fetch directo para b\xFAsqueda de facturas...");try{let e=`${d.supabaseUrl}/rest/v1/facturas?select=*,cliente:clientes(*),aviso:avisos(*)&or=(numero_factura.ilike.*${t}*,nombre_cliente.ilike.*${t}*)&limit=10`,r={apikey:d.supabaseServiceKey,Authorization:`Bearer ${d.supabaseServiceKey}`,"Content-Type":"application/json"};console.log("\u{1F680} URL construida para b\xFAsqueda:",e);let o=Date.now(),s=yield fetch(e,{method:"GET",headers:r}),i=Date.now()-o;if(console.log("\u{1F680} Fetch completado en",i,"ms"),console.log("\u{1F680} Status:",s.status),!s.ok){let n=yield s.text();throw console.error("\u{1F680} Error response body:",n),new Error(`HTTP ${s.status}: ${s.statusText}`)}let a=yield s.json();return console.log("\u{1F680} Datos recibidos para b\xFAsqueda:",(a==null?void 0:a.length)||0,"facturas"),a}catch(e){throw console.error("\u{1F680} Error en fetch directo para b\xFAsqueda:",e),e}})}buscarFacturas(t){return u(this.getSupabaseClient().from("facturas").select(`
          *,
          cliente:clientes(*),
          aviso:avisos(*)
        `).or(`numero_factura.ilike.%${t}%,nombre_cliente.ilike.%${t}%`).limit(10)).pipe(f(({data:e,error:r})=>{if(r)throw r;return e}))}getFacturasPorEstado(t){return u(this.getSupabaseClient().from("facturas").select(`
          *,
          cliente:clientes(*),
          aviso:avisos(*)
        `).eq("estado",t).order("fecha_creacion",{ascending:!1})).pipe(f(({data:e,error:r})=>{if(r)throw r;return e}))}getFacturasPorCliente(t){return u(this.getSupabaseClient().from("facturas").select(`
          *,
          cliente:clientes(*),
          aviso:avisos(*)
        `).eq("cliente_id",t).order("fecha_creacion",{ascending:!1})).pipe(f(({data:e,error:r})=>{if(r)throw r;return e}))}getFacturasPorAviso(t){return u(this.getSupabaseClient().from("facturas").select(`
          *,
          cliente:clientes(*),
          aviso:avisos(*)
        `).eq("aviso_id",t).order("fecha_creacion",{ascending:!1})).pipe(f(({data:e,error:r})=>{if(r)throw r;return e}))}cambiarEstado(t,e){return u(this.getSupabaseClient().from("facturas").update({estado:e,fecha_actualizacion:new Date().toISOString()}).eq("id",t).select(`
          *,
          cliente:clientes(*),
          aviso:avisos(*)
        `).single()).pipe(f(({data:r,error:o})=>{if(o)throw o;let s=r,i=this.facturasSubject.value,a=i.findIndex(n=>n.id===t);return a!==-1&&(i[a]=s,this.facturasSubject.next([...i])),this.dataUpdateService.notifyUpdated("facturas"),s}))}getSiguienteNumero(){return u(this.getSupabaseClient().rpc("obtener_siguiente_numero_factura")).pipe(f(({data:t,error:e})=>e?(console.error("Error al obtener n\xFAmero de factura:",e),this.getSiguienteNumeroFallback()):t),S(t=>(console.error("Error en RPC, usando fallback:",t),this.getSiguienteNumeroFallback())))}getSiguienteNumeroFallback(){let t=new Date().getFullYear();return u(this.getSupabaseClient().from("facturas").select("numero_factura").like("numero_factura",`FAC-${t}-%`).order("numero_factura",{ascending:!1}).limit(1)).pipe(f(({data:e,error:r})=>{if(r)throw r;if(!e||e.length===0)return`FAC-${t}-001`;let s=e[0].numero_factura.match(/FAC-\d{4}-(\d{3})/);if(s){let i=parseInt(s[1])+1;return`FAC-${t}-${i.toString().padStart(3,"0")}`}return`FAC-${t}-001`}),I(()=>new Promise(e=>setTimeout(e,100))))}calcularTotales(t){return!t||!Array.isArray(t)||t.length===0?(console.warn("\u26A0\uFE0F No hay l\xEDneas de factura para calcular totales"),j({subtotal:0,iva:0,total:0})):this.configuracionService.getIvaPorDefecto().pipe(f(e=>{let r=t.reduce((i,a)=>{let n=a.cantidad||0,c=a.precio_pvp||0,l=n*c;return isNaN(l)||!isFinite(l)?(console.warn("\u26A0\uFE0F L\xEDnea con valores inv\xE1lidos:",a),i):i+l},0);if(isNaN(r)||!isFinite(r))return console.warn("\u26A0\uFE0F Subtotal calculado es inv\xE1lido, usando 0"),{subtotal:0,iva:0,total:0};let o=+(r*(e/100)).toFixed(2),s=+(r+o).toFixed(2);return console.log("\u{1F9EE} C\xE1lculo de totales:",{lineas:t.length,subtotal:r,iva:o,total:s,ivaPorcentaje:e}),{subtotal:r,iva:o,total:s}}))}getFacturasActuales(){return this.facturasSubject.value}limpiarFacturas(){this.facturasSubject.next([])}crearFacturaDesdePresupuesto(t){return u(this.getSupabaseClient().from("presupuestos").select(`
          *,
          aviso:avisos(
            *,
            cliente:clientes(*)
          ),
          materiales_estimados
        `).eq("id",t).single()).pipe(h(({data:e,error:r})=>{if(r)throw r;let o=e;if(o.estado!=="Completado")throw new Error("Solo se pueden facturar presupuestos aprobados");if(!o.aviso)throw new Error("El presupuesto no tiene un aviso asociado");return this.getSiguienteNumero().pipe(h(s=>{let i=[];return o.materiales_estimados&&Array.isArray(o.materiales_estimados)&&o.materiales_estimados.forEach(a=>{i.push({tipo:"repuesto",nombre:a.nombre||"Material desconocido",cantidad:a.cantidad||0,precio_neto:a.precio_neto||0,precio_pvp:a.precio_pvp||0,descripcion:`Material del presupuesto: ${a.descripcion||""}`})}),o.horas_estimadas&&o.horas_estimadas>0?this.configuracionService.getPrecioHoraManoObra().pipe(h(a=>(i.push({tipo:"mano_obra",nombre:"Mano de obra",cantidad:o.horas_estimadas,precio_pvp:a,descripcion:`${o.horas_estimadas} horas de trabajo t\xE9cnico`}),this.calcularTotales(i))),h(a=>this.crearFacturaConDatos(o,s,i,a,t))):this.calcularTotales(i).pipe(h(a=>this.crearFacturaConDatos(o,s,i,a,t)))}))}),S(e=>{throw console.error("Error al crear factura desde presupuesto:",e),e}))}crearFacturaConDatos(t,e,r,o,s){let i=o.subtotal||0,a=o.iva||0,n=o.total||0;console.log("\u{1F4CA} Totales calculados:",{subtotal:i,iva:a,total:n});let c=t.aviso.cliente,l={numero_factura:e,fecha_emision:new Date().toISOString().split("T")[0],cliente_id:c==null?void 0:c.id,nombre_cliente:(c==null?void 0:c.nombre_completo)||t.aviso.nombre_cliente_aviso||"Cliente",direccion_cliente:(c==null?void 0:c.direccion)||t.aviso.direccion_cliente_aviso||"Sin direcci\xF3n",cif_cliente:(c==null?void 0:c.cif)||"Sin CIF",email_cliente:(c==null?void 0:c.email)||"sin-email@ejemplo.com",aviso_id:t.aviso_id,subtotal:i,iva:a,total:n,estado:"Pendiente",notas:`Factura generada desde presupuesto ${s}`,lineas:r};return console.log("\u{1F4CB} Datos de factura a crear:",l),this.crearFactura(l).pipe(h(m=>u(this.getSupabaseClient().from("presupuestos").update({estado:"Facturado",fecha_actualizacion:new Date().toISOString()}).eq("id",s)).pipe(f(()=>m))))}getPresupuestosListosParaFacturar(){return u(this.getSupabaseClient().from("presupuestos").select(`
          *,
          aviso:avisos(
            *,
            cliente:clientes(*)
          )
        `).eq("estado","Completado").order("fecha_creacion",{ascending:!1})).pipe(f(({data:t,error:e})=>{if(e)throw e;return t||[]}))}};F.\u0275fac=function(e){return new(e||F)(T(U),T(k),T(x),T(O))},F.\u0275prov=A({token:F,factory:F.\u0275fac,providedIn:"root"});let D=F;return D})();export{B as a};
