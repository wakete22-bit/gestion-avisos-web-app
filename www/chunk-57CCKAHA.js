import{b as f}from"./chunk-EZQHEP6E.js";import{$a as v,B as m,E as h,ab as A,c as d,e as n,i as l,p as w}from"./chunk-YCXETNVK.js";import{a as p,b as S,k as s}from"./chunk-CRC5ZNR6.js";var U=(()=>{let o=class o{constructor(e){this.supabaseClientService=e,this.usuariosSubject=new d([]),this.usuarios$=this.usuariosSubject.asObservable(),this.supabase=this.supabaseClientService.getClient()}getUsuarios(){return n(this.supabase.from("usuarios").select(`
          *,
          rol:roles(*)
        `).order("fecha_creacion",{ascending:!1})).pipe(l(({data:e,error:t})=>{if(t)throw t;let r=e;return this.usuariosSubject.next(r),r}),w(e=>{throw console.error("Error al obtener usuarios:",e),e}))}getUsuario(e){return n(this.supabase.from("usuarios").select(`
          *,
          rol:roles(*)
        `).eq("id",e).single()).pipe(l(({data:t,error:r})=>{if(r)throw r;return t}))}crearUsuario(e){let t={id:e.id,nombre_completo:e.nombre_completo,email:e.email,telefono:e.telefono,rol_id:e.rol_id||"default-role-id",fecha_creacion:new Date().toISOString(),es_activo:!0};return n(this.supabase.from("usuarios").insert([t]).select(`
          *,
          rol:roles(*)
        `).single()).pipe(l(({data:r,error:a})=>{if(a)throw a;let i=r,u=this.usuariosSubject.value;return this.usuariosSubject.next([i,...u]),i}))}actualizarUsuario(e,t){let r=S(p({},t),{fecha_actualizacion:new Date().toISOString()});return n(this.supabase.from("usuarios").update(r).eq("id",e).select(`
          *,
          rol:roles(*)
        `).single()).pipe(l(({data:a,error:i})=>{if(i)throw i;let u=a,b=this.usuariosSubject.value,g=b.findIndex(j=>j.id===e);return g!==-1&&(b[g]=u,this.usuariosSubject.next([...b])),u}))}desactivarUsuario(e){return n(this.supabase.from("usuarios").update({es_activo:!1,fecha_actualizacion:new Date().toISOString()}).eq("id",e)).pipe(l(({error:t})=>{if(t)throw t;let r=this.usuariosSubject.value,a=r.findIndex(i=>i.id===e);a!==-1&&(r[a].es_activo=!1,this.usuariosSubject.next([...r]))}))}getUsuariosActuales(){return this.usuariosSubject.value}limpiarUsuarios(){this.usuariosSubject.next([])}};o.\u0275fac=function(t){return new(t||o)(h(f))},o.\u0275prov=m({token:o,factory:o.\u0275fac,providedIn:"root"});let c=o;return c})();var C=(()=>{let o=class o{constructor(e,t,r){this.http=e,this.usuariosService=t,this.supabaseClientService=r,this.currentUserSubject=new d(null),this.currentUser$=this.currentUserSubject.asObservable(),this.isAuthenticatedSubject=new d(!1),this.isAuthenticated$=this.isAuthenticatedSubject.asObservable(),this.TOKEN_KEY="auth_token",this.USER_KEY="current_user",this.isInitializing=!1,this.supabase=this.supabaseClientService.getClient(),this.initializeAuth()}initializeAuth(){return s(this,null,function*(){if(this.isInitializing){console.log("\u{1F527} AuthService: Ya se est\xE1 inicializando, esperando...");return}this.isInitializing=!0;try{console.log("\u{1F527} AuthService: Iniciando autenticaci\xF3n..."),yield this.clearProblematicLocks(),yield this.loadStoredAuth(),this.setupAuthListener(),console.log("\u{1F527} AuthService: Inicializaci\xF3n completada")}catch(e){console.error("\u274C AuthService: Error en inicializaci\xF3n:",e),this.clearAuth()}finally{this.isInitializing=!1}})}clearProblematicLocks(){return s(this,null,function*(){try{localStorage.getItem("supabase_lock_issue")&&(console.log("\u{1F527} AuthService: Detectados problemas de locks, limpiando..."),localStorage.removeItem("supabase_lock_issue"),Object.keys(localStorage).filter(r=>r.includes("supabase")||r.includes("sb-")).forEach(r=>{localStorage.removeItem(r),console.log(`\u{1F527} AuthService: Eliminado ${r}`)}))}catch(e){console.warn("\u26A0\uFE0F AuthService: Error al limpiar locks:",e)}})}loadStoredAuth(){return s(this,null,function*(){try{console.log("\u{1F527} AuthService: Cargando autenticaci\xF3n almacenada...");let e=this.supabase.auth.getSession(),t=new Promise((a,i)=>setTimeout(()=>i(new Error("Timeout getting session")),5e3)),{data:{session:r}}=yield Promise.race([e,t]);r!=null&&r.user?(console.log("\u{1F527} AuthService: Sesi\xF3n encontrada, cargando datos del usuario..."),yield this.loadUserData(r.user.id)):console.log("\u{1F527} AuthService: No hay sesi\xF3n almacenada")}catch(e){console.error("\u274C AuthService: Error loading stored auth:",e),e instanceof Error&&e.message.includes("NavigatorLockAcquireTimeoutError")&&(localStorage.setItem("supabase_lock_issue","true"),console.log("\u{1F527} AuthService: Problema de Navigator Lock detectado")),this.clearAuth()}})}setupAuthListener(){this.supabase.auth.onAuthStateChange((e,t)=>s(this,null,function*(){var r;console.log("Auth state change:",e,(r=t==null?void 0:t.user)==null?void 0:r.id),e==="SIGNED_IN"&&(t!=null&&t.user)?yield this.loadUserData(t.user.id):e==="SIGNED_OUT"?this.clearAuth():e==="TOKEN_REFRESHED"&&(t!=null&&t.user)&&(yield this.loadUserData(t.user.id))}))}loadUserData(e){return s(this,null,function*(){try{console.log("\u{1F527} AuthService: Cargando datos del usuario:",e);try{let t=yield this.usuariosService.getUsuario(e).toPromise();console.log("\u{1F527} AuthService: Usuario encontrado en BD:",t),this.currentUserSubject.next(t||null),this.isAuthenticatedSubject.next(!0),console.log("\u{1F527} AuthService: Usuario cargado exitosamente desde BD")}catch(t){console.warn("\u26A0\uFE0F AuthService: Usuario no encontrado en BD, esperando a que se complete la creaci\xF3n:",t),yield new Promise(r=>setTimeout(r,3e3));try{let r=yield this.usuariosService.getUsuario(e).toPromise();console.log("\u{1F527} AuthService: Usuario encontrado despu\xE9s de esperar:",r),this.currentUserSubject.next(r||null),this.isAuthenticatedSubject.next(!0),console.log("\u{1F527} AuthService: Usuario cargado exitosamente despu\xE9s de esperar")}catch(r){console.error("\u274C AuthService: Usuario no encontrado despu\xE9s de esperar, creando usuario por defecto:",r);let a={id:e,nombre_completo:"Usuario",email:"usuario@example.com",telefono:"",rol_id:"default-role-id",rol:{id:"default-role-id",nombre_rol:"Cliente",descripcion:"",permisos:[],es_activo:!0,fecha_creacion:new Date,fecha_actualizacion:new Date},es_activo:!0,fecha_creacion:new Date};console.log("\u{1F527} AuthService: Usuario por defecto creado:",a),this.currentUserSubject.next(a),this.isAuthenticatedSubject.next(!0),console.log("\u{1F527} AuthService: Usuario por defecto cargado exitosamente")}}}catch(t){console.error("\u274C AuthService: Error loading user data:",t),this.clearAuth()}})}login(e){return s(this,null,function*(){var t;try{let{data:r,error:a}=yield this.supabase.auth.signInWithPassword({email:e.email,password:e.password});if(a)throw a;if(r.user)return yield this.loadUserData(r.user.id),{usuario:this.currentUserSubject.value,token:((t=r.session)==null?void 0:t.access_token)||""};throw new Error("No se pudo obtener informaci\xF3n del usuario")}catch(r){throw console.error("Error en login:",r),r}})}register(e){return s(this,null,function*(){var t;try{let{data:r,error:a}=yield this.supabase.auth.signUp({email:e.email,password:e.password,options:{data:{nombre_completo:e.nombre_completo,telefono:e.telefono}}});if(a)throw a;if(r.user){yield new Promise(u=>setTimeout(u,2e3));let i=S(p({},e),{id:r.user.id});try{yield this.usuariosService.crearUsuario(i).toPromise(),console.log("\u{1F527} AuthService: Usuario creado en tabla usuarios")}catch(u){console.warn("\u26A0\uFE0F AuthService: Error al crear usuario en tabla usuarios:",u)}return yield this.loadUserData(r.user.id),{usuario:this.currentUserSubject.value,token:((t=r.session)==null?void 0:t.access_token)||""}}throw new Error("No se pudo crear el usuario")}catch(r){throw console.error("Error en registro:",r),r}})}logout(){return s(this,null,function*(){yield this.supabase.auth.signOut(),this.clearAuth()})}refreshToken(){return s(this,null,function*(){var e;try{let{data:t,error:r}=yield this.supabase.auth.refreshSession();if(r)throw r;if(t.user)return yield this.loadUserData(t.user.id),{usuario:this.currentUserSubject.value,token:((e=t.session)==null?void 0:e.access_token)||""};throw new Error("No se pudo refrescar la sesi\xF3n")}catch(t){throw this.clearAuth(),t}})}getCurrentUser(){return this.currentUserSubject.value}isAuthenticated(){let e=this.isAuthenticatedSubject.value;return console.log("\u{1F527} AuthService: isAuthenticated() - Estado:",e),e}getToken(){return s(this,null,function*(){let{data:{session:e}}=yield this.supabase.auth.getSession(),t=(e==null?void 0:e.access_token)||null;return console.log("\u{1F527} AuthService: getToken() - Token obtenido:",t?"S\xCD":"NO"),t})}clearAuth(){this.currentUserSubject.next(null),this.isAuthenticatedSubject.next(!1)}getAuthHeaders(){return s(this,null,function*(){let e=yield this.getToken();return new v({"Content-Type":"application/json",Authorization:`Bearer ${e}`})})}isTokenExpired(){return s(this,null,function*(){let{data:{session:e}}=yield this.supabase.auth.getSession();return e?new Date(e.expires_at*1e3)<new Date:!0})}getCurrentSession(){return s(this,null,function*(){return yield this.supabase.auth.getSession()})}};o.\u0275fac=function(t){return new(t||o)(h(A),h(U),h(f))},o.\u0275prov=m({token:o,factory:o.\u0275fac,providedIn:"root"});let c=o;return c})();export{C as a};
