import{a as D}from"./chunk-TPFNBOPC.js";import{a as M}from"./chunk-XLBNYIMP.js";import{a as q}from"./chunk-E7WEDNUB.js";import{a as F}from"./chunk-AG44W7G2.js";import{b as z}from"./chunk-EZQHEP6E.js";import{B as _,E as j,c as g,e as u,i as o,l as E,p as m,v as l,x as v}from"./chunk-YCXETNVK.js";import{a as A,b as C,d as P}from"./chunk-CRC5ZNR6.js";var k=(()=>{let n=class n{constructor(a,e){this.inventarioService=a,this.supabaseClientService=e,this.materialesSubject=new g([]),this.materiales$=this.materialesSubject.asObservable(),this.supabase=this.supabaseClientService.getClient()}getMaterialesTrabajo(a){return u(this.supabase.from("materiales_trabajo").select(`
          *,
          material:inventario(*)
        `).eq("trabajo_id",a).order("id",{ascending:!0})).pipe(o(({data:e,error:t})=>{if(t)throw t;let r=e;return this.materialesSubject.next(r),r}),m(e=>{throw console.error("Error al obtener materiales del trabajo:",e),e}))}agregarMateriales(a,e){if(e.length===0)return u([[]]);let t=e.map(r=>({trabajo_id:a,material_id:r.material_id,cantidad_utilizada:r.cantidad_utilizada,precio_neto_al_momento:r.precio_neto_al_momento}));return u(this.supabase.from("materiales_trabajo").insert(t).select(`
          *,
          material:inventario(*)
        `)).pipe(l(({data:r,error:s})=>{if(s)throw s;let i=r,p=this.materialesSubject.value;this.materialesSubject.next([...p,...i]);let c=i.map(d=>{let b=d.material.cantidad_disponible-d.cantidad_utilizada;return this.inventarioService.actualizarStock(d.material_id,b)});return E(c).pipe(o(()=>i))}),m(r=>{throw console.error("Error al agregar materiales al trabajo:",r),r}))}actualizarMaterial(a,e){return u(this.supabase.from("materiales_trabajo").select(`
          *,
          material:inventario(*)
        `).eq("id",a).single()).pipe(l(({data:t,error:r})=>{if(r)throw r;let s=t,i=s.cantidad_utilizada,c=(e.cantidad_utilizada||i)-i,d={cantidad_utilizada:e.cantidad_utilizada,precio_neto_al_momento:e.precio_neto_al_momento};return u(this.supabase.from("materiales_trabajo").update(d).eq("id",a).select(`
              *,
              material:inventario(*)
            `).single()).pipe(l(({data:b,error:S})=>{if(S)throw S;let f=b,T=this.materialesSubject.value,x=T.findIndex(w=>w.id===a);if(x!==-1&&(T[x]=f,this.materialesSubject.next([...T])),c!==0){let w=s.material.cantidad_disponible-c;return this.inventarioService.actualizarStock(s.material_id,w).pipe(o(()=>f))}return u([f])}))}),m(t=>{throw console.error("Error al actualizar material:",t),t}))}eliminarMaterial(a){return u(this.supabase.from("materiales_trabajo").select(`
          *,
          material:inventario(*)
        `).eq("id",a).single()).pipe(l(({data:e,error:t})=>{if(t)throw t;let r=e;return u(this.supabase.from("materiales_trabajo").delete().eq("id",a)).pipe(l(({error:s})=>{if(s)throw s;let p=this.materialesSubject.value.filter(d=>d.id!==a);this.materialesSubject.next(p);let c=r.material.cantidad_disponible+r.cantidad_utilizada;return this.inventarioService.actualizarStock(r.material_id,c).pipe(o(()=>{}))}))}),m(e=>{throw console.error("Error al eliminar material:",e),e}))}eliminarMaterialesTrabajo(a){return u(this.supabase.from("materiales_trabajo").select(`
          *,
          material:inventario(*)
        `).eq("trabajo_id",a)).pipe(l(({data:e,error:t})=>{if(t)throw t;let r=e;return u(this.supabase.from("materiales_trabajo").delete().eq("trabajo_id",a)).pipe(l(({error:s})=>{if(s)throw s;let p=this.materialesSubject.value.filter(c=>c.trabajo_id!==a);if(this.materialesSubject.next(p),r.length>0){let c=r.map(d=>{let b=d.material.cantidad_disponible+d.cantidad_utilizada;return this.inventarioService.actualizarStock(d.material_id,b)});return E(c).pipe(o(()=>{}))}return u([void 0])}))}),m(e=>{throw console.error("Error al eliminar materiales del trabajo:",e),e}))}calcularCostoMateriales(a){return a.reduce((e,t)=>e+t.cantidad_utilizada*t.precio_neto_al_momento,0)}getMaterialesActuales(){return this.materialesSubject.value}limpiarMateriales(){this.materialesSubject.next([])}};n.\u0275fac=function(e){return new(e||n)(j(q),j(z))},n.\u0275prov=_({token:n,factory:n.\u0275fac,providedIn:"root"});let h=n;return h})();var y=(()=>{let n=class n{constructor(a,e){this.materialesTrabajoService=a,this.supabaseClientService=e,this.trabajosSubject=new g([]),this.trabajos$=this.trabajosSubject.asObservable(),this.supabase=this.supabaseClientService.getClient()}getTrabajosAviso(a,e=1,t=10){let r=(e-1)*t;return u(this.supabase.from("trabajos_realizados").select("*",{count:"exact"}).eq("aviso_id",a).order("fecha_trabajo",{ascending:!1}).range(r,r+t-1)).pipe(o(({data:s,error:i,count:p})=>{if(i)throw i;let c=s;return this.trabajosSubject.next(c),{trabajos:c,total:p||0,pagina:e,por_pagina:t}}),m(s=>{throw console.error("Error al obtener trabajos:",s),s}))}getTrabajo(a){return u(this.supabase.from("trabajos_realizados").select("*").eq("id",a).single()).pipe(l(({data:e,error:t})=>{if(t)throw t;let r=e;return this.materialesTrabajoService.getMaterialesTrabajo(a).pipe(o(s=>({trabajo:r,materiales:s})))}),m(e=>{throw console.error("Error al obtener trabajo:",e),e}))}crearTrabajo(a){let s=a,{materiales:e}=s,t=P(s,["materiales"]),r=C(A({},t),{fecha_creacion:new Date().toISOString(),fecha_actualizacion:new Date().toISOString()});return u(this.supabase.from("trabajos_realizados").insert([r]).select().single()).pipe(l(({data:i,error:p})=>{if(p)throw p;let c=i,d=this.trabajosSubject.value;return this.trabajosSubject.next([c,...d]),!e||e.length===0?u([{trabajo:c,materiales:[]}]):this.materialesTrabajoService.agregarMateriales(c.id,e).pipe(o(b=>({trabajo:c,materiales:b})))}),m(i=>{throw console.error("Error al crear trabajo:",i),i}))}actualizarTrabajo(a,e){let i=e,{materiales:t}=i,r=P(i,["materiales"]),s=C(A({},r),{fecha_actualizacion:new Date().toISOString()});return u(this.supabase.from("trabajos_realizados").update(s).eq("id",a).select().single()).pipe(l(({data:p,error:c})=>{if(c)throw c;let d=p,b=this.trabajosSubject.value,S=b.findIndex(f=>f.id===a);return S!==-1&&(b[S]=d,this.trabajosSubject.next([...b])),t?this.materialesTrabajoService.eliminarMaterialesTrabajo(a).pipe(l(()=>t.length===0?u([{trabajo:d,materiales:[]}]):this.materialesTrabajoService.agregarMateriales(a,t).pipe(o(f=>({trabajo:d,materiales:f}))))):this.getTrabajo(a)}),m(p=>{throw console.error("Error al actualizar trabajo:",p),p}))}eliminarTrabajo(a){return this.materialesTrabajoService.eliminarMaterialesTrabajo(a).pipe(l(()=>u(this.supabase.from("trabajos_realizados").delete().eq("id",a))),o(({error:e})=>{if(e)throw e;let r=this.trabajosSubject.value.filter(s=>s.id!==a);this.trabajosSubject.next(r)}),m(e=>{throw console.error("Error al eliminar trabajo:",e),e}))}getEstadisticasTrabajos(a){return u(this.supabase.from("trabajos_realizados").select("*").eq("aviso_id",a)).pipe(o(({data:e,error:t})=>{if(t)throw t;let r=e;return{totalTrabajos:r.length,trabajosCompletados:r.filter(i=>i.estado==="Completado").length,trabajosPendientes:r.filter(i=>i.estado==="Pendiente").length,trabajosEnCurso:r.filter(i=>i.estado==="En curso").length,trabajosCancelados:r.filter(i=>i.estado==="Cancelado").length,totalHoras:r.reduce((i,p)=>{let c=new Date(`2000-01-01T${p.hora_inicio}`),b=(new Date(`2000-01-01T${p.hora_fin}`).getTime()-c.getTime())/(1e3*60*60);return i+Math.max(0,b)},0)}}))}getTrabajosActuales(){return this.trabajosSubject.value}limpiarTrabajos(){this.trabajosSubject.next([]),this.materialesTrabajoService.limpiarMateriales()}};n.\u0275fac=function(e){return new(e||n)(j(k),j(z))},n.\u0275prov=_({token:n,factory:n.\u0275fac,providedIn:"root"});let h=n;return h})();var W=(()=>{let n=class n{constructor(a,e,t,r){this.avisosService=a,this.facturasService=e,this.presupuestosService=t,this.trabajosService=r}obtenerEstadoFlujo(a){return this.avisosService.getResumenCompletoAviso(a).pipe(o(e=>({avisoId:a,estadoActual:e.estado,puedeCrearPresupuesto:this.puedeCrearPresupuesto(e),puedeAprobarPresupuesto:this.puedeAprobarPresupuesto(e),puedeFacturarPresupuesto:this.puedeFacturarPresupuesto(e),puedeFacturarTrabajos:this.puedeFacturarTrabajos(e),puedeCompletarAviso:this.puedeCompletarAviso(e),resumen:e})))}ejecutarFlujoCompleto(a,e=!0){return e?this.flujoConPresupuesto(a):this.flujoDirectoSinPresupuesto(a)}flujoDirectoSinPresupuesto(a){return this.avisosService.actualizarAviso(a,{estado:"En curso",requiere_presupuesto:!1}).pipe(v(()=>console.log("\u2705 Aviso actualizado para trabajo directo")),l(()=>this.avisosService.getResumenCompletoAviso(a)),o(e=>({paso:"flujo_directo_iniciado",avisoId:a,mensaje:"Flujo directo iniciado. El t\xE9cnico puede comenzar a trabajar.",resumen:e})))}flujoConPresupuesto(a){return this.avisosService.actualizarAviso(a,{estado:"Pendiente de presupuesto",requiere_presupuesto:!0}).pipe(v(()=>console.log("\u2705 Aviso marcado como requiere presupuesto")),l(()=>this.presupuestosService.crearPresupuesto({aviso_id:a,horas_estimadas:2,total_estimado:0})),v(()=>console.log("\u2705 Presupuesto creado")),o(e=>({paso:"presupuesto_creado",avisoId:a,presupuestoId:e.id,mensaje:"Presupuesto creado. Pendiente de evaluaci\xF3n y aprobaci\xF3n.",presupuesto:e})))}aprobarPresupuesto(a){return this.presupuestosService.cambiarEstado(a,"Completado").pipe(l(e=>this.avisosService.actualizarAviso(e.aviso_id,{estado:"En curso"})),v(()=>console.log("\u2705 Presupuesto aprobado y aviso en curso")),o(e=>({paso:"presupuesto_aprobado",avisoId:e.id,mensaje:"Presupuesto aprobado. El t\xE9cnico puede comenzar a trabajar.",aviso:e})))}facturarPresupuesto(a){return this.facturasService.crearFacturaDesdePresupuesto(a).pipe(v(()=>console.log("\u2705 Factura creada desde presupuesto")),l(e=>this.avisosService.actualizarEstadoAutomatico(e.factura.aviso_id).pipe(o(()=>e))),o(e=>({paso:"factura_desde_presupuesto",avisoId:e.factura.aviso_id,facturaId:e.factura.id,mensaje:"Factura generada autom\xE1ticamente desde presupuesto aprobado.",factura:e})))}facturarTrabajos(a){return this.avisosService.crearFacturaDesdeTrabajos(a).pipe(l(e=>{let t=this.convertirDatosAFactura(e);return this.facturasService.crearFactura(t).pipe(o(r=>({datosFactura:e,factura:r})))}),v(()=>console.log("\u2705 Factura creada desde trabajos")),l(({factura:e})=>this.avisosService.actualizarEstadoAutomatico(a).pipe(o(()=>e))),o(e=>({paso:"factura_desde_trabajos",avisoId:a,facturaId:e.factura.id,mensaje:"Factura generada autom\xE1ticamente desde trabajos realizados.",factura:e})))}obtenerAccionesDisponibles(a){return this.obtenerEstadoFlujo(a).pipe(o(e=>{let t=[];return e.puedeCrearPresupuesto&&t.push("crear_presupuesto"),e.puedeAprobarPresupuesto&&t.push("aprobar_presupuesto"),e.puedeFacturarPresupuesto&&t.push("facturar_presupuesto"),e.puedeFacturarTrabajos&&t.push("facturar_trabajos"),e.puedeCompletarAviso&&t.push("completar_aviso"),t}))}puedeCrearPresupuesto(a){return a.estado==="No visitado"||a.estado==="Visitado pendiente"}puedeAprobarPresupuesto(a){var e;return a.estadisticas.tienePresupuesto&&((e=a.presupuesto)==null?void 0:e.estado)==="Pendiente"}puedeFacturarPresupuesto(a){var e;return a.estadisticas.tienePresupuesto&&((e=a.presupuesto)==null?void 0:e.estado)==="Completado"}puedeFacturarTrabajos(a){return a.estadisticas.trabajosCompletados>0&&a.estadisticas.facturasPendientes===0}puedeCompletarAviso(a){return a.estadisticas.trabajosCompletados>0&&(a.estadisticas.totalFacturas>0||!a.requiere_presupuesto)}convertirDatosAFactura(a){let e=[...a.resumen.materiales.map(r=>({tipo:"repuesto",nombre:r.nombre,cantidad:r.cantidad_total,precio_pvp:r.precio_unitario,descripcion:r.descripcion})),...a.resumen.horasTotales>0?[{tipo:"mano_obra",nombre:"Mano de obra t\xE9cnica",cantidad:a.resumen.horasTotales,precio_pvp:50,descripcion:`${a.resumen.horasTotales} horas de trabajo t\xE9cnico`}]:[]],t=this.facturasService.calcularTotales(e);return{numero_factura:"",fecha_emision:new Date().toISOString().split("T")[0],cliente_id:a.cliente.id,nombre_cliente:a.cliente.nombre_completo,direccion_cliente:a.cliente.direccion,cif_cliente:a.cliente.cif||"Sin CIF",email_cliente:a.cliente.email,aviso_id:a.avisoId,subtotal:t.subtotal,iva:t.iva,total:t.total,estado:"Pendiente",notas:`Factura generada desde ${a.resumen.numeroTrabajos} trabajo(s) realizado(s)`,lineas:e}}};n.\u0275fac=function(e){return new(e||n)(j(F),j(D),j(M),j(y))},n.\u0275prov=_({token:n,factory:n.\u0275fac,providedIn:"root"});let h=n;return h})();export{y as a,W as b};
