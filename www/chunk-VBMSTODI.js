import{a as _}from"./chunk-KH26CASC.js";import{D as k,G as S,Sc as j,d as w,f as s,k as d,r as g}from"./chunk-EYPZOMIL.js";import{a as f,b}from"./chunk-CRC5ZNR6.js";var y=(()=>{let l=class l{constructor(e,t){this.supabaseClientService=e,this.dataUpdateService=t,this.inventarioSubject=new w([]),this.inventario$=this.inventarioSubject.asObservable(),this.supabase=this.supabaseClientService.getClient()}getInventario(e=1,t=10,i,r,n,a=!1){let o=this.supabase.from("inventario").select("*",{count:"exact"});i&&(o=o.or(`nombre.ilike.%${i}%,descripcion.ilike.%${i}%,codigo.ilike.%${i}%`)),a&&(o=o.gt("cantidad_disponible",0));let c=(e-1)*t;return o=o.range(c,c+t-1).order(r||"fecha_creacion",{ascending:n==="asc"}),s(o).pipe(d(({data:u,error:p,count:h})=>{if(p)throw p;let m=u;return this.inventarioSubject.next(m),{inventario:m,total:h||0,pagina:e,por_pagina:t}}),g(u=>{throw console.error("Error al obtener inventario:",u),u}))}getProducto(e){return s(this.supabase.from("inventario").select("*").eq("id",e).single()).pipe(d(({data:t,error:i})=>{if(i)throw i;return t}))}getProductoPorCodigo(e){return s(this.supabase.from("inventario").select("*").eq("codigo",e).single()).pipe(d(({data:t,error:i})=>{if(i)throw i;return t}))}crearProducto(e){let t=b(f({},e),{fecha_creacion:new Date().toISOString(),fecha_actualizacion:new Date().toISOString()});return s(this.supabase.from("inventario").insert([t]).select().single()).pipe(d(({data:i,error:r})=>{if(r)throw r;let n=i,a=this.inventarioSubject.value;return this.inventarioSubject.next([n,...a]),this.dataUpdateService.notifyCreated("inventario"),n}))}actualizarProducto(e,t){let i=b(f({},t),{fecha_actualizacion:new Date().toISOString()});return s(this.supabase.from("inventario").update(i).eq("id",e).select().single()).pipe(d(({data:r,error:n})=>{if(n)throw n;let a=r,o=this.inventarioSubject.value,c=o.findIndex(u=>u.id===e);return c!==-1&&(o[c]=a,this.inventarioSubject.next([...o])),this.dataUpdateService.notifyUpdated("inventario"),a}))}eliminarProducto(e){return s(this.supabase.from("inventario").delete().eq("id",e)).pipe(d(({error:t})=>{if(t)throw t;let r=this.inventarioSubject.value.filter(n=>n.id!==e);this.inventarioSubject.next(r),this.dataUpdateService.notifyDeleted("inventario")}))}buscarProductos(e){return s(this.supabase.from("inventario").select("*").or(`nombre.ilike.%${e}%,descripcion.ilike.%${e}%,codigo.ilike.%${e}%`).order("fecha_creacion",{ascending:!1}).limit(10)).pipe(d(({data:t,error:i})=>{if(i)throw i;return t}))}getProductosStockBajo(){return s(this.supabase.from("inventario").select("*").lt("cantidad_disponible",5).gt("cantidad_disponible",0).order("cantidad_disponible",{ascending:!0})).pipe(d(({data:e,error:t})=>{if(t)throw t;return e}))}getProductosSinStock(){return s(this.supabase.from("inventario").select("*").eq("cantidad_disponible",0).order("nombre",{ascending:!0})).pipe(d(({data:e,error:t})=>{if(t)throw t;return e}))}actualizarStock(e,t){return this.actualizarProducto(e,{cantidad_disponible:t})}generarCodigoProducto(){let e=Date.now().toString(),t=Math.random().toString(36).substring(2,8).toUpperCase();return`P${e.slice(-6)}${t}`}verificarCodigoExistente(e){return s(this.supabase.from("inventario").select("codigo").eq("codigo",e).limit(1)).pipe(d(({data:t,error:i})=>{if(i)throw i;return t&&t.length>0}))}getEstadisticas(){return s(this.supabase.from("inventario").select("cantidad_disponible")).pipe(d(({data:e,error:t})=>{if(t)throw t;let i=e,r=i.length,n=i.filter(c=>c.cantidad_disponible>0).length,a=r-n,o=i.reduce((c,u)=>c+u.cantidad_disponible,0);return{totalProductos:r,productosConStock:n,productosSinStock:a,stockTotal:o}}))}getInventarioActual(){return this.inventarioSubject.value}limpiarInventario(){this.inventarioSubject.next([])}getProductosConStock(e=1,t=10,i,r,n){return this.getInventario(e,t,i,r,n,!0)}getProductosSinStockPaginated(e=1,t=10,i,r,n){let a=this.supabase.from("inventario").select("*",{count:"exact"}).eq("cantidad_disponible",0);i&&(a=a.or(`nombre.ilike.%${i}%,descripcion.ilike.%${i}%,codigo.ilike.%${i}%`));let o=(e-1)*t;return a=a.range(o,o+t-1).order(r||"fecha_creacion",{ascending:n==="asc"}),s(a).pipe(d(({data:c,error:u,count:p})=>{if(u)throw u;let h=c;return this.inventarioSubject.next(h),{inventario:h,total:p||0,pagina:e,por_pagina:t}}),g(c=>{throw console.error("Error al obtener productos sin stock:",c),c}))}};l.\u0275fac=function(t){return new(t||l)(S(j),S(_))},l.\u0275prov=k({token:l,factory:l.\u0275fac,providedIn:"root"});let v=l;return v})();export{y as a};
