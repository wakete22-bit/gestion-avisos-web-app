import{a as y}from"./chunk-Q5TPT4RW.js";import{a as M}from"./chunk-7JXIQDSA.js";import{a as $}from"./chunk-DBF2D4ZP.js";import{a as F}from"./chunk-GVEUVWXM.js";import{a as x}from"./chunk-S7IKXOHM.js";import{D as S,G as h,Qc as A,d as z,f as l,k as u,n as _,r as m,x as c,z as j}from"./chunk-6H2HYE5V.js";import{a as T,b as E,d as P}from"./chunk-CRC5ZNR6.js";var R=(()=>{let d=class d{constructor(e,a){this.inventarioService=e,this.supabaseClientService=a,this.materialesSubject=new z([]),this.materiales$=this.materialesSubject.asObservable(),this.supabase=this.supabaseClientService.getClient()}getMaterialesTrabajo(e){return l(this.supabase.from("materiales_trabajo").select(`
          *,
          material:inventario(*)
        `).eq("trabajo_id",e).order("id",{ascending:!0})).pipe(u(({data:a,error:t})=>{if(t)throw t;let r=a;return this.materialesSubject.next(r),r}),m(a=>{throw console.error("Error al obtener materiales del trabajo:",a),a}))}agregarMateriales(e,a){if(a.length===0)return l([[]]);let t=a.map(r=>({trabajo_id:e,material_id:r.material_id,cantidad_utilizada:r.cantidad_utilizada,precio_neto_al_momento:r.precio_neto_al_momento}));return l(this.supabase.from("materiales_trabajo").insert(t).select(`
          *,
          material:inventario(*)
        `)).pipe(c(({data:r,error:i})=>{if(i)throw i;let o=r,n=this.materialesSubject.value;this.materialesSubject.next([...n,...o]);let s=o.map(p=>{let b=p.material.cantidad_disponible-p.cantidad_utilizada;return this.inventarioService.actualizarStock(p.material_id,b)});return _(s).pipe(u(()=>o))}),m(r=>{throw console.error("Error al agregar materiales al trabajo:",r),r}))}actualizarMaterial(e,a){return l(this.supabase.from("materiales_trabajo").select(`
          *,
          material:inventario(*)
        `).eq("id",e).single()).pipe(c(({data:t,error:r})=>{if(r)throw r;let i=t,o=i.cantidad_utilizada,s=(a.cantidad_utilizada||o)-o,p={cantidad_utilizada:a.cantidad_utilizada,precio_neto_al_momento:a.precio_neto_al_momento};return l(this.supabase.from("materiales_trabajo").update(p).eq("id",e).select(`
              *,
              material:inventario(*)
            `).single()).pipe(c(({data:b,error:g})=>{if(g)throw g;let v=b,w=this.materialesSubject.value,D=w.findIndex(C=>C.id===e);if(D!==-1&&(w[D]=v,this.materialesSubject.next([...w])),s!==0){let C=i.material.cantidad_disponible-s;return this.inventarioService.actualizarStock(i.material_id,C).pipe(u(()=>v))}return l([v])}))}),m(t=>{throw console.error("Error al actualizar material:",t),t}))}eliminarMaterial(e){return l(this.supabase.from("materiales_trabajo").select(`
          *,
          material:inventario(*)
        `).eq("id",e).single()).pipe(c(({data:a,error:t})=>{if(t)throw t;let r=a;return l(this.supabase.from("materiales_trabajo").delete().eq("id",e)).pipe(c(({error:i})=>{if(i)throw i;let n=this.materialesSubject.value.filter(p=>p.id!==e);this.materialesSubject.next(n);let s=r.material.cantidad_disponible+r.cantidad_utilizada;return this.inventarioService.actualizarStock(r.material_id,s).pipe(u(()=>{}))}))}),m(a=>{throw console.error("Error al eliminar material:",a),a}))}eliminarMaterialesTrabajo(e){return l(this.supabase.from("materiales_trabajo").select(`
          *,
          material:inventario(*)
        `).eq("trabajo_id",e)).pipe(c(({data:a,error:t})=>{if(t)throw t;let r=a;return l(this.supabase.from("materiales_trabajo").delete().eq("trabajo_id",e)).pipe(c(({error:i})=>{if(i)throw i;let n=this.materialesSubject.value.filter(s=>s.trabajo_id!==e);if(this.materialesSubject.next(n),r.length>0){let s=r.map(p=>{let b=p.material.cantidad_disponible+p.cantidad_utilizada;return this.inventarioService.actualizarStock(p.material_id,b)});return _(s).pipe(u(()=>{}))}return l([void 0])}))}),m(a=>{throw console.error("Error al eliminar materiales del trabajo:",a),a}))}calcularCostoMateriales(e){return e.reduce((a,t)=>a+t.cantidad_utilizada*t.precio_neto_al_momento,0)}getMaterialesActuales(){return this.materialesSubject.value}limpiarMateriales(){this.materialesSubject.next([])}};d.\u0275fac=function(a){return new(a||d)(h($),h(A))},d.\u0275prov=S({token:d,factory:d.\u0275fac,providedIn:"root"});let f=d;return f})();var k=(()=>{let d=class d{constructor(e,a,t){this.materialesTrabajoService=e,this.supabaseClientService=a,this.dataUpdateService=t,this.trabajosSubject=new z([]),this.trabajos$=this.trabajosSubject.asObservable(),this.supabase=this.supabaseClientService.getClient()}getTrabajosAviso(e){return l(this.supabase.from("trabajos_realizados").select(`
            *,
            materiales:materiales_trabajo(
              id,
              cantidad_utilizada,
              precio_neto_al_momento,
              material:inventario(
                id,
                nombre,
                unidad,
                precio_neto,
                pvp,
                codigo
              )
            )
          `).eq("aviso_id",e).order("fecha_creacion",{ascending:!1})).pipe(u(a=>{if(a.error)throw a.error;return{trabajos:a.data||[]}}))}getTrabajo(e){return l(this.supabase.from("trabajos_realizados").select("*").eq("id",e).single()).pipe(c(({data:a,error:t})=>{if(t)throw t;let r=a;return this.materialesTrabajoService.getMaterialesTrabajo(e).pipe(u(i=>({trabajo:r,materiales:i})))}),m(a=>{throw console.error("Error al obtener trabajo:",a),a}))}crearTrabajo(e){let i=e,{materiales:a}=i,t=P(i,["materiales"]),r=E(T({},t),{fecha_creacion:new Date().toISOString(),fecha_actualizacion:new Date().toISOString()});return l(this.supabase.from("trabajos_realizados").insert([r]).select().single()).pipe(c(({data:o,error:n})=>{if(n)throw n;let s=o,p=this.trabajosSubject.value;return this.trabajosSubject.next([s,...p]),this.dataUpdateService.notifyCreated("trabajos"),!a||a.length===0?l([{trabajo:s,materiales:[]}]):this.materialesTrabajoService.agregarMateriales(s.id,a).pipe(u(b=>({trabajo:s,materiales:b})))}),m(o=>{throw console.error("Error al crear trabajo:",o),o}))}actualizarTrabajo(e,a){let o=a,{materiales:t}=o,r=P(o,["materiales"]),i=E(T({},r),{fecha_actualizacion:new Date().toISOString()});return l(this.supabase.from("trabajos_realizados").update(i).eq("id",e).select().single()).pipe(c(({data:n,error:s})=>{if(s)throw s;let p=n,b=this.trabajosSubject.value,g=b.findIndex(v=>v.id===e);return g!==-1&&(b[g]=p,this.trabajosSubject.next([...b])),this.dataUpdateService.notifyUpdated("trabajos"),t?this.materialesTrabajoService.eliminarMaterialesTrabajo(e).pipe(c(()=>t.length===0?l([{trabajo:p,materiales:[]}]):this.materialesTrabajoService.agregarMateriales(e,t).pipe(u(v=>({trabajo:p,materiales:v}))))):this.getTrabajo(e)}),m(n=>{throw console.error("Error al actualizar trabajo:",n),n}))}eliminarTrabajo(e){return this.materialesTrabajoService.eliminarMaterialesTrabajo(e).pipe(c(()=>l(this.supabase.from("trabajos_realizados").delete().eq("id",e))),u(({error:a})=>{if(a)throw a;let r=this.trabajosSubject.value.filter(i=>i.id!==e);this.trabajosSubject.next(r),this.dataUpdateService.notifyDeleted("trabajos")}),m(a=>{throw console.error("Error al eliminar trabajo:",a),a}))}getEstadisticasTrabajos(e){return l(this.supabase.from("trabajos_realizados").select("*").eq("aviso_id",e)).pipe(u(({data:a,error:t})=>{if(t)throw t;let r=a;return{totalTrabajos:r.length,trabajosCompletados:r.filter(o=>o.estado==="Completado").length,trabajosPendientes:r.filter(o=>o.estado==="Pendiente").length,trabajosEnCurso:r.filter(o=>o.estado==="En curso").length,trabajosCancelados:r.filter(o=>o.estado==="Cancelado").length,totalHoras:r.reduce((o,n)=>{let s=new Date(`2000-01-01T${n.hora_inicio}`),b=(new Date(`2000-01-01T${n.hora_fin}`).getTime()-s.getTime())/(1e3*60*60);return o+Math.max(0,b)},0)}}))}getTrabajosActuales(){return this.trabajosSubject.value}limpiarTrabajos(){this.trabajosSubject.next([]),this.materialesTrabajoService.limpiarMateriales()}actualizarEstadoTrabajo(e,a,t){let r={estado:a,fecha_actualizacion:new Date().toISOString()};return t&&(r.albaran_id=t),l(this.supabase.from("trabajos_realizados").update(r).eq("id",e).select().single()).pipe(u(({data:i,error:o})=>{if(o)throw o;let n=i,s=this.trabajosSubject.value,p=s.findIndex(b=>b.id===e);return p!==-1&&(s[p]=n,this.trabajosSubject.next([...s])),this.dataUpdateService.notifyUpdated("trabajos"),n}),m(i=>{throw console.error("Error al actualizar estado del trabajo:",i),i}))}};d.\u0275fac=function(a){return new(a||d)(h(R),h(A),h(F))},d.\u0275prov=S({token:d,factory:d.\u0275fac,providedIn:"root"});let f=d;return f})();var Z=(()=>{let d=class d{constructor(e,a,t,r){this.avisosService=e,this.facturasService=a,this.presupuestosService=t,this.trabajosService=r}obtenerEstadoFlujo(e){return this.avisosService.getResumenCompletoAviso(e).pipe(u(a=>({avisoId:e,estadoActual:a.estado,puedeCrearPresupuesto:this.puedeCrearPresupuesto(a),puedeAprobarPresupuesto:this.puedeAprobarPresupuesto(a),puedeFacturarPresupuesto:this.puedeFacturarPresupuesto(a),puedeFacturarTrabajos:this.puedeFacturarTrabajos(a),puedeCompletarAviso:this.puedeCompletarAviso(a),resumen:a})))}ejecutarFlujoCompleto(e,a=!0){return a?this.flujoConPresupuesto(e):this.flujoDirectoSinPresupuesto(e)}flujoDirectoSinPresupuesto(e){return this.avisosService.actualizarAviso(e,{estado:"En curso",requiere_presupuesto:!1}).pipe(j(()=>console.log("\u2705 Aviso actualizado para trabajo directo")),c(()=>this.avisosService.getResumenCompletoAviso(e)),u(a=>({paso:"flujo_directo_iniciado",avisoId:e,mensaje:"Flujo directo iniciado. El t\xE9cnico puede comenzar a trabajar.",resumen:a})))}flujoConPresupuesto(e){return this.avisosService.actualizarAviso(e,{estado:"Pendiente de presupuesto",requiere_presupuesto:!0}).pipe(j(()=>console.log("\u2705 Aviso marcado como requiere presupuesto")),c(()=>this.presupuestosService.crearPresupuesto({aviso_id:e,horas_estimadas:2,total_estimado:0})),j(()=>console.log("\u2705 Presupuesto creado")),u(a=>({paso:"presupuesto_creado",avisoId:e,presupuestoId:a.id,mensaje:"Presupuesto creado. Pendiente de evaluaci\xF3n y aprobaci\xF3n.",presupuesto:a})))}aprobarPresupuesto(e){return this.presupuestosService.cambiarEstado(e,"Completado").pipe(c(a=>this.avisosService.actualizarAviso(a.aviso_id,{estado:"En curso"})),j(()=>console.log("\u2705 Presupuesto aprobado y aviso en curso")),u(a=>({paso:"presupuesto_aprobado",avisoId:a.id,mensaje:"Presupuesto aprobado. El t\xE9cnico puede comenzar a trabajar.",aviso:a})))}facturarPresupuesto(e){return this.facturasService.crearFacturaDesdePresupuesto(e).pipe(j(()=>console.log("\u2705 Factura creada desde presupuesto")),c(a=>this.avisosService.actualizarEstadoAutomatico(a.factura.aviso_id).pipe(u(()=>a))),u(a=>({paso:"factura_desde_presupuesto",avisoId:a.factura.aviso_id,facturaId:a.factura.id,mensaje:"Factura generada autom\xE1ticamente desde presupuesto aprobado.",factura:a})))}facturarTrabajos(e){return console.log("\u{1F527} Iniciando facturaci\xF3n de trabajos para aviso:",e),this.avisosService.getResumenCompletoAviso(e).pipe(c(a=>{var i;if(console.log("\u{1F527} Resumen completo obtenido:",a),!a.estadisticas.trabajosFinalizados)throw new Error("No hay trabajos finalizados para facturar. Debes crear un albar\xE1n primero.");let t=((i=a.trabajos)==null?void 0:i.filter(o=>{var n;return!o.albaran_id||!((n=o.albaran)!=null&&n.estado_cierre)||o.albaran.estado_cierre==="Otra visita"}))||[];if(t.length>0){let o=t.map(n=>{var s;return`Trabajo #${(s=n.id)==null?void 0:s.substring(0,8)} (${n.descripcion})`}).join(", ");throw new Error(`No se puede facturar. Los siguientes trabajos no tienen albaranes cerrados: ${o}. Debes cerrar todos los albaranes antes de facturar.`)}console.log("\u{1F527} Cliente del resumen:",a.cliente);let r=this.convertirDatosAFactura({avisoId:e,cliente:a.cliente,resumen:a});return this.facturasService.getSiguienteNumero().pipe(c(o=>(r.numero_factura=o,console.log("\u{1F527} N\xFAmero de factura generado:",o),this.facturasService.crearFactura(r))))}),j(()=>console.log("\u2705 Factura creada desde trabajos realizados")),c(()=>this.avisosService.getResumenCompletoAviso(e)),u(a=>({paso:"factura_creada_desde_trabajos",avisoId:e,mensaje:"Factura creada exitosamente desde trabajos realizados",resumen:a})))}verificarEstadoFactura(e,a){return this.avisosService.getResumenCompletoAviso(a).pipe(c(t=>t.estado==="Completado"?this.facturasService.cambiarEstado(e,"Completado"):t.estado==="Listo para facturar"?this.facturasService.cambiarEstado(e,"En curso"):l([{id:e,estado:"Pendiente"}])))}sincronizarEstadosFacturas(e){return this.avisosService.getResumenCompletoAviso(e).pipe(c(a=>{if(!a.facturas||a.facturas.length===0)return l([{mensaje:"No hay facturas para sincronizar"}]);let t;a.estado==="Completado"?t="Completado":a.estado==="Listo para facturar"?t="En curso":t="Pendiente";let r=a.facturas.map(i=>this.facturasService.cambiarEstado(i.id,t));return _(r).pipe(u(()=>({mensaje:`Estados de ${a.facturas.length} factura(s) sincronizados a "${t}"`,avisoId:e,nuevoEstado:t})))}))}completarAviso(e){return this.avisosService.getResumenCompletoAviso(e).pipe(c(a=>{var r;if(!this.puedeCompletarAviso(a))throw new Error("No se puede completar el aviso. Verifica que haya trabajos finalizados y facturas generadas.");let t=((r=a.trabajos)==null?void 0:r.filter(i=>{var o;return!i.albaran_id||!((o=i.albaran)!=null&&o.estado_cierre)||i.albaran.estado_cierre==="Otra visita"}))||[];if(t.length>0){let i=t.map(o=>{var n;return`Trabajo #${(n=o.id)==null?void 0:n.substring(0,8)} (${o.descripcion})`}).join(", ");throw new Error(`No se puede completar el aviso. Los siguientes trabajos no tienen albaranes cerrados: ${i}. Debes cerrar todos los albaranes antes de completar el aviso.`)}return this.avisosService.actualizarAviso(e,{estado:"Completado",fecha_finalizacion:new Date}).pipe(c(i=>{if(a.facturas&&a.facturas.length>0){let o=a.facturas.map(n=>this.facturasService.cambiarEstado(n.id,"Completado"));return _(o).pipe(u(()=>i))}return l([i])}))}),j(()=>console.log("\u2705 Aviso completado exitosamente")),c(()=>this.avisosService.getResumenCompletoAviso(e)),u(a=>({paso:"aviso_completado",avisoId:e,mensaje:"Aviso marcado como completado",resumen:a})))}obtenerAccionesDisponibles(e){return this.obtenerEstadoFlujo(e).pipe(u(a=>{let t=[];return a.puedeFacturarTrabajos&&t.push("facturar_trabajos"),a.puedeCompletarAviso&&t.push("completar_aviso"),t}))}puedeCrearPresupuesto(e){return!1}puedeAprobarPresupuesto(e){return!1}puedeFacturarPresupuesto(e){return!1}puedeFacturarTrabajos(e){var t;let a=((t=e.trabajos)==null?void 0:t.every(r=>{var i;return r.albaran_id&&((i=r.albaran)==null?void 0:i.estado_cierre)&&r.albaran.estado_cierre!=="Otra visita"}))||!1;return e.estadisticas.trabajosFinalizados>0&&e.estadisticas.facturasPendientes===0&&a}puedeCompletarAviso(e){var t;let a=((t=e.trabajos)==null?void 0:t.every(r=>{var i;return r.albaran_id&&((i=r.albaran)==null?void 0:i.estado_cierre)&&r.albaran.estado_cierre!=="Otra visita"}))||!1;return e.estadisticas.trabajosFinalizados>0&&e.estadisticas.totalFacturas>0&&a}convertirDatosAFactura(e){if(console.log("\u{1F527} Datos de factura recibidos:",e),!e.cliente||!e.cliente.id)throw new Error("Datos de cliente incompletos para crear factura");let a=[],t=0;e.resumen.albaranes&&e.resumen.albaranes.length>0&&e.resumen.albaranes.forEach(n=>{if(n.estado_cierre==="Finalizado"){let s=new Date(`2000-01-01T${n.hora_entrada}`),b=(new Date(`2000-01-01T${n.hora_salida}`).getTime()-s.getTime())/(1e3*60*60);t+=Math.max(0,b)}}),t>0&&a.push({tipo:"mano_obra",nombre:"Mano de obra",cantidad:t,precio_neto:50,precio_pvp:50,descripcion:`Trabajo realizado: ${t.toFixed(2)} horas`}),e.resumen.albaranes&&e.resumen.albaranes.length>0&&e.resumen.albaranes.forEach(n=>{n.estado_cierre==="Finalizado"&&n.repuestos_utilizados&&(console.log("\u{1F527} Procesando repuestos del albar\xE1n:",n.repuestos_utilizados),n.repuestos_utilizados.forEach(s=>{s&&typeof s=="object"&&s.cantidad?(console.log("\u{1F527} Repuesto con cantidad real:",s),a.push({tipo:"repuesto",nombre:s.nombre,cantidad:s.cantidad,precio_neto:s.precio_neto||0,precio_pvp:s.precio_pvp||s.precio_neto||0,descripcion:`Repuesto: ${s.nombre} - ${s.cantidad} ${s.unidad||"unidad"}`})):typeof s=="string"&&(console.log("\u26A0\uFE0F Repuesto en formato antiguo (sin cantidad):",s),a.push({tipo:"repuesto",nombre:s,cantidad:1,precio_neto:0,precio_pvp:0,descripcion:`Repuesto: ${s} (cantidad no especificada)`}))}))});let r=a.reduce((n,s)=>n+s.precio_pvp*s.cantidad,0),i=r*.21,o=r+i;return console.log("\u{1F527} L\xEDneas de factura generadas:",a),console.log("\u{1F527} Subtotal:",r,"IVA:",i,"Total:",o),{cliente_id:e.cliente.id,nombre_cliente:e.cliente.nombre_completo,direccion_cliente:e.cliente.direccion||"",cif_cliente:e.cliente.cif||"",email_cliente:e.cliente.email||"",aviso_id:e.aviso.id,subtotal:r,iva:i,total:o,lineas_factura:a}}};d.\u0275fac=function(a){return new(a||d)(h(x),h(y),h(M),h(k))},d.\u0275prov=S({token:d,factory:d.\u0275fac,providedIn:"root"});let f=d;return f})();export{k as a,Z as b};
