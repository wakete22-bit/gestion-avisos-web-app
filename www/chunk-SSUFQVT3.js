import{a as j}from"./chunk-N4FKO75N.js";import{a as p,b as z}from"./chunk-ZFUZ5UD4.js";import{A as C,E as y,H as w,d as P,f as u,j as l,r as S,y as D}from"./chunk-QQQKELKR.js";import{k as b}from"./chunk-CRC5ZNR6.js";var H=(()=>{let h=class h{constructor(s,e){this.supabaseClientService=s,this.dataUpdateService=e,this.presupuestosSubject=new P([]),this.presupuestos$=this.presupuestosSubject.asObservable()}getSupabaseClient(){return console.log("\u{1F4BC} PresupuestosService: Obteniendo cliente Supabase actualizado..."),this.supabaseClientService.getClient()}getPresupuestosDirect(s=1,e=10,t,i,r,a){return console.log("\u{1F680} PresupuestosService: Usando FETCH DIRECTO para presupuestos..."),u(this.fetchPresupuestosDirect(s,e,t,i,r,a)).pipe(l(o=>(console.log("\u2705 PresupuestosService: FETCH DIRECTO completado, presupuestos:",o.presupuestos.length),this.presupuestosSubject.next(o.presupuestos),o)),S(o=>{throw console.error("\u274C PresupuestosService: Error en FETCH DIRECTO:",o),o}))}fetchPresupuestosDirect(s=1,e=10,t,i,r,a){return b(this,null,function*(){console.log("\u{1F680} PresupuestosService: Ejecutando fetch directo para presupuestos...");try{let o=`${p.supabaseUrl}/rest/v1/presupuestos?select=*,aviso:avisos(*,cliente:clientes(*))`,c=[];t&&c.push(`or=(aviso.nombre_cliente_aviso.ilike.*${t}*,aviso.descripcion_problema.ilike.*${t}*)`),a&&c.push(`estado=eq.${a}`),c.length>0&&(o+="&"+c.join("&"));let n=(s-1)*e,f=n+e-1;o+=`&limit=${e}&offset=${n}`,o+=`&order=${i||"fecha_creacion"}.${r==="asc"?"asc":"desc"}`;let m={apikey:p.supabaseServiceKey,Authorization:`Bearer ${p.supabaseServiceKey}`,"Content-Type":"application/json",Prefer:"count=exact"};console.log("\u{1F680} URL construida:",o);let v=Date.now(),d=yield fetch(o,{method:"GET",headers:m}),$=Date.now()-v;if(console.log("\u{1F680} Fetch completado en",$,"ms"),console.log("\u{1F680} Status:",d.status),!d.ok){let x=yield d.text();throw console.error("\u{1F680} Error response body:",x),new Error(`HTTP ${d.status}: ${d.statusText}`)}let g=yield d.json(),_=d.headers.get("content-range"),T=_?parseInt(_.split("/")[1]):g.length;return console.log("\u{1F680} Datos recibidos:",(g==null?void 0:g.length)||0,"presupuestos, total:",T),{presupuestos:g,total:T,pagina:s,por_pagina:e}}catch(o){throw console.error("\u{1F680} Error en fetch directo:",o),o}})}getPresupuestos(s=1,e=10,t,i,r,a){let o=this.getSupabaseClient().from("presupuestos").select(`
        *,
        aviso:avisos(
          *,
          cliente:clientes(*)
        )
      `,{count:"exact"});t&&(o=o.or(`aviso.nombre_cliente_aviso.ilike.%${t}%`)),a&&(o=o.eq("estado",a));let c=(s-1)*e;return o=o.range(c,c+e-1).order(i||"fecha_creacion",{ascending:r==="asc"}),u(o).pipe(l(({data:n,error:f,count:m})=>{if(f)throw f;let v=n;return this.presupuestosSubject.next(v),{presupuestos:v,total:m||0,pagina:s,por_pagina:e}}),S(n=>{throw console.error("Error al obtener presupuestos:",n),n}))}getPresupuestoDirect(s){return console.log("\u{1F680} PresupuestosService: Usando FETCH DIRECTO para presupuesto individual..."),u(this.fetchPresupuestoDirect(s)).pipe(l(e=>(console.log("\u2705 PresupuestosService: FETCH DIRECTO completado para presupuesto individual"),e)),S(e=>{throw console.error("\u274C PresupuestosService: Error en FETCH DIRECTO para presupuesto individual:",e),e}))}fetchPresupuestoDirect(s){return b(this,null,function*(){console.log("\u{1F680} PresupuestosService: Ejecutando fetch directo para presupuesto individual...");try{let e=`${p.supabaseUrl}/rest/v1/presupuestos?select=*,aviso:avisos(*,cliente:clientes(*)),albaran:albaranes(*),materiales_estimados&id=eq.${s}`,t={apikey:p.supabaseServiceKey,Authorization:`Bearer ${p.supabaseServiceKey}`,"Content-Type":"application/json"};console.log("\u{1F680} URL construida para presupuesto individual:",e);let i=Date.now(),r=yield fetch(e,{method:"GET",headers:t}),a=Date.now()-i;if(console.log("\u{1F680} Fetch completado en",a,"ms"),console.log("\u{1F680} Status:",r.status),!r.ok){let c=yield r.text();throw console.error("\u{1F680} Error response body:",c),new Error(`HTTP ${r.status}: ${r.statusText}`)}let o=yield r.json();if(!o||o.length===0)throw new Error("Presupuesto no encontrado");return console.log("\u{1F680} Datos recibidos para presupuesto individual:",o[0]),o[0]}catch(e){throw console.error("\u{1F680} Error en fetch directo para presupuesto individual:",e),e}})}getPresupuesto(s){return console.log("Servicio: Buscando presupuesto con ID:",s),u(this.getSupabaseClient().from("presupuestos").select(`
          *,
          aviso:avisos(
            *,
            cliente:clientes(*)
          ),
          albaran:albaranes(*),
          materiales_estimados
        `).eq("id",s).single()).pipe(l(({data:e,error:t})=>{if(console.log("Servicio: Respuesta de Supabase:",{data:e,error:t}),t)throw t;return e}))}crearPresupuesto(s){let e={aviso_id:s.aviso_id,horas_estimadas:s.horas_estimadas,horas_desplazamiento:s.horas_desplazamiento||0,precio_hora_desplazamiento:s.precio_hora_desplazamiento||0,total_estimado:s.total_estimado,fecha_creacion:new Date().toISOString(),estado:"Pendiente"};return s.albaran_id&&(e.albaran_id=s.albaran_id),s.materiales&&s.materiales.length>0&&(e.materiales_estimados=s.materiales),console.log("Servicio: Creando presupuesto con datos:",e),u(this.getSupabaseClient().from("presupuestos").insert([e]).select(`
          *,
          aviso:avisos(
            *,
            cliente:clientes(*)
          )
        `).single()).pipe(D(({data:t,error:i})=>{if(i)throw i;let r=t,a=this.presupuestosSubject.value;return this.presupuestosSubject.next([r,...a]),this.dataUpdateService.notifyCreated("presupuestos"),u([r])}))}actualizarPresupuestoDirect(s,e){return console.log("\u{1F680} PresupuestosService: Usando FETCH DIRECTO para actualizar presupuesto..."),u(this.fetchActualizarPresupuestoDirect(s,e)).pipe(l(t=>(console.log("\u2705 PresupuestosService: FETCH DIRECTO completado, presupuesto actualizado:",t.id),t)),S(t=>{throw console.error("\u274C PresupuestosService: Error en FETCH DIRECTO:",t),t}))}fetchActualizarPresupuestoDirect(s,e){return b(this,null,function*(){console.log("\u{1F680} PresupuestosService: Ejecutando fetch directo para actualizar presupuesto:",s);try{let t={fecha_actualizacion:new Date().toISOString()};e.aviso_id!==void 0&&(t.aviso_id=e.aviso_id),e.horas_estimadas!==void 0&&(t.horas_estimadas=e.horas_estimadas),e.horas_desplazamiento!==void 0&&(t.horas_desplazamiento=e.horas_desplazamiento),e.precio_hora_desplazamiento!==void 0&&(t.precio_hora_desplazamiento=e.precio_hora_desplazamiento),e.total_estimado!==void 0&&(t.total_estimado=e.total_estimado),e.estado!==void 0&&(t.estado=e.estado),e.pdf_url!==void 0&&(t.pdf_url=e.pdf_url),e.materiales&&e.materiales.length>0&&(t.materiales_estimados=e.materiales);let i=`${p.supabaseUrl}/rest/v1/presupuestos?id=eq.${s}`,r={apikey:p.supabaseServiceKey,Authorization:`Bearer ${p.supabaseServiceKey}`,"Content-Type":"application/json",Prefer:"return=representation"};console.log("\u{1F680} URL construida:",i),console.log("\u{1F680} Datos a actualizar:",t);let a=Date.now(),o=yield fetch(i,{method:"PATCH",headers:r,body:JSON.stringify(t)}),c=Date.now()-a;if(console.log("\u{1F680} Fetch completado en",c,"ms"),console.log("\u{1F680} Status:",o.status),!o.ok){let d=yield o.text();throw console.error("\u{1F680} Error response body:",d),new Error(`HTTP ${o.status}: ${o.statusText}`)}let n=yield o.json();if(console.log("\u{1F680} Datos recibidos:",(n==null?void 0:n.length)||0,"presupuestos"),!n||n.length===0)throw new Error("Presupuesto no encontrado");let f=n[0];console.log("\u{1F680} Presupuesto actualizado:",f);let m=this.presupuestosSubject.value,v=m.findIndex(d=>d.id===s);return v!==-1&&(m[v]=f,this.presupuestosSubject.next([...m])),this.dataUpdateService.notifyUpdated("presupuestos"),f}catch(t){throw console.error("\u{1F680} Error en fetch directo:",t),t}})}actualizarPresupuesto(s,e){return this.actualizarPresupuestoDirect(s,e)}eliminarPresupuestoDirect(s){return console.log("\u{1F680} PresupuestosService: Usando FETCH DIRECTO para eliminar presupuesto..."),u(this.fetchEliminarPresupuestoDirect(s)).pipe(l(()=>{console.log("\u2705 PresupuestosService: FETCH DIRECTO completado, presupuesto eliminado")}),S(e=>{throw console.error("\u274C PresupuestosService: Error en FETCH DIRECTO:",e),e}))}fetchEliminarPresupuestoDirect(s){return b(this,null,function*(){console.log("\u{1F680} PresupuestosService: Ejecutando fetch directo para eliminar presupuesto:",s);try{let e=`${p.supabaseUrl}/rest/v1/presupuestos?id=eq.${s}`,t={apikey:p.supabaseServiceKey,Authorization:`Bearer ${p.supabaseServiceKey}`,"Content-Type":"application/json"};console.log("\u{1F680} URL construida:",e);let i=Date.now(),r=yield fetch(e,{method:"DELETE",headers:t}),a=Date.now()-i;if(console.log("\u{1F680} Fetch completado en",a,"ms"),console.log("\u{1F680} Status:",r.status),!r.ok){let n=yield r.text();throw console.error("\u{1F680} Error response body:",n),new Error(`HTTP ${r.status}: ${r.statusText}`)}console.log("\u2705 Presupuesto eliminado exitosamente");let c=this.presupuestosSubject.value.filter(n=>n.id!==s);this.presupuestosSubject.next(c),this.dataUpdateService.notifyDeleted("presupuestos")}catch(e){throw console.error("\u{1F680} Error en fetch directo:",e),e}})}eliminarPresupuesto(s){return this.eliminarPresupuestoDirect(s)}buscarPresupuestos(s){return u(this.getSupabaseClient().from("presupuestos").select(`
          *,
          aviso:avisos(
            *,
            cliente:clientes(*)
          )
        `).or(`aviso.nombre_cliente_aviso.ilike.%${s}%`).limit(10)).pipe(l(({data:e,error:t})=>{if(t)throw t;return e}))}getPresupuestosPorEstado(s){return u(this.getSupabaseClient().from("presupuestos").select(`
          *,
          aviso:avisos(
            *,
            cliente:clientes(*)
          )
        `).eq("estado",s).order("fecha_creacion",{ascending:!1})).pipe(l(({data:e,error:t})=>{if(t)throw t;return e}))}getPresupuestosPorAviso(s){return u(this.getSupabaseClient().from("presupuestos").select(`
          *,
          aviso:avisos(
            *,
            cliente:clientes(*)
          )
        `).eq("aviso_id",s).order("fecha_creacion",{ascending:!1})).pipe(l(({data:e,error:t})=>{if(t)throw t;return e}))}cambiarEstado(s,e){return u(this.getSupabaseClient().from("presupuestos").update({estado:e,fecha_actualizacion:new Date().toISOString()}).eq("id",s).select(`
          *,
          aviso:avisos(
            *,
            cliente:clientes(*)
          )
        `).single()).pipe(l(({data:t,error:i})=>{if(i)throw i;let r=t,a=this.presupuestosSubject.value,o=a.findIndex(c=>c.id===s);return o!==-1&&(a[o]=r,this.presupuestosSubject.next([...a])),r}))}getPresupuestosActuales(){return this.presupuestosSubject.value}aprobarPresupuesto(s){return console.log("Servicio: Aprobando presupuesto con ID:",s),u(this.getSupabaseClient().from("presupuestos").update({estado:"Aprobado",fecha_actualizacion:new Date().toISOString()}).eq("id",s).select()).pipe(C(({data:e,error:t})=>{t?console.error("Error al actualizar presupuesto:",t):console.log("Presupuesto actualizado exitosamente:",e)}),l(({data:e,error:t})=>{if(t)throw t;return e}))}limpiarPresupuestos(){this.presupuestosSubject.next([])}};h.\u0275fac=function(e){return new(e||h)(w(z),w(j))},h.\u0275prov=y({token:h,factory:h.\u0275fac,providedIn:"root"});let E=h;return E})();export{H as a};
