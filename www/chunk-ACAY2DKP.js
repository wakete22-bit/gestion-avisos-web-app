import{a as $}from"./chunk-N4FKO75N.js";import{a as l,b as x}from"./chunk-ZFUZ5UD4.js";import{E as j,H as E,d as y,f as h,j as p,r as C}from"./chunk-QQQKELKR.js";import{a as v,b as g,k as m}from"./chunk-CRC5ZNR6.js";var _=(()=>{let d=class d{constructor(i,e){this.supabaseClientService=i,this.dataUpdateService=e,this.clientesSubject=new y([]),this.clientes$=this.clientesSubject.asObservable()}getSupabaseClient(){return console.log("\u{1F465} ClientesService: Obteniendo cliente Supabase actualizado..."),this.supabaseClientService.getClient()}getClientes(i=1,e=10,t,r,c,n=!1){let o=this.getSupabaseClient().from("clientes").select("*",{count:"exact"});t&&(o=o.or(`nombre_completo.ilike.%${t}%,email.ilike.%${t}%`)),n&&(o=o.eq("es_activo",!0));let s=(i-1)*e;return o=o.range(s,s+e-1).order(r||"fecha_creacion",{ascending:c==="asc"}),h(o).pipe(p(({data:a,error:f,count:T})=>{if(f)throw f;let u=a;return this.clientesSubject.next(u),{clientes:u,total:T||0,pagina:i,por_pagina:e}}),C(a=>{throw console.error("Error al obtener clientes:",a),a}))}getClientesDirect(i=1,e=10,t,r,c,n=!1){return console.log("\u{1F680} ClientesService: Usando FETCH DIRECTO para clientes..."),h(this.fetchClientesDirect(i,e,t,r,c,n)).pipe(p(o=>(console.log("\u2705 ClientesService: FETCH DIRECTO completado, clientes:",o.clientes.length),this.clientesSubject.next(o.clientes),o)),C(o=>{throw console.error("\u274C ClientesService: Error en FETCH DIRECTO:",o),o}))}fetchClientesDirect(i=1,e=10,t,r,c,n=!1){return m(this,null,function*(){console.log("\u{1F680} ClientesService: Ejecutando fetch directo para clientes...");try{let o=`${l.supabaseUrl}/rest/v1/clientes?select=*`,s=[];t&&s.push(`or=(nombre_completo.ilike.*${t}*,email.ilike.*${t}*)`),n&&s.push("es_activo=eq.true"),s.length>0&&(o+="&"+s.join("&"));let a=(i-1)*e;o+=`&limit=${e}&offset=${a}`,o+=`&order=${r||"fecha_creacion"}.${c==="asc"?"asc":"desc"}`;let f={apikey:l.supabaseServiceKey,Authorization:`Bearer ${l.supabaseServiceKey}`,"Content-Type":"application/json",Prefer:"count=exact"};console.log("\u{1F680} URL construida:",o);let T=Date.now(),u=yield fetch(o,{method:"GET",headers:f}),I=Date.now()-T;if(console.log("\u{1F680} Fetch completado en",I,"ms"),console.log("\u{1F680} Status:",u.status),!u.ok){let O=yield u.text();throw console.error("\u{1F680} Error response body:",O),new Error(`HTTP ${u.status}: ${u.statusText}`)}let S=yield u.json(),w=u.headers.get("content-range"),D=w?parseInt(w.split("/")[1]):S.length;return console.log("\u{1F680} Datos recibidos:",(S==null?void 0:S.length)||0,"clientes, total:",D),{clientes:S,total:D,pagina:i,por_pagina:e}}catch(o){throw console.error("\u{1F680} Error en fetch directo:",o),o}})}getCliente(i){return h(this.getSupabaseClient().from("clientes").select("*").eq("id",i).single()).pipe(p(({data:e,error:t})=>{if(t)throw t;return e}))}crearCliente(i){return console.log("\u{1F680} ClientesService: Usando FETCH DIRECTO para crear cliente..."),h(this.fetchCrearClienteDirect(i)).pipe(p(e=>{console.log("\u2705 ClientesService: FETCH DIRECTO completado, cliente creado:",e.id);let t=this.clientesSubject.value;return this.clientesSubject.next([e,...t]),this.dataUpdateService.notifyCreated("clientes"),e}),C(e=>{throw console.error("\u274C ClientesService: Error en FETCH DIRECTO para crear cliente:",e),e}))}actualizarCliente(i,e){let t=g(v({},e),{fecha_actualizacion:new Date().toISOString()});return h(this.getSupabaseClient().from("clientes").update(t).eq("id",i).select().single()).pipe(p(({data:r,error:c})=>{if(c)throw c;let n=r,o=this.clientesSubject.value,s=o.findIndex(a=>a.id===i);return s!==-1&&(o[s]=n,this.clientesSubject.next([...o])),this.dataUpdateService.notifyUpdated("clientes"),n}))}actualizarClienteDirect(i,e){return console.log("\u{1F680} ClientesService: Usando FETCH DIRECTO para actualizar cliente..."),h(this.fetchActualizarClienteDirect(i,e)).pipe(p(t=>{console.log("\u2705 ClientesService: FETCH DIRECTO completado, cliente actualizado:",t.id);let r=this.clientesSubject.value,c=r.findIndex(n=>n.id===i);return c!==-1&&(r[c]=t,this.clientesSubject.next([...r])),this.dataUpdateService.notifyUpdated("clientes"),t}),C(t=>{throw console.error("\u274C ClientesService: Error en FETCH DIRECTO:",t),t}))}fetchActualizarClienteDirect(i,e){return m(this,null,function*(){console.log("\u{1F680} ClientesService: Ejecutando fetch directo para actualizar cliente:",i);try{let t=g(v({},e),{fecha_actualizacion:new Date().toISOString()}),r=`${l.supabaseUrl}/rest/v1/clientes?id=eq.${i}`,c={apikey:l.supabaseServiceKey,Authorization:`Bearer ${l.supabaseServiceKey}`,"Content-Type":"application/json",Prefer:"return=representation"};console.log("\u{1F680} URL construida:",r),console.log("\u{1F680} Datos a actualizar:",t);let n=Date.now(),o=yield fetch(r,{method:"PATCH",headers:c,body:JSON.stringify(t)}),s=Date.now()-n;if(console.log("\u{1F680} Fetch completado en",s,"ms"),console.log("\u{1F680} Status:",o.status),!o.ok){let f=yield o.text();throw console.error("\u{1F680} Error response body:",f),new Error(`HTTP ${o.status}: ${o.statusText}`)}let a=yield o.json();if(console.log("\u{1F680} Datos recibidos:",(a==null?void 0:a.length)||0,"clientes actualizados"),!a||a.length===0)throw new Error("Cliente no encontrado");return a[0]}catch(t){throw console.error("\u{1F680} Error en fetch directo:",t),t}})}eliminarCliente(i){return h(this.getSupabaseClient().from("clientes").update({es_activo:!1,fecha_actualizacion:new Date().toISOString()}).eq("id",i)).pipe(p(({error:e})=>{if(e)throw e;let t=this.clientesSubject.value,r=t.findIndex(c=>c.id===i);r!==-1&&(t[r].es_activo=!1,this.clientesSubject.next([...t])),this.dataUpdateService.notifyDeleted("clientes")}))}eliminarClienteDirect(i){return console.log("\u{1F680} ClientesService: Usando FETCH DIRECTO para eliminar cliente..."),h(this.fetchEliminarClienteDirect(i)).pipe(p(()=>{console.log("\u2705 ClientesService: FETCH DIRECTO completado, cliente eliminado:",i);let e=this.clientesSubject.value,t=e.findIndex(r=>r.id===i);t!==-1&&(e[t].es_activo=!1,this.clientesSubject.next([...e])),this.dataUpdateService.notifyDeleted("clientes")}),C(e=>{throw console.error("\u274C ClientesService: Error en FETCH DIRECTO:",e),e}))}fetchEliminarClienteDirect(i){return m(this,null,function*(){console.log("\u{1F680} ClientesService: Ejecutando fetch directo para eliminar cliente:",i);try{let e={es_activo:!1,fecha_actualizacion:new Date().toISOString()},t=`${l.supabaseUrl}/rest/v1/clientes?id=eq.${i}`,r={apikey:l.supabaseServiceKey,Authorization:`Bearer ${l.supabaseServiceKey}`,"Content-Type":"application/json"};console.log("\u{1F680} URL construida:",t),console.log("\u{1F680} Datos a actualizar:",e);let c=Date.now(),n=yield fetch(t,{method:"PATCH",headers:r,body:JSON.stringify(e)}),o=Date.now()-c;if(console.log("\u{1F680} Fetch completado en",o,"ms"),console.log("\u{1F680} Status:",n.status),!n.ok){let s=yield n.text();throw console.error("\u{1F680} Error response body:",s),new Error(`HTTP ${n.status}: ${n.statusText}`)}console.log("\u{1F680} Cliente eliminado exitosamente")}catch(e){throw console.error("\u{1F680} Error en fetch directo:",e),e}})}buscarClientes(i){return h(this.getSupabaseClient().from("clientes").select("*").or(`nombre_completo.ilike.%${i}%,email.ilike.%${i}%`).eq("es_activo",!0).limit(10)).pipe(p(({data:e,error:t})=>{if(t)throw t;return e}))}getClientesActuales(){return this.clientesSubject.value}limpiarClientes(){this.clientesSubject.next([])}fetchCrearClienteDirect(i){return m(this,null,function*(){var e;console.log("\u{1F680} ClientesService: Ejecutando fetch directo para crear cliente...");try{let t=g(v({},i),{fecha_creacion:new Date().toISOString(),es_activo:(e=i.es_activo)!=null?e:!0}),r={apikey:l.supabaseServiceKey,Authorization:`Bearer ${l.supabaseServiceKey}`,"Content-Type":"application/json",Prefer:"return=representation"},c=`${l.supabaseUrl}/rest/v1/clientes`,n=yield fetch(c,{method:"POST",headers:r,body:JSON.stringify(t)});if(!n.ok){let a=yield n.text();throw new Error(`HTTP ${n.status}: ${n.statusText} - ${a}`)}let s=(yield n.json())[0];return console.log("\u2705 Cliente creado con FETCH DIRECTO:",s),s}catch(t){throw console.error("\u{1F680} Error en fetch directo para crear cliente:",t),t}})}};d.\u0275fac=function(e){return new(e||d)(E(x),E($))},d.\u0275prov=j({token:d,factory:d.\u0275fac,providedIn:"root"});let b=d;return b})();export{_ as a};
