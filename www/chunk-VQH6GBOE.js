import{a as T}from"./chunk-STXSJFLK.js";import{b as O}from"./chunk-GDHKTYOW.js";import{F as x,I as w,d as $,f as c,j as d,m as D,s as h,z as m}from"./chunk-4AY4VQCP.js";import{a as _,b as A}from"./chunk-CRC5ZNR6.js";var I=(()=>{let g=class g{constructor(a,e){this.supabaseClientService=a,this.cacheService=e,this.avisosSubject=new $([]),this.avisos$=this.avisosSubject.asObservable(),this.supabase=this.supabaseClientService.getClient()}debugConnection(){return console.log("\u{1F50D} AvisosService: Probando conexi\xF3n b\xE1sica..."),c(this.supabase.from("avisos").select("id").limit(1)).pipe(d(({data:a,error:e})=>{if(e)throw console.error("\u274C AvisosService: Error en conexi\xF3n:",e),e;return console.log("\u2705 AvisosService: Conexi\xF3n exitosa, datos:",a),{success:!0,data:a}}),h(a=>(console.error("\u274C AvisosService: Error cr\xEDtico:",a),c(Promise.resolve({success:!1,error:a})))))}getAvisos(a=1,e=15,s,t,o,i,n=!1){let r=this.supabase.from("avisos").select(`
                id,
                numero_secuencial,
                cliente_id,
                tecnico_asignado_id,
                fecha_creacion,
                nombre_cliente_aviso,
                direccion_cliente_aviso,
                telefono_cliente_aviso,
                nombre_contacto,
                tipo,
                descripcion_problema,
                estado,
                urgencia,
                es_urgente,
                latitud,
                longitud,
                cliente:clientes!inner(id, nombre_completo, direccion, telefono_contacto),
                tecnico_asignado:usuarios(id, nombre_completo, email)
            `,{count:"exact"});s&&(r=r.or(`nombre_cliente_aviso.ilike.%${s}%,descripcion_problema.ilike.%${s}%`)),i?r=r.eq("estado",i):n||(r=r.neq("estado","Completado"));let l=(a-1)*e;return r=r.range(l,l+e-1).order(t||"numero_secuencial",{ascending:o==="asc"}),c(r).pipe(d(({data:u,error:f,count:v})=>{if(f)throw f;let p=u;return this.avisosSubject.next(p),{avisos:p,total:v||0,pagina:a,por_pagina:e}}),h(u=>{throw console.error("Error al obtener avisos:",u),u}))}getAviso(a){return c(this.supabase.from("avisos").select(`
                    *,
                    cliente:clientes!inner(*),
                    tecnico_asignado:usuarios(*),
                    fotos:fotos_aviso(id, url, descripcion, fecha_subida)
                `).eq("id",a).single()).pipe(d(({data:e,error:s})=>{if(s)throw s;return e}),h(e=>{throw console.error("Error al obtener aviso:",e),e}))}crearAviso(a){let e=A(_({},a),{urgencia:a.es_urgente?"Alta":"Normal",fecha_creacion:new Date().toISOString(),estado:"Pendiente",requiere_presupuesto:!1,requiere_nueva_visita:!1});return c(this.supabase.from("avisos").insert([e]).select(`
          *,
          cliente:clientes(*),
          tecnico_asignado:usuarios(*),
          fotos:fotos_aviso(*)
        `).single()).pipe(d(({data:s,error:t})=>{if(t)throw t;let o=s,i=this.avisosSubject.value;return this.avisosSubject.next([o,...i]),this.cacheService.clearCache("avisos"),o}))}actualizarAviso(a,e){let s=A(_({},e),{fecha_actualizacion:new Date().toISOString()});return c(this.supabase.from("avisos").update(s).eq("id",a).select(`
          *,
          cliente:clientes(*),
          tecnico_asignado:usuarios(*),
          fotos:fotos_aviso(*)
        `).single()).pipe(d(({data:t,error:o})=>{if(o)throw o;let i=t,n=this.avisosSubject.value,r=n.findIndex(l=>l.id===a);return r!==-1&&(n[r]=i,this.avisosSubject.next([...n])),this.cacheService.clearCache("avisos"),i}))}verificarDependenciasAviso(a){return console.log("\u{1F50D} Verificando dependencias para aviso:",a),c(Promise.all([this.supabase.from("presupuestos").select("id").eq("aviso_id",a),this.supabase.from("facturas").select("id").eq("aviso_id",a),this.supabase.from("albaranes").select("id").eq("aviso_id",a),this.supabase.from("historial_flujo").select("id").eq("aviso_id",a)])).pipe(d(([e,s,t,o])=>{var l,u,f,v,p;console.log("\u{1F4CA} Resultados de verificaci\xF3n:",{presupuestos:((l=e.data)==null?void 0:l.length)||0,facturas:((u=s.data)==null?void 0:u.length)||0,albaranes:((f=t.data)==null?void 0:f.length)||0,historialFlujo:((v=o.data)==null?void 0:v.length)||0,errores:{presupuestos:e.error,facturas:s.error,albaranes:t.error,historialFlujo:o.error}});let i=[];!e.error&&e.data&&e.data.length>0&&i.push(`${e.data.length} presupuesto(s)`),!s.error&&s.data&&s.data.length>0&&i.push(`${s.data.length} factura(s)`),!t.error&&t.data&&t.data.length>0&&i.push(`${t.data.length} albar\xE1n(es)`),!o.error&&o.data&&o.data.length>0&&console.log(`\u2139\uFE0F Historial encontrado: ${o.data.length} registro(s) (se eliminar\xE1n autom\xE1ticamente por CASCADE)`);let n=e.error||s.error||t.error,r=i.length===0||n&&i.length===0;return console.log("\u2705 Resultado de verificaci\xF3n:",{puedeEliminar:r,dependencias:i,historialFlujo:((p=o.data)==null?void 0:p.length)||0,historialSeEliminaAutomaticamente:!0,tieneErroresPermisos:n}),{puedeEliminar:r!=null?r:!1,dependencias:i}}))}eliminarAviso(a){return console.log("\u{1F5D1}\uFE0F Iniciando eliminaci\xF3n de aviso:",a),this.eliminarAvisoConDependencias(a)}eliminarAvisoConDependencias(a){console.log("\u{1F504} Eliminando dependencias del aviso:",a);let e=[c(this.supabase.from("historial_flujo").delete().eq("aviso_id",a)),c(this.supabase.from("albaranes").delete().eq("aviso_id",a)),c(this.supabase.from("presupuestos").delete().eq("aviso_id",a)),c(this.supabase.from("facturas").delete().eq("aviso_id",a)),this.eliminarFotosAviso(a)];return D(e).pipe(m(()=>(console.log("\u2705 Dependencias eliminadas, eliminando aviso..."),c(this.supabase.from("avisos").delete().eq("id",a)))),d(({error:s})=>{if(s)throw console.error("\u274C Error al eliminar aviso despu\xE9s de limpiar dependencias:",s),s;console.log("\u2705 Aviso eliminado exitosamente"),this.actualizarEstadoLocal(a)}),h(s=>{throw console.error("\u274C Error en eliminaci\xF3n en cascada:",s),s}))}actualizarEstadoLocal(a){let s=this.avisosSubject.value.filter(t=>t.id!==a);this.avisosSubject.next(s),this.cacheService.clearCache("avisos")}eliminarFotosAviso(a){return c(this.supabase.from("fotos_aviso").select("*").eq("aviso_id",a)).pipe(m(({data:e,error:s})=>{if(s)throw s;let t=e;if(t.length===0)return c(this.supabase.from("fotos_aviso").delete().eq("aviso_id",a)).pipe(d(({error:i})=>{if(i)throw i}));let o=t.map(i=>{let n=i.url.split("/"),r=n[n.length-1];return`${a}/${r}`});return c(this.supabase.storage.from("fotos-avisos").remove(o)).pipe(m(({error:i})=>(i&&console.warn("Error al eliminar archivos del storage:",i),c(this.supabase.from("fotos_aviso").delete().eq("aviso_id",a)))),d(({error:i})=>{if(i)throw i}))}),h(e=>{throw console.error("Error al eliminar fotos del aviso:",e),e}))}subirFoto(a,e,s){let t=this.sanitizeFileName(e.name),o=`${a}/${Date.now()}_${t}`;return c(this.supabase.storage.from("fotos-avisos").upload(o,e)).pipe(d(({data:i,error:n})=>{if(n)throw console.error("Error al subir archivo a storage:",n),n.message==="Bucket not found"?new Error("El bucket de storage no est\xE1 configurado. Contacta al administrador."):n;let{data:r}=this.supabase.storage.from("fotos-avisos").getPublicUrl(o);return r.publicUrl}),m(i=>c(this.supabase.from("fotos_aviso").insert([{aviso_id:a,url:i,descripcion:s}]).select().single())),d(({data:i,error:n})=>{if(n)throw n;return i}),h(i=>{throw console.error("Error completo al subir foto:",i),i}))}eliminarFoto(a){return c(this.supabase.from("fotos_aviso").select("*").eq("id",a).single()).pipe(m(({data:e,error:s})=>{if(s)throw s;let t=e,o=t.url.split("/"),i=o[o.length-1],r=`${t.aviso_id}/${i}`;return c(this.supabase.storage.from("fotos-avisos").remove([r])).pipe(m(({error:l})=>(l&&console.warn("Error al eliminar archivo del storage:",l),c(this.supabase.from("fotos_aviso").delete().eq("id",a)))),d(({error:l})=>{if(l)throw l}))}),h(e=>{throw console.error("Error al eliminar foto:",e),e}))}buscarAvisos(a){return c(this.supabase.from("avisos").select(`
          *,
          cliente:clientes(*),
          tecnico_asignado:usuarios(*),
          fotos:fotos_aviso(*)
        `).or(`nombre_cliente_aviso.ilike.%${a}%,descripcion_problema.ilike.%${a}%`).neq("estado","Completado").limit(10)).pipe(d(({data:e,error:s})=>{if(s)throw s;return e}))}getAvisosActivos(a=1,e=10,s,t,o,i){return this.getAvisos(a,e,s,t,o,i,!1)}getAvisosCompletados(a=1,e=10,s,t,o){return this.getAvisos(a,e,s,t,o,"Completado",!0)}getAvisosActuales(){return this.avisosSubject.value}limpiarAvisos(){this.avisosSubject.next([])}sanitizeFileName(a){return a.replace(/[^a-zA-Z0-9.-]/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,"").toLowerCase()}crearFacturaDesdeTrabajos(a){return c(this.supabase.from("avisos").select(`
                    *,
                    cliente:clientes(*),
                    trabajos:trabajos_realizados(
                        *,
                        materiales:materiales_trabajo(
                            *,
                            material:inventario(*)
                        ),
                        albaran:albaranes!trabajos_realizados_albaran_id_fkey(*)
                    )
                `).eq("id",a).single()).pipe(d(({data:e,error:s})=>{var n;if(s)throw s;let t=e,o=((n=t.trabajos)==null?void 0:n.filter(r=>{var l;return r.estado==="Finalizado"||((l=r.albaran)==null?void 0:l.estado_cierre)==="Finalizado"}))||[];if(o.length===0)throw new Error("No hay trabajos finalizados para facturar. Debes crear un albar\xE1n primero.");return{avisoId:t.id,cliente:t.cliente||{nombre_completo:t.nombre_cliente_aviso,direccion:t.direccion_cliente_aviso,email:"sin-email@ejemplo.com",cif:"Sin CIF"},trabajos:o,resumen:this.calcularResumenFacturacion(o)}}),h(e=>{throw console.error("Error al preparar factura desde trabajos:",e),e}))}calcularResumenFacturacion(a){let e=[],s=0;return a.forEach(t=>{var r;let o=new Date(`2000-01-01T${t.hora_inicio}`),n=(new Date(`2000-01-01T${t.hora_fin}`).getTime()-o.getTime())/(1e3*60*60);s+=Math.max(0,n),(r=t.materiales)==null||r.forEach(l=>{var f,v;let u=e.find(p=>p.material_id===l.material_id);u?u.cantidad_total+=l.cantidad_utilizada:e.push({material_id:l.material_id,nombre:((f=l.material)==null?void 0:f.nombre)||"Material desconocido",cantidad_total:l.cantidad_utilizada,precio_unitario:l.precio_neto_al_momento,descripcion:((v=l.material)==null?void 0:v.descripcion)||""})})}),{materiales:e,horasTotales:s,numeroTrabajos:a.length}}getResumenCompletoAviso(a){return c(this.supabase.from("avisos").select(`
                    *,
                    cliente:clientes(*),
                    tecnico_asignado:usuarios(*),
                    fotos:fotos_aviso(*),
                    albaranes:albaranes(
                        *,
                        repuestos_utilizados,
                        repuestos:repuestos_albaran(*)
                    ),
                    presupuestos:presupuestos(*),
                    facturas:facturas(*)
                `).eq("id",a).single()).pipe(d(({data:e,error:s})=>{var p,C,z,S,P,F,q,E;if(s)throw s;let t=e,o=((p=t.albaranes)==null?void 0:p.filter(b=>b.estado_cierre==="Finalizado"))||[],i=((C=t.albaranes)==null?void 0:C.filter(b=>b.estado_cierre==="Presupuesto pendiente"))||[],n=((z=t.albaranes)==null?void 0:z.filter(b=>b.estado_cierre==="Otra visita"))||[],r=[...o,...i],l=((S=t.facturas)==null?void 0:S.filter(b=>b.estado!=="Completado"))||[],u=((P=t.facturas)==null?void 0:P.filter(b=>b.estado==="Completado"))||[],f=i.length>0,v=n.length>0;return A(_({},t),{estadisticas:{totalAlbaranes:((F=t.albaranes)==null?void 0:F.length)||0,albaranesCerrados:r.length,albaranesFinalizados:o.length,albaranesPresupuestoPendiente:i.length,albaranesOtraVisita:n.length,tienePresupuesto:f,requiereOtraVisita:v,estadoPresupuesto:f?"Pendiente":null,totalFacturas:((q=t.facturas)==null?void 0:q.length)||0,facturasPendientes:l.length,facturasCompletadas:u.length,totalTrabajos:((E=t.albaranes)==null?void 0:E.length)||0,trabajosConAlbaran:r.length,trabajosFinalizados:o.length,puedeFacturar:o.length>0&&l.length===0}})}),h(e=>{throw console.error("Error al obtener resumen completo:",e),e}))}actualizarEstadoAutomatico(a){return this.getResumenCompletoAviso(a).pipe(m(e=>{var t,o;let s=e.estado;return console.log("\u{1F50D} Analizando estado del aviso:",{estadoActual:e.estado,trabajosFinalizados:e.estadisticas.trabajosFinalizados,totalFacturas:e.estadisticas.totalFacturas,facturasPendientes:e.estadisticas.facturasPendientes,facturasCompletadas:e.estadisticas.facturasCompletadas,trabajos:((t=e.trabajos)==null?void 0:t.length)||0,albaranes:((o=e.albaranes)==null?void 0:o.length)||0}),e.estadisticas.trabajosFinalizados>0&&e.estadisticas.totalFacturas>0&&e.estadisticas.facturasPendientes===0?s="Completado":e.estadisticas.trabajosFinalizados>0&&e.estadisticas.facturasPendientes===0?s="Listo para facturar":e.estadisticas.trabajosPresupuestoPendiente>0?s="Pendiente de presupuesto":e.estadisticas.trabajosOtraVisita>0?s="Otra visita requerida":e.estadisticas.trabajosConAlbaran>0&&e.estadisticas.tienePresupuesto?s="Pendiente de presupuesto":e.estadisticas.trabajosConAlbaran>0||e.estadisticas.totalTrabajos>0?s="En curso":e.estadisticas.totalTrabajos===0&&e.estadisticas.trabajosConAlbaran===0&&(e.estado==="Pendiente"?s=e.estado:s="Pendiente"),console.log("\u{1F50D} Estado calculado:",{estadoAnterior:e.estado,estadoNuevo:s,cambio:e.estado!==s}),s!==e.estado?(console.log(`\u{1F504} Actualizando estado del aviso ${a} de "${e.estado}" a "${s}"`),this.actualizarAviso(a,{estado:s})):c([e])}))}};g.\u0275fac=function(e){return new(e||g)(w(O),w(T))},g.\u0275prov=x({token:g,factory:g.\u0275fac,providedIn:"root"});let j=g;return j})();export{I as a};
