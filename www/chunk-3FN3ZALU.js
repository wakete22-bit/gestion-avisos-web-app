import{D as b,G as p,Sc as v,d as m,f as h,fb as A,gb as x,k as d,r as w}from"./chunk-7PIWZYGA.js";import{a as f,b as g,k as s}from"./chunk-CRC5ZNR6.js";var E=(()=>{let i=class i{constructor(e){this.supabaseClientService=e,this.usuariosSubject=new m([]),this.usuarios$=this.usuariosSubject.asObservable(),this.supabase=this.supabaseClientService.getClient()}getUsuarios(){return h(this.supabase.from("usuarios").select(`
          *,
          rol:roles(*)
        `).order("fecha_creacion",{ascending:!1})).pipe(d(({data:e,error:t})=>{if(t)throw t;let r=e;return this.usuariosSubject.next(r),r}),w(e=>{throw console.error("Error al obtener usuarios:",e),e}))}getUsuario(e){return h(this.supabase.from("usuarios").select(`
          *,
          rol:roles(*)
        `).eq("id",e).single()).pipe(d(({data:t,error:r})=>{if(r)throw r;return t}))}crearUsuario(e){let t={id:e.id,nombre_completo:e.nombre_completo,email:e.email,telefono:e.telefono,rol_id:e.rol_id||"default-role-id",fecha_creacion:new Date().toISOString(),es_activo:!0};return h(this.supabase.from("usuarios").insert([t]).select(`
          *,
          rol:roles(*)
        `).single()).pipe(d(({data:r,error:o})=>{if(o)throw o;let a=r,n=this.usuariosSubject.value;return this.usuariosSubject.next([a,...n]),a}))}actualizarUsuario(e,t){let r=g(f({},t),{fecha_actualizacion:new Date().toISOString()});return h(this.supabase.from("usuarios").update(r).eq("id",e).select(`
          *,
          rol:roles(*)
        `).single()).pipe(d(({data:o,error:a})=>{if(a)throw a;let n=o,u=this.usuariosSubject.value,l=u.findIndex(S=>S.id===e);return l!==-1&&(u[l]=n,this.usuariosSubject.next([...u])),n}))}desactivarUsuario(e){return h(this.supabase.from("usuarios").update({es_activo:!1,fecha_actualizacion:new Date().toISOString()}).eq("id",e)).pipe(d(({error:t})=>{if(t)throw t;let r=this.usuariosSubject.value,o=r.findIndex(a=>a.id===e);o!==-1&&(r[o].es_activo=!1,this.usuariosSubject.next([...r]))}))}getUsuariosActuales(){return this.usuariosSubject.value}limpiarUsuarios(){this.usuariosSubject.next([])}};i.\u0275fac=function(t){return new(t||i)(p(v))},i.\u0275prov=b({token:i,factory:i.\u0275fac,providedIn:"root"});let c=i;return c})();var R=(()=>{let i=class i{constructor(e,t,r){this.http=e,this.usuariosService=t,this.supabaseClientService=r,this.currentUserSubject=new m(null),this.currentUser$=this.currentUserSubject.asObservable(),this.isAuthenticatedSubject=new m(!1),this.isAuthenticated$=this.isAuthenticatedSubject.asObservable(),this.TOKEN_KEY="auth_token",this.USER_KEY="current_user",this.isInitializing=!1,this.supabase=this.supabaseClientService.getClient(),this.initializeAuth(),this.setupReconnectionHandler()}setupReconnectionHandler(){document.addEventListener("supabase-reconnection",e=>s(this,null,function*(){let{success:t}=e.detail;console.log("\u{1F527} AuthService: Evento de reconexi\xF3n recibido:",t),t?yield this.handleSuccessfulReconnection():(console.log("\u{1F527} AuthService: Reconexi\xF3n fallida, limpiando estado..."),this.clearAuth())}))}handleSuccessfulReconnection(){return s(this,null,function*(){try{console.log("\u{1F527} AuthService: Manejando reconexi\xF3n exitosa...");let{data:{session:e}}=yield this.supabase.auth.getSession();e!=null&&e.user?(console.log("\u{1F527} AuthService: Sesi\xF3n v\xE1lida despu\xE9s de reconexi\xF3n, actualizando estado..."),this.isAuthenticatedSubject.next(!0),this.currentUserSubject.value||(yield this.loadUserData(e.user.id)),console.log("\u{1F527} AuthService: Estado de autenticaci\xF3n actualizado despu\xE9s de reconexi\xF3n")):(console.log("\u{1F527} AuthService: No hay sesi\xF3n v\xE1lida despu\xE9s de reconexi\xF3n"),this.clearAuth())}catch(e){console.error("\u274C AuthService: Error manejando reconexi\xF3n exitosa:",e),this.clearAuth()}})}initializeAuth(){return s(this,null,function*(){if(this.isInitializing){console.log("\u{1F527} AuthService: Ya se est\xE1 inicializando, esperando...");return}this.isInitializing=!0;try{console.log("\u{1F527} AuthService: Iniciando autenticaci\xF3n..."),yield this.clearProblematicLocks(),yield this.loadStoredAuth(),this.setupAuthListener(),console.log("\u{1F527} AuthService: Inicializaci\xF3n completada")}catch(e){console.error("\u274C AuthService: Error en inicializaci\xF3n:",e),this.clearAuth()}finally{this.isInitializing=!1}})}loadStoredAuth(){return s(this,null,function*(){let t=0;for(;t<3;)try{console.log(`\u{1F527} AuthService: Intento ${t+1} de 3`);let r=this.supabase.auth.getSession(),o=new Promise((n,u)=>setTimeout(()=>u(new Error("Timeout getting session")),1e4)),{data:{session:a}}=yield Promise.race([r,o]);if(a!=null&&a.user){console.log("\u{1F527} AuthService: Sesi\xF3n encontrada, cargando datos del usuario..."),yield this.loadUserData(a.user.id);return}else{console.log("\u{1F527} AuthService: No hay sesi\xF3n almacenada");return}}catch(r){if(t++,console.error(`\u274C AuthService: Error en intento ${t}:`,r),t>=3){console.error("\u274C AuthService: M\xE1ximo de reintentos alcanzado"),this.clearAuth();return}yield new Promise(o=>setTimeout(o,2e3*t))}})}setupAuthListener(){this.supabase.auth.onAuthStateChange((e,t)=>s(this,null,function*(){var r;console.log("Auth state change:",e,(r=t==null?void 0:t.user)==null?void 0:r.id),e==="SIGNED_IN"&&(t!=null&&t.user)?yield this.loadUserData(t.user.id):e==="SIGNED_OUT"?this.clearAuth():e==="TOKEN_REFRESHED"&&(t!=null&&t.user)&&(yield this.loadUserData(t.user.id))}))}loadUserData(e){return s(this,null,function*(){try{console.log("\u{1F527} AuthService: Cargando datos del usuario:",e);try{let t=yield this.usuariosService.getUsuario(e).toPromise();console.log("\u{1F527} AuthService: Usuario encontrado en BD:",t),this.currentUserSubject.next(t||null),this.isAuthenticatedSubject.next(!0),console.log("\u{1F527} AuthService: Usuario cargado exitosamente desde BD")}catch(t){console.warn("\u26A0\uFE0F AuthService: Usuario no encontrado en BD, esperando a que se complete la creaci\xF3n:",t),yield new Promise(r=>setTimeout(r,3e3));try{let r=yield this.usuariosService.getUsuario(e).toPromise();console.log("\u{1F527} AuthService: Usuario encontrado despu\xE9s de esperar:",r),this.currentUserSubject.next(r||null),this.isAuthenticatedSubject.next(!0),console.log("\u{1F527} AuthService: Usuario cargado exitosamente despu\xE9s de esperar")}catch(r){console.error("\u274C AuthService: Usuario no encontrado despu\xE9s de esperar, creando usuario por defecto:",r);let o={id:e,nombre_completo:"Usuario",email:"usuario@example.com",telefono:"",rol_id:"default-role-id",rol:{id:"default-role-id",nombre_rol:"Cliente",descripcion:"",permisos:[],es_activo:!0,fecha_creacion:new Date,fecha_actualizacion:new Date},es_activo:!0,fecha_creacion:new Date};console.log("\u{1F527} AuthService: Usuario por defecto creado:",o),this.currentUserSubject.next(o),this.isAuthenticatedSubject.next(!0),console.log("\u{1F527} AuthService: Usuario por defecto cargado exitosamente")}}}catch(t){console.error("\u274C AuthService: Error loading user data:",t),this.clearAuth()}})}login(e){return s(this,null,function*(){var t;try{let{data:r,error:o}=yield this.supabase.auth.signInWithPassword({email:e.email,password:e.password});if(o)throw o;if(r.user)return yield this.loadUserData(r.user.id),{usuario:this.currentUserSubject.value,token:((t=r.session)==null?void 0:t.access_token)||""};throw new Error("No se pudo obtener informaci\xF3n del usuario")}catch(r){throw console.error("Error en login:",r),r}})}register(e){return s(this,null,function*(){var t;try{let{data:r,error:o}=yield this.supabase.auth.signUp({email:e.email,password:e.password,options:{data:{nombre_completo:e.nombre_completo,telefono:e.telefono}}});if(o)throw o;if(r.user){yield new Promise(n=>setTimeout(n,2e3));let a=g(f({},e),{id:r.user.id});try{yield this.usuariosService.crearUsuario(a).toPromise(),console.log("\u{1F527} AuthService: Usuario creado en tabla usuarios")}catch(n){console.warn("\u26A0\uFE0F AuthService: Error al crear usuario en tabla usuarios:",n)}return yield this.loadUserData(r.user.id),{usuario:this.currentUserSubject.value,token:((t=r.session)==null?void 0:t.access_token)||""}}throw new Error("No se pudo crear el usuario")}catch(r){throw console.error("Error en registro:",r),r}})}logout(){return s(this,null,function*(){yield this.supabase.auth.signOut(),this.clearAuth()})}refreshToken(){return s(this,null,function*(){var e;try{let{data:t,error:r}=yield this.supabase.auth.refreshSession();if(r)throw r;if(t.user)return yield this.loadUserData(t.user.id),{usuario:this.currentUserSubject.value,token:((e=t.session)==null?void 0:e.access_token)||""};throw new Error("No se pudo refrescar la sesi\xF3n")}catch(t){throw this.clearAuth(),t}})}getCurrentUser(){return this.currentUserSubject.value}isAuthenticated(){let e=this.isAuthenticatedSubject.value;return console.log("\u{1F527} AuthService: isAuthenticated() - Estado:",e),e}getToken(){return s(this,null,function*(){let{data:{session:e}}=yield this.supabase.auth.getSession(),t=(e==null?void 0:e.access_token)||null;return console.log("\u{1F527} AuthService: getToken() - Token obtenido:",t?"S\xCD":"NO"),t})}clearAuth(){this.currentUserSubject.next(null),this.isAuthenticatedSubject.next(!1)}getAuthHeaders(){return s(this,null,function*(){let e=yield this.getToken();return new A({"Content-Type":"application/json",Authorization:`Bearer ${e}`})})}isTokenExpired(){return s(this,null,function*(){let{data:{session:e}}=yield this.supabase.auth.getSession();return e?new Date(e.expires_at*1e3)<new Date:!0})}getCurrentSession(){return s(this,null,function*(){return yield this.supabase.auth.getSession()})}manualRefreshToken(){return s(this,null,function*(){try{console.log("\u{1F504} AuthService: Iniciando refresh manual de token...");let{data:{session:e}}=yield this.supabase.auth.getSession();if(!e)return console.log("\u{1F504} AuthService: No hay sesi\xF3n activa para refrescar"),!1;let t=e.expires_at*1e3,r=Date.now(),o=t-r,a=5*60*1e3;if(o>a)return console.log("\u{1F504} AuthService: Token a\xFAn v\xE1lido, no es necesario refrescar"),!0;console.log("\u{1F504} AuthService: Token pr\xF3ximo a expirar, refrescando...");let n=this.supabase.auth.refreshSession(),u=new Promise((_,y)=>setTimeout(()=>y(new Error("Refresh timeout")),1e4)),{data:l,error:S}=yield Promise.race([n,u]);return S?(console.error("\u274C AuthService: Error en refresh manual:",S),!1):l.session?(console.log("\u{1F504} AuthService: Token refrescado exitosamente"),l.user&&(yield this.loadUserData(l.user.id)),!0):(console.log("\u{1F504} AuthService: No se pudo refrescar el token"),!1)}catch(e){return console.error("\u274C AuthService: Error en refresh manual:",e),e instanceof Error&&e.message.includes("NavigatorLockAcquireTimeoutError")&&(console.log("\u{1F504} AuthService: Error de lock detectado, limpiando..."),yield this.clearProblematicLocks(),localStorage.setItem("supabase_lock_issue","true")),!1}})}ensureValidToken(){return s(this,null,function*(){try{if(!(yield this.supabaseClientService.ensureConnection()))return console.log("\u{1F527} AuthService: Conexi\xF3n no saludable, no se puede verificar el token"),!1;let{data:{session:t}}=yield this.supabase.auth.getSession();if(!t)return!1;let r=t.expires_at*1e3,o=Date.now(),a=r-o,n=5*60*1e3;return a<=n?yield this.manualRefreshToken():!0}catch(e){return console.error("\u274C AuthService: Error verificando validez del token:",e),!1}})}clearProblematicLocks(){return s(this,null,function*(){try{console.log("\u{1F527} AuthService: Limpiando locks problem\xE1ticos..."),localStorage.getItem("supabase_lock_issue")&&(console.log("\u{1F527} AuthService: Detectados problemas de locks, limpiando..."),localStorage.removeItem("supabase_lock_issue"),Object.keys(localStorage).filter(r=>r.includes("supabase")||r.includes("sb-")||r.includes("auth")||r.includes("token")).forEach(r=>{try{localStorage.removeItem(r),console.log(`\u{1F527} AuthService: Eliminado ${r}`)}catch(o){console.warn(`\u26A0\uFE0F AuthService: Error eliminando ${r}:`,o)}}),yield new Promise(r=>setTimeout(r,1e3)))}catch(e){console.warn("\u26A0\uFE0F AuthService: Error al limpiar locks:",e)}})}debugTokenStatus(){return s(this,null,function*(){try{let{data:{session:e}}=yield this.supabase.auth.getSession();if(!e)return{hasSession:!1,message:"No hay sesi\xF3n activa"};let t=e.expires_at*1e3,r=Date.now(),o=t-r,a=5*60*1e3;return{hasSession:!0,userId:e.user.id,expiresAt:new Date(t).toISOString(),timeUntilExpiry:Math.floor(o/1e3),needsRefresh:o<=a,isExpired:o<=0}}catch(e){return{hasSession:!1,error:e instanceof Error?e.message:"Error desconocido"}}})}debugLocalStorage(){return s(this,null,function*(){try{let e=Object.keys(localStorage).filter(t=>t.includes("supabase")||t.includes("sb-")||t.includes("auth"));return{totalKeys:Object.keys(localStorage).length,supabaseKeys:e,hasLockIssue:localStorage.getItem("supabase_lock_issue")!==null}}catch(e){return{error:e instanceof Error?e.message:"Error desconocido"}}})}forceClearLocks(){return s(this,null,function*(){try{console.log("\u{1F527} AuthService: Forzando limpieza de locks..."),Object.keys(localStorage).filter(t=>t.includes("supabase")||t.includes("sb-")||t.includes("auth")||t.includes("token")).forEach(t=>{try{localStorage.removeItem(t),console.log(`\u{1F527} AuthService: Eliminado ${t}`)}catch(r){console.warn(`\u26A0\uFE0F AuthService: Error eliminando ${t}:`,r)}}),localStorage.setItem("supabase_lock_issue","true"),yield new Promise(t=>setTimeout(t,2e3)),console.log("\u{1F527} AuthService: Limpieza de locks completada")}catch(e){console.error("\u274C AuthService: Error en limpieza forzada:",e)}})}};i.\u0275fac=function(t){return new(t||i)(p(x),p(E),p(v))},i.\u0275prov=b({token:i,factory:i.\u0275fac,providedIn:"root"});let c=i;return c})();export{E as a,R as b};
