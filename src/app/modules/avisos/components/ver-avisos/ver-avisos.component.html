<!-- Loading State -->
<div *ngIf="loading" class="loading-state">
  <div class="loading-spinner">
    <ion-icon name="refresh-outline" class="spinning"></ion-icon>
    <p>Cargando aviso...</p>
  </div>
</div>

<!-- Error State -->
<div *ngIf="error && !loading" class="error-state">
  <div class="error-message">
    <ion-icon name="alert-circle-outline"></ion-icon>
    <p>{{ error }}</p>
    <button class="btn-retry" (click)="cargarAviso()">
      <ion-icon name="refresh-outline"></ion-icon>
      Reintentar
    </button>
  </div>
</div>

<!-- Información General -->
<div *ngIf="aviso && !loading" class="info-card">
  <div class="card-header">
    <div class="header-container">
      <!-- Botón de volver -->
      <div class="back-button">
        <button class="btn-back" (click)="volverALista()">
          <ion-icon name="arrow-back-outline"></ion-icon>
          <span class="desktop-only">Volver</span>
          <span class="mobile-only">Volver</span>
        </button>
      </div>
    </div>
    <div class="header-actions">
      <!-- Botón de recarga forzada -->
      <button class="btn-secondary" (click)="forzarRecargaDatos()" title="Recargar datos">
        <ion-icon name="refresh-outline"></ion-icon>
        <span class="desktop-only">Recargar</span>
        <span class="mobile-only">Recargar</span>
      </button>

      <!-- Solo mostrar botón de completar si el aviso NO está completado -->
      <button *ngIf="aviso?.estado !== 'Completado'" class="btn-secondary" (click)="completarAviso()">
        <ion-icon name="close"></ion-icon>
        <span class="desktop-only">Completar Aviso</span>
        <span class="mobile-only">Completar</span>
      </button>

      <!-- Solo mostrar botón de editar si el aviso NO está completado -->
      <button *ngIf="aviso?.estado !== 'Completado'" class="btn-primary" (click)="editarAviso()">
        <ion-icon name="pencil-outline"></ion-icon>
        <span class="desktop-only">Editar aviso</span>
        <span class="mobile-only">Editar</span>
      </button>

      <!-- Mostrar mensaje cuando el aviso esté completado -->
      <div *ngIf="aviso?.estado === 'Completado'" class="aviso-completado-message">
        <ion-icon name="checkmark-circle-outline"></ion-icon>
        <span>Aviso completado</span>
      </div>
    </div>
    <span class="mobile-only title">Aviso {{aviso.numero_secuencial || aviso.id}} - {{(aviso?.tipo || 'No especificado')
      | titlecase}}</span>
  </div>

  <h2 class="title">
    <span class="desktop-only">Aviso {{aviso.numero_secuencial || aviso.id}} - {{(aviso?.tipo || 'No especificado') |
      titlecase}}</span>
  </h2>

  <div class="info-grid">
    <div class="info-row">
      <div class="info-item">
        <label>Estado</label>
        <span class="estado-pendiente">{{aviso.estado}}</span>
      </div>
      <div class="info-item">
        <label>Urgente</label>
        <span class="urgent-badge" [class.urgent]="aviso.urgencia === 'Alta' || aviso.es_urgente">
          {{aviso.urgencia === 'Alta' || aviso.es_urgente ? 'Sí' : 'No'}}
        </span>
      </div>
      <div class="info-item">
        <label>Fecha de creación</label>
        <span>{{aviso.fecha_creacion | date:'dd/MM/yyyy'}}</span>
      </div>
    </div>

    <div class="descripcion-content">
      <div class="info-item">
        <label>Descripción Detallada del Problema/Petición</label>
        <p class="descripcion-texto">{{aviso?.descripcion_problema}}</p>
      </div>
    </div>


    <div class="info-item cliente-section">
      <label>Cliente</label>
      <div class="cliente-info">
        <span class="cliente-nombre">{{aviso.nombre_cliente_aviso}}</span>
        <a class="ver-cliente" (click)="verCliente()">
          <span class="desktop-only">Ver cliente</span>
        </a>
      </div>
    </div>

    <div class="info-item direccion-section">
      <label>Dirección</label>
      <div class="direccion-info">
        <span class="direccion-texto">{{aviso.direccion_cliente_aviso}}</span>
        <button class="btn-map" (click)="verMapa()" title="Ver en mapa">
          <ion-icon name="navigate"></ion-icon>
        </button>
      </div>
    </div>

    <div class="contacto-section">
      <label>Contacto Cliente</label>
      <div class="contacto-items">
        <div class="contacto-item nombre-contacto" *ngIf="aviso.nombre_contacto">
          <ion-icon name="person"></ion-icon>
          <span>{{aviso.nombre_contacto}}</span>
        </div>
        <div class="contacto-item" *ngIf="aviso.telefono_cliente_aviso">
          <ion-icon name="call"></ion-icon>
          <a href="tel:{{aviso.telefono_cliente_aviso}}" class="contacto-link">{{aviso.telefono_cliente_aviso}}</a>
        </div>
        <div class="contacto-item" *ngIf="aviso.cliente?.email">
          <ion-icon name="mail"></ion-icon>
          <a href="mailto:{{aviso.cliente?.email}}" class="contacto-link">{{aviso.cliente?.email}}</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ================================= -->
<!-- SECCIÓN REORGANIZADA: TRABAJOS Y FLUJO JUNTOS -->
<!-- ================================= -->

<!-- Gestión de Albaranes -->
<div class="info-card">
  <div class="card-header">
    <h2 style="text-wrap: nowrap;">Gestión de Albaranes</h2>
    <div class="header-actions-jobs">
      <button class="btn-primary" (click)="crearAlbaran()">
        <ion-icon name="add-circle"></ion-icon>
        <span class="desktop-only">Crear Albarán</span>
        <span class="mobile-only">Crear Albarán</span>
      </button>
    </div>
  </div>

  <!-- Gestión del Flujo Automático -->
  <div class="flujo-section" *ngIf="aviso?.id">
    <div class="flujo-container">
      <app-flujo-estado [avisoId]="aviso?.id || ''" (accionEjecutada)="onAccionFlujoEjecutada($event)">
      </app-flujo-estado>
    </div>
  </div>

  <!-- Separador visual -->
  <div class="section-divider">
    <hr>
    <span>Albaranes Cerrados</span>
  </div>

  <!-- Albaranes Cerrados - INTEGRADO DENTRO DE GESTIÓN -->
  <div class="albaranes-section">
    <div class="albaranes-container">
      <!-- Mensaje cuando no hay albaranes -->
      <div *ngIf="!aviso?.albaranes || aviso?.albaranes?.length === 0" class="no-albaranes">
        <ion-icon name="document-text-outline"></ion-icon>
        <p>No hay albaranes cerrados para este aviso</p>
        <p class="info-text">Los albaranes aparecerán aquí una vez que se cierren los trabajos realizados</p>
      </div>

      <!-- Tabla compacta de albaranes (similar a avisos) -->
      <div *ngIf="aviso?.albaranes && aviso?.albaranes.length > 0" class="compact-albaranes-table">
        <div class="albaranes-table">
          <div class="table-header">
            <div class="header-row">
              <div class="header-cell">Número</div>
              <div class="header-cell">Estado</div>
              <div class="header-cell">Fecha</div>
              <div class="header-cell">Repuestos</div>
              <div class="header-cell">Acciones</div>
            </div>
          </div>
          <div class="table-body">
            <div *ngFor="let albaran of aviso?.albaranes; let i = index" class="albaran-row" 
                 [ngClass]="{
                   'finalizado': albaran.estado_cierre === 'Finalizado',
                   'presupuesto-pendiente': albaran.estado_cierre === 'Presupuesto pendiente',
                   'otra-visita': albaran.estado_cierre === 'Otra visita'
                 }">
              <div class="albaran-cell numero-albaran">{{i + 1}}</div>
              <div class="albaran-cell estado-albaran">
                <span class="badge" [ngClass]="{
                        'green': albaran.estado_cierre === 'Finalizado',
                        'yellow': albaran.estado_cierre === 'Presupuesto pendiente',
                        'blue': albaran.estado_cierre === 'Otra visita'
                      }">
                  {{ albaran.estado_cierre }}
                </span>
              </div>
              <div class="albaran-cell fecha-albaran">{{albaran.fecha_cierre | date:'dd/MM/yyyy'}}</div>
              <div class="albaran-cell repuestos-albaran">
                <div *ngIf="albaran.repuestos_utilizados && albaran.repuestos_utilizados.length > 0" class="repuestos-info">
                  <span class="repuestos-count">{{albaran.repuestos_utilizados.length}}</span>
                  <span class="repuestos-label">repuestos</span>
                </div>
                <div *ngIf="!albaran.repuestos_utilizados || albaran.repuestos_utilizados.length === 0" class="repuestos-vacio">
                  Sin repuestos
                </div>
              </div>
              <div class="albaran-cell acciones">
                <button class="btn-ver" title="Ver albarán completo" (click)="verAlbaran(albaran)">
                  <ion-icon name="eye-outline"></ion-icon>
                </button>
                <div class="mobile-info" *ngIf="albaran.presupuesto_necesario > 0">
                  <span class="presupuesto-mobile">
                    €{{albaran.presupuesto_necesario | number:'1.2-2'}}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Galería de imágenes -->
<div class="info-card">
  <div class="card-header" style="justify-content: space-between!important;">
    <h2>Galería de imágenes</h2>
    <div class="gallery-actions">
      <!-- <ion-segment [value]="vistaGaleria" (ionChange)="cambiarVistaGaleria($event)" mode="ios">
        <ion-segment-button value="grid">
          <ion-icon name="grid-outline"></ion-icon>
        </ion-segment-button>
        <ion-segment-button value="list">
          <ion-icon name="list-outline"></ion-icon>
        </ion-segment-button>
      </ion-segment> -->
      <button class="btn-primary" (click)="seleccionarImagenes()" [disabled]="subiendoImagenes">
        <ion-icon name="add-circle"></ion-icon>
        <span class="desktop-only">{{ subiendoImagenes ? 'Subiendo...' : 'Añadir imágenes' }}</span>
        <span class="mobile-only">{{ subiendoImagenes ? 'Subiendo...' : 'Añadir' }}</span>
      </button>
      <input #fileInput type="file" multiple accept="image/*" style="display: none;" (change)="onFileSelected($event)">
    </div>
  </div>

  <div class="gallery-items">
    <!-- Indicador de carga al subir imágenes -->
    <div *ngIf="subiendoImagenes" class="uploading-indicator">
      <ion-icon name="refresh-outline" class="spinning"></ion-icon>
      <p>Subiendo imágenes...</p>
    </div>

    <div *ngIf="!aviso?.fotos || aviso?.fotos?.length === 0" class="no-images">
      <ion-icon name="images-outline"></ion-icon>
      <p>No hay imágenes disponibles para este aviso</p>
    </div>
    <div class="gallery-item" *ngFor="let foto of aviso?.fotos">
      <img [src]="foto.url" [alt]="foto.descripcion || 'Imagen del aviso'">
      <div class="image-info">
        <span class="image-title">{{foto.descripcion || 'Imagen del aviso'}}</span>
        <span class="file-info">{{foto.fecha_subida | date:'dd/MM/yyyy HH:mm'}}</span>
      </div>
      <button class="btn-delete" (click)="eliminarFoto(foto)" title="Eliminar imagen">
        <ion-icon name="trash-outline"></ion-icon>
      </button>
    </div>
  </div>
</div>