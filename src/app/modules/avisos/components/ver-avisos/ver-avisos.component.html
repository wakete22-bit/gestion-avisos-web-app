<!-- Loading State -->
<div *ngIf="loading" class="loading-state">
  <div class="loading-spinner">
    <ion-icon name="refresh-outline" class="spinning"></ion-icon>
    <p>Cargando aviso...</p>
  </div>
</div>

<!-- Error State -->
<div *ngIf="error && !loading" class="error-state">
  <div class="error-message">
    <ion-icon name="alert-circle-outline"></ion-icon>
    <p>{{ error }}</p>
    <button class="btn-retry" (click)="cargarAviso()">
      <ion-icon name="refresh-outline"></ion-icon>
      Reintentar
    </button>
  </div>
</div>

<!-- Información General -->
<div *ngIf="aviso && !loading" class="info-card">
  <div class="card-header">
    <div class="header-container">
      <!-- Botón de volver -->
      <div class="back-button">
        <button class="btn-back" (click)="volverALista()">
          <ion-icon name="arrow-back-outline"></ion-icon>
          <span class="desktop-only">Volver</span>
          <span class="mobile-only">Volver</span>
        </button>
      </div>
    </div>
    <div class="header-actions">
      <!-- Solo mostrar botón de completar si el aviso NO está completado -->
      <button 
        *ngIf="aviso?.estado !== 'Completado'" 
        class="btn-secondary" 
        (click)="completarAviso()">
        <ion-icon name="close"></ion-icon>
        <span class="desktop-only">Completar Aviso</span>
        <span class="mobile-only">Completar</span>
      </button>
      
      <!-- Solo mostrar botón de editar si el aviso NO está completado -->
      <button 
        *ngIf="aviso?.estado !== 'Completado'" 
        class="btn-primary" 
        (click)="editarAviso()">
        <ion-icon name="pencil-outline"></ion-icon>
        <span class="desktop-only">Editar aviso</span>
        <span class="mobile-only">Editar</span>
      </button>
      
      <!-- Mostrar mensaje cuando el aviso esté completado -->
      <div *ngIf="aviso?.estado === 'Completado'" class="aviso-completado-message">
        <ion-icon name="checkmark-circle-outline"></ion-icon>
        <span>Aviso completado</span>
      </div>
    </div>
    <span class="mobile-only title">Aviso #{{aviso.id?.substring(0, 8)}}</span>
  </div>

  <h2 class="title">
    <span class="desktop-only">Información general del Aviso - #{{aviso.id?.substring(0, 8)}}</span>
  </h2>

  <div class="info-grid">
    <div class="info-row">
      <div class="info-item">
        <label>Estado</label>
        <span class="estado-pendiente">{{aviso.estado}}</span>
      </div>
      <div class="info-item">
        <label>Urgente</label>
        <span class="urgent-badge" [class.urgent]="aviso.urgencia === 'Alta' || aviso.es_urgente">
          {{aviso.urgencia === 'Alta' || aviso.es_urgente ? 'Sí' : 'No'}}
        </span>
      </div>
      <div class="info-item">
        <label>Fecha de creación</label>
        <span>{{aviso.fecha_creacion | date:'dd/MM/yyyy'}}</span>
      </div>
    </div>

    <div class="info-item cliente-section">
      <label>Cliente</label>
      <div class="cliente-info">
        <span class="cliente-nombre">{{aviso.nombre_cliente_aviso}}</span>
        <a class="ver-cliente" (click)="verCliente()">
          <span class="desktop-only">Ver cliente</span>
        </a>
      </div>
    </div>

    <div class="info-item direccion-section">
      <label>Dirección</label>
      <div class="direccion-info">
        <span class="direccion-texto">{{aviso.direccion_cliente_aviso}}</span>
        <button class="btn-map" (click)="verMapa()" title="Ver en mapa">
          <ion-icon name="navigate"></ion-icon>
        </button>
      </div>
    </div>

    <div class="contacto-section">
      <label>Contacto Cliente</label>
      <div class="contacto-items">
        <div class="contacto-item nombre-contacto" *ngIf="aviso.nombre_contacto">
          <ion-icon name="person"></ion-icon>
          <span>{{aviso.nombre_contacto}}</span>
        </div>
        <div class="contacto-item" *ngIf="aviso.telefono_cliente_aviso">
          <ion-icon name="call"></ion-icon>
          <span>{{aviso.telefono_cliente_aviso}}</span>
        </div>
        <div class="contacto-item" *ngIf="aviso.cliente?.email">
          <ion-icon name="mail"></ion-icon>
          <span>{{aviso.cliente?.email}}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Descripción del Aviso -->
<div class="info-card">
  <div class="card-header" style="justify-content: space-between!important;">
    <h2>Descripción del Aviso</h2>
    <span class="badge-estado-aviso" [class]="getEstadoClass(aviso?.estado)">
      {{aviso?.estado || 'Pendiente'}}
    </span>
  </div>

  <div class="descripcion-content">
    <div class="info-item">
      <label>Tipo de Aviso</label>
      <p class="tipo-aviso">{{aviso?.tipo || 'No especificado'}}</p>
    </div>

    <div class="info-item">
      <label>Descripción Detallada del Problema/Petición</label>
      <p class="descripcion-texto">{{aviso?.descripcion_problema}}</p>
    </div>
  </div>
</div>

<!-- ================================= -->
<!-- SECCIÓN REORGANIZADA: TRABAJOS Y FLUJO JUNTOS -->
<!-- ================================= -->

<!-- Trabajos Realizados y Gestión del Flujo -->
<div class="info-card">
  <div class="card-header">
    <h2 style="text-wrap: nowrap;">Gestión de Albaranes</h2>
    <div class="header-actions-jobs">
      <button class="btn-primary" (click)="crearTrabajoRealizado()">
        <ion-icon name="add-circle"></ion-icon>
        <span class="desktop-only">Crear parte de trabajo</span>
        <span class="mobile-only">Crear trabajo</span>
      </button>
    </div>
  </div>

  <!-- Gestión del Flujo Automático - MOVIDO AQUÍ -->
  <div class="flujo-section" *ngIf="aviso?.id">
    <div class="flujo-container">
      <app-flujo-estado [avisoId]="aviso?.id || ''" (accionEjecutada)="onAccionFlujoEjecutada($event)">
      </app-flujo-estado>
    </div>
  </div>

  <!-- Separador visual -->
  <div class="section-divider">
    <span>Lista de Trabajos Registrados</span>
  </div>

  <!-- Tabla de trabajos realizados -->
  <div class="table-container">
    <!-- Loading State -->
    <div *ngIf="loadingTrabajos" class="loading-state">
      <div class="loading-spinner">
        <ion-icon name="refresh-outline" class="spinning"></ion-icon>
        <p>Cargando trabajos...</p>
      </div>
    </div>

    <!-- No hay trabajos -->
    <div *ngIf="!loadingTrabajos && (!trabajosRealizados || trabajosRealizados.length === 0)" class="no-trabajos">
      <div class="empty-state">
        <ion-icon name="construct-outline"></ion-icon>
        <p>No hay trabajos realizados para este aviso</p>
        <small>Crea el primer parte de trabajo para comenzar</small>
      </div>
    </div>

    <!-- Tabla de trabajos -->
    <table *ngIf="!loadingTrabajos && trabajosRealizados.length > 0" class="custom-mat-table">
      <thead>
        <tr>
          <th>Número</th>
          <th>Fecha trabajo</th>
          <th>Horas</th>
          <th>Descripción</th>
          <th>Materiales</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let trabajo of trabajosRealizados; let i = index">
          <td data-label="Número">#{{i + 1}}</td>
          <td data-label="Fecha trabajo">{{trabajo.fecha_trabajo | date:'dd/MM/yyyy'}}</td>
          <td data-label="Horas">{{calcularHorasTrabajo(trabajo) | number:'1.1-1'}}h</td>
          <td data-label="Descripción">
            <div class="descripcion-trabajo">
              <p>{{trabajo.descripcion}}</p>
              <small>{{trabajo.hora_inicio}} - {{trabajo.hora_fin}}</small>
            </div>
          </td>
          <td data-label="Materiales">
            <div class="materiales-info">
              <!-- Mostrar materiales con cantidades reales si están disponibles -->
              <ul class="repuestos-list" *ngIf="trabajo.materiales && trabajo.materiales.length > 0">
                <li *ngFor="let material of trabajo.materiales">
                  {{material.material?.nombre || 'Material'}}: {{material.cantidad_utilizada}} {{material.material?.unidad || 'unidad'}}
                </li>
              </ul>
              <!-- Fallback a repuestos básicos si no hay materiales detallados -->
              <ul class="repuestos-list" *ngIf="(!trabajo.materiales || trabajo.materiales.length === 0) && trabajo.repuestos && trabajo.repuestos.length > 0">
                <li *ngFor="let repuesto of trabajo.repuestos">{{repuesto}}</li>
              </ul>
              <span *ngIf="(!trabajo.materiales || trabajo.materiales.length === 0) && (!trabajo.repuestos || trabajo.repuestos.length === 0)" class="no-repuestos">
                Sin materiales
              </span>
            </div>
          </td>
          <td data-label="Estado">
            <span class="badge-estado" [class]="'badge-' + trabajo.estado.toLowerCase().replace(' ', '-')">
              {{trabajo.estado}}
            </span>
          </td>
          <td data-label="Acciones">
            <div class="estado-actions">
              <!-- Botón de Hacer Albarán (solo si el trabajo está en estado "En curso" o "Abierto") -->
              <button 
                *ngIf="trabajo.estado === 'En curso' || trabajo.estado === 'Abierto'"
                class="btn-primary btn-small" 
                (click)="hacerAlbaran(trabajo)" 
                title="Hacer albarán">
                <ion-icon name="document-text-outline"></ion-icon>
                <span class="desktop-only">Crear Albarán</span>
                <span class="mobile-only">Albarán</span>
              </button>
              
              <!-- Mostrar información del albarán si existe -->
              <div *ngIf="trabajo.albaran_id" class="albaran-info">
                <span class="badge-albaran" [class]="'badge-' + getAlbaranEstado(trabajo)">
                  <ion-icon name="checkmark-circle-outline"></ion-icon>
                  Albarán Cerrado
                </span>
                <small class="albaran-details">
                  {{ getAlbaranEstado(trabajo) }}
                </small>
              </div>
              
              <!-- Botón de Editar (solo si no está cerrado) -->
              <button 
                *ngIf="trabajo.estado !== 'Cerrado' && trabajo.estado !== 'Finalizado'"
                class="btn-secondary btn-small" 
                (click)="editarTrabajo(trabajo)" 
                title="Editar trabajo">
                <ion-icon name="pencil-outline"></ion-icon>
                <span class="desktop-only">Editar</span>
                <span class="mobile-only">Editar</span>
              </button>
              
              <!-- Botón de Eliminar (solo si no está cerrado) -->
              <button 
                *ngIf="trabajo.estado !== 'Cerrado' && trabajo.estado !== 'Finalizado'"
                class="btn-danger btn-small" 
                (click)="eliminarTrabajo(trabajo)" 
                title="Eliminar trabajo">
                <ion-icon name="trash-outline"></ion-icon>
                <span class="desktop-only">Eliminar</span>
                <span class="mobile-only">Eliminar</span>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Albaranes Cerrados -->
<div class="info-card" *ngIf="aviso && aviso.albaranes && aviso.albaranes.length > 0">
  <div class="card-header">
    <h2>Albaranes Cerrados</h2>
    <div class="header-actions">
      <span class="badge-info">Total: {{aviso.albaranes.length}}</span>
    </div>
  </div>

  <div class="albaranes-container">
    <div class="albaran-item" *ngFor="let albaran of aviso.albaranes; let i = index">
      <div class="albaran-header">
        <div class="albaran-info">
          <h4>Albarán #{{i + 1}}</h4>
          <span class="fecha-albaran">{{albaran.fecha_cierre | date:'dd/MM/yyyy'}}</span>
        </div>
        <div class="estado-albaran">
          <span class="badge-estado" [class]="'badge-' + albaran.estado_cierre.toLowerCase().replace(' ', '-')">
            {{albaran.estado_cierre}}
          </span>
        </div>
      </div>
      
      <div class="albaran-details">
        <div class="detail-row">
          <div class="detail-item">
            <label>Horario:</label>
            <span>{{albaran.hora_entrada}} - {{albaran.hora_salida}}</span>
          </div>
          <div class="detail-item" *ngIf="albaran.presupuesto_necesario > 0">
            <label>Presupuesto:</label>
            <span>{{albaran.presupuesto_necesario | currency:'EUR':'symbol':'1.2-2'}}</span>
          </div>
        </div>
        
        <div class="detail-item full-width">
          <label>Descripción del trabajo:</label>
          <p>{{albaran.descripcion_trabajo_realizado}}</p>
        </div>
        
        <div class="detail-item full-width" *ngIf="albaran.repuestos_utilizados && albaran.repuestos_utilizados.length > 0">
          <label>Repuestos utilizados:</label>
          <div class="repuestos-tags">
            <!-- Mostrar repuestos con cantidades reales si están disponibles -->
            <span class="repuesto-tag" *ngFor="let repuesto of albaran.repuestos_utilizados">
              <ng-container *ngIf="repuesto.cantidad; else repuestoBasico">
                {{repuesto.nombre}}: {{repuesto.cantidad}} {{repuesto.unidad || 'unidad'}}
              </ng-container>
              <ng-template #repuestoBasico>
                {{repuesto}}
              </ng-template>
            </span>
          </div>
        </div>
        
        <div class="detail-row" *ngIf="albaran.dni_cliente || albaran.nombre_firma">
          <div class="detail-item" *ngIf="albaran.dni_cliente">
            <label>DNI Cliente:</label>
            <span>{{albaran.dni_cliente}}</span>
          </div>
          <div class="detail-item" *ngIf="albaran.nombre_firma">
            <label>Firmado por:</label>
            <span>{{albaran.nombre_firma}}</span>
          </div>
        </div>
        
        <div class="detail-item full-width" *ngIf="albaran.observaciones">
          <label>Observaciones:</label>
          <p>{{albaran.observaciones}}</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Galería de imágenes -->
<div class="info-card">
  <div class="card-header" style="justify-content: space-between!important;">
    <h2>Galería de imágenes</h2>
    <div class="gallery-actions">
      <!-- <ion-segment [value]="vistaGaleria" (ionChange)="cambiarVistaGaleria($event)" mode="ios">
        <ion-segment-button value="grid">
          <ion-icon name="grid-outline"></ion-icon>
        </ion-segment-button>
        <ion-segment-button value="list">
          <ion-icon name="list-outline"></ion-icon>
        </ion-segment-button>
      </ion-segment> -->
      <button class="btn-primary" (click)="seleccionarImagenes()" [disabled]="subiendoImagenes">
        <ion-icon name="add-circle"></ion-icon>
        <span class="desktop-only">{{ subiendoImagenes ? 'Subiendo...' : 'Añadir imágenes' }}</span>
        <span class="mobile-only">{{ subiendoImagenes ? 'Subiendo...' : 'Añadir' }}</span>
      </button>
      <input #fileInput type="file" multiple accept="image/*" style="display: none;" (change)="onFileSelected($event)">
    </div>
  </div>

  <div class="gallery-items">
    <!-- Indicador de carga al subir imágenes -->
    <div *ngIf="subiendoImagenes" class="uploading-indicator">
      <ion-icon name="refresh-outline" class="spinning"></ion-icon>
      <p>Subiendo imágenes...</p>
    </div>

    <div *ngIf="!aviso?.fotos || aviso?.fotos?.length === 0" class="no-images">
      <ion-icon name="images-outline"></ion-icon>
      <p>No hay imágenes disponibles para este aviso</p>
    </div>
    <div class="gallery-item" *ngFor="let foto of aviso?.fotos">
      <img [src]="foto.url" [alt]="foto.descripcion || 'Imagen del aviso'">
      <div class="image-info">
        <span class="image-title">{{foto.descripcion || 'Imagen del aviso'}}</span>
        <span class="file-info">{{foto.fecha_subida | date:'dd/MM/yyyy HH:mm'}}</span>
      </div>
      <button class="btn-delete" (click)="eliminarFoto(foto)" title="Eliminar imagen">
        <ion-icon name="trash-outline"></ion-icon>
      </button>
    </div>
  </div>
</div>
