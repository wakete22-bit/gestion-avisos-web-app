<!-- Loading State -->
<div *ngIf="loading" class="loading-state">
  <div class="loading-spinner">
    <ion-icon name="refresh-outline" class="spinning"></ion-icon>
    <p>Cargando aviso...</p>
  </div>
</div>

<!-- Error State -->
<div *ngIf="error && !loading" class="error-state">
  <div class="error-message">
    <ion-icon name="alert-circle-outline"></ion-icon>
    <p>{{ error }}</p>
    <button class="btn-retry" (click)="cargarAviso()">
      <ion-icon name="refresh-outline"></ion-icon>
      Reintentar
    </button>
  </div>
</div>

<!-- Información General -->
<div *ngIf="aviso && !loading" class="info-card">
  <div class="card-header">
    <div class="header-container" style="display: flex; justify-content: center; align-items: center; gap: 20px;">
      <!-- Botón de volver -->
      <div class="back-button" style="margin-bottom: 0px;">
        <button class="btn-back" (click)="volverALista()">
          <ion-icon name="arrow-back-outline"></ion-icon>
          Volver
        </button>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn-secondary" (click)="cerrarAlbaran()">
        <ion-icon name="close"></ion-icon>
        Cerrar Albarán
      </button>
      <button class="btn-primary" (click)="editarAviso()">
        <ion-icon name="pencil-outline"></ion-icon>
        Editar aviso
      </button>
    </div>
  </div>

  <h2 class="title">Información general del Aviso - #{{aviso.id?.substring(0, 8)}}</h2>

  <div class="info-grid">
    <div class="info-row">
      <div class="info-item">
        <label>Estado</label>
        <span class="estado-pendiente">{{aviso.estado}}</span>
      </div>
      <div class="info-item">
        <label>Urgente</label>
        <span>{{aviso.urgencia === 'Alta' || aviso.es_urgente ? 'Sí' : 'No'}}</span>
      </div>
      <div class="info-item">
        <label>Fecha de creación</label>
        <span>{{aviso.fecha_creacion | date:'dd/MM/yyyy'}}</span>
      </div>
    </div>

    <div class="info-item cliente-section">
      <label>Cliente</label>
      <div class="cliente-info">
        <span>{{aviso.nombre_cliente_aviso}}</span>
        <a class="ver-cliente" (click)="verCliente()">Ver cliente</a>
      </div>
    </div>

    <div class="info-item direccion-section">
      <label>Dirección</label>
      <div class="direccion-info">
        <span>{{aviso.direccion_cliente_aviso}}</span>
        <button class="btn-map" (click)="verMapa()">
          <ion-icon name="navigate"></ion-icon>
        </button>
      </div>
    </div>

    <div class="contacto-section">
      <label>Contacto Cliente</label>
      <div class="contacto-items">
        <div class="contacto-item">
          <ion-icon name="person"></ion-icon>
          <span>{{aviso.nombre_contacto}}</span>
        </div>
        <div class="contacto-item">
          <ion-icon name="call"></ion-icon>
          <span>{{aviso.telefono_cliente_aviso}}</span>
        </div>
        <div class="contacto-item" *ngIf="aviso.cliente?.email">
          <ion-icon name="mail"></ion-icon>
          <span>{{aviso.cliente?.email}}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Descripción del Aviso -->
<div class="info-card">
  <div class="card-header">
    <h2>Descripción del Aviso</h2>
    <span class="badge-pendiente">{{aviso?.estado || 'No especificado'}}</span>
  </div>

  <div class="descripcion-content">
    <div class="info-item">
      <label>Tipo de Aviso</label>
      <p>{{aviso?.tipo || 'No especificado'}}</p>
    </div>

    <div class="info-item">
      <label>Descripción Detallada del Problema/Petición</label>
      <p>{{aviso?.descripcion_problema}}</p>
    </div>
  </div>
</div>

<!-- Galería de imágenes -->
<div class="info-card">
  <div class="card-header">
    <h2>Galería de imágenes</h2>
    <div class="gallery-actions">
      <ion-segment [value]="vistaGaleria" (ionChange)="cambiarVistaGaleria($event)" mode="ios">
        <ion-segment-button value="grid">
          <ion-icon name="grid-outline"></ion-icon>
        </ion-segment-button>
        <ion-segment-button value="list">
          <ion-icon name="list-outline"></ion-icon>
        </ion-segment-button>
      </ion-segment>
      <button class="btn-primary" (click)="seleccionarImagenes()" [disabled]="subiendoImagenes">
        <ion-icon name="add-circle"></ion-icon>
        {{ subiendoImagenes ? 'Subiendo...' : 'Añadir imágenes' }}
      </button>
      <input #fileInput type="file" multiple accept="image/*" style="display: none;" (change)="onFileSelected($event)">
    </div>
  </div>

  <div class="gallery-items">
    <!-- Indicador de carga al subir imágenes -->
    <div *ngIf="subiendoImagenes" class="uploading-indicator">
      <ion-icon name="refresh-outline" class="spinning"></ion-icon>
      <p>Subiendo imágenes...</p>
    </div>

    <div *ngIf="!aviso?.fotos || aviso?.fotos?.length === 0" class="no-images">
      <p>No hay imágenes disponibles para este aviso</p>
    </div>
    <div class="gallery-item" *ngFor="let foto of aviso?.fotos">
      <img [src]="foto.url" [alt]="foto.descripcion || 'Imagen del aviso'">
      <div class="image-info">
        <span>{{foto.descripcion || 'Imagen del aviso'}}</span>
        <span class="file-info">{{foto.fecha_subida | date:'dd/MM/yyyy HH:mm'}}</span>
      </div>
      <button class="btn-delete" (click)="eliminarFoto(foto)" title="Eliminar imagen">
        <ion-icon name="trash-outline"></ion-icon>
      </button>
    </div>
  </div>
</div>

<!-- ================================= -->
<!-- SECCIÓN REORGANIZADA: TRABAJOS Y FLUJO JUNTOS -->
<!-- ================================= -->

<!-- Trabajos Realizados y Gestión del Flujo -->
<div class="info-card">
  <div class="card-header">
    <h2>Trabajos Realizados y Gestión del Flujo</h2>
    <div class="header-actions">
      <button class="btn-primary" (click)="crearTrabajoRealizado()">
        <ion-icon name="add-circle"></ion-icon>
        Crear parte de trabajo
      </button>
    </div>
  </div>

  <!-- Gestión del Flujo Automático - MOVIDO AQUÍ -->
  <div class="flujo-section" *ngIf="aviso?.id">
    <div class="flujo-container">
      <app-flujo-estado [avisoId]="aviso?.id || ''" (accionEjecutada)="onAccionFlujoEjecutada($event)">
      </app-flujo-estado>
    </div>
  </div>

  <!-- Separador visual -->
  <div class="section-divider">
    <span>Lista de Trabajos Registrados</span>
  </div>

  <!-- Tabla de trabajos realizados -->
  <div class="table-container">
    <!-- Loading State -->
    <div *ngIf="loadingTrabajos" class="loading-state">
      <div class="loading-spinner">
        <ion-icon name="refresh-outline" class="spinning"></ion-icon>
        <p>Cargando trabajos...</p>
      </div>
    </div>

    <!-- No hay trabajos -->
    <div *ngIf="!loadingTrabajos && (!trabajosRealizados || trabajosRealizados.length === 0)" class="no-trabajos">
      <div class="empty-state">
        <ion-icon name="construct-outline"></ion-icon>
        <p>No hay trabajos realizados para este aviso</p>
        <small>Crea el primer parte de trabajo para comenzar</small>
      </div>
    </div>

    <!-- Tabla de trabajos -->
    <table *ngIf="!loadingTrabajos && trabajosRealizados.length > 0" class="custom-mat-table">
      <thead>
        <tr>
          <th>Número</th>
          <th>Fecha trabajo</th>
          <th>Horas</th>
          <th>Descripción</th>
          <th>Materiales</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let trabajo of trabajosRealizados; let i = index">
          <td>#{{i + 1}}</td>
          <td>{{trabajo.fecha_trabajo | date:'dd/MM/yyyy'}}</td>
          <td>{{calcularHorasTrabajo(trabajo) | number:'1.1-1'}}h</td>
          <td>
            <div class="descripcion-trabajo">
              <p>{{trabajo.descripcion}}</p>
              <small>{{trabajo.hora_inicio}} - {{trabajo.hora_fin}}</small>
            </div>
          </td>
          <td>
            <div class="materiales-info">
              <ul class="repuestos-list" *ngIf="trabajo.repuestos && trabajo.repuestos.length > 0">
                <li *ngFor="let repuesto of trabajo.repuestos">{{repuesto}}</li>
              </ul>
              <span *ngIf="!trabajo.repuestos || trabajo.repuestos.length === 0" class="no-repuestos">
                Sin materiales
              </span>
            </div>
          </td>
          <td>
            <span class="badge-estado" [class]="'badge-' + trabajo.estado.toLowerCase().replace(' ', '-')">
              {{trabajo.estado}}
            </span>
          </td>
          <td>
            <div class="estado-actions">
              <button class="btn-secondary btn-small" (click)="editarTrabajo(trabajo)" title="Editar trabajo">
                <ion-icon name="pencil-outline"></ion-icon>
                Editar
              </button>
              <button class="btn-danger btn-small" (click)="eliminarTrabajo(trabajo)" title="Eliminar trabajo">
                <ion-icon name="trash-outline"></ion-icon>
                Eliminar
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>