<ion-content>
  <div class="presupuesto-container">
    <!-- Header -->
    <div class="page-header">
      <button class="btn-back" (click)="volver()">
        <ion-icon name="arrow-back-outline"></ion-icon>
        Volver
      </button>
      <h1>{{ modoEdicion ? 'Editar Presupuesto' : 'Crear Presupuesto' }}</h1>
    </div>

    <!-- Estado de carga -->
    <div *ngIf="loading && modoEdicion" class="loading-state">
      <div class="loading-spinner">
        <ion-icon name="refresh-outline" class="spinning"></ion-icon>
        <p>Cargando presupuesto...</p>
      </div>
    </div>

    <!-- Información del Aviso -->
    <div class="aviso-info" *ngIf="aviso && !loading">
      <h2>Aviso: #{{ aviso.id?.substring(0, 8) }}</h2>
      <p><strong>Cliente:</strong> {{ aviso.nombre_cliente_aviso }}</p>
      <p><strong>Descripción:</strong> {{ aviso.descripcion_problema }}</p>
    </div>

    <!-- Formulario -->
    <form [formGroup]="presupuestoForm" (ngSubmit)="guardarPresupuesto()">
      <div class="form-section">
        <h3>Estimación de Trabajo</h3>
        
        <div class="form-group">
          <label>Horas estimadas</label>
          <input 
            type="number" 
            formControlName="horas_estimadas"
            (input)="calcularTotal()"
            min="0"
            step="0.5"
            placeholder="0.0">
        </div>

        <div class="form-group">
          <label>Total estimado (€)</label>
          <input 
            type="number" 
            formControlName="total_estimado"
            min="0"
            step="0.01"
            placeholder="0.00">
        </div>
      </div>

      <!-- Materiales -->
      <div class="form-section">
        <div class="section-header">
          <h3>Materiales Estimados</h3>
          <button type="button" class="btn-add" (click)="agregarMaterial()">
            <ion-icon name="add-circle-outline"></ion-icon>
            Agregar Material
          </button>
        </div>

        <div class="materiales-list" *ngIf="materiales.length > 0">
          <div class="material-item" *ngFor="let material of materiales; let i = index">
            <div class="material-fields">
              <input 
                type="text" 
                [(ngModel)]="material.material_id"
                [ngModelOptions]="{standalone: true}"
                placeholder="ID del material">
              
              <input 
                type="number" 
                [(ngModel)]="material.cantidad_estimada"
                [ngModelOptions]="{standalone: true}"
                (input)="calcularTotal()"
                min="1"
                placeholder="Cantidad">
              
              <input 
                type="number" 
                [(ngModel)]="material.precio_unitario_al_momento"
                [ngModelOptions]="{standalone: true}"
                (input)="calcularTotal()"
                min="0"
                step="0.01"
                placeholder="Precio unitario">
            </div>
            
            <button type="button" class="btn-remove" (click)="eliminarMaterial(i)">
              <ion-icon name="trash-outline"></ion-icon>
            </button>
          </div>
        </div>

        <div class="no-materiales" *ngIf="materiales.length === 0">
          <p>No se han agregado materiales al presupuesto</p>
        </div>
      </div>

      <!-- Botones -->
      <div class="form-actions">
        <button type="button" class="btn-secondary" (click)="volver()">
          Cancelar
        </button>
        <button type="submit" class="btn-primary" [disabled]="!presupuestoForm.valid || loading">
          <ion-icon name="save-outline"></ion-icon>
          {{ loading ? 'Guardando...' : (modoEdicion ? 'Actualizar Presupuesto' : 'Guardar Presupuesto') }}
        </button>
      </div>
    </form>
  </div>
</ion-content> 