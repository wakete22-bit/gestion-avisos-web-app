<ion-content>
  <div class="presupuesto-container">
    <!-- Header -->
    <div class="page-header">
      <button class="btn-back" (click)="volver()">
        <ion-icon name="arrow-back-outline"></ion-icon>
        Volver
      </button>
      <h1>{{ modoEdicion ? 'Editar Presupuesto' : 'Crear Presupuesto' }}</h1>
    </div>

    <!-- Estado de carga -->
    <div *ngIf="loading && modoEdicion" class="loading-state">
      <div class="loading-spinner">
        <ion-icon name="refresh-outline" class="spinning"></ion-icon>
        <p>Cargando presupuesto...</p>
      </div>
    </div>

    <!-- Información del Aviso -->
    <div class="aviso-info" *ngIf="aviso && !loading">
      <h2>Aviso: #{{ aviso.id?.substring(0, 8) }}</h2>
      <p><strong>Cliente:</strong> {{ aviso.nombre_cliente_aviso }}</p>
      <p><strong>Descripción:</strong> {{ aviso.descripcion_problema }}</p>
    </div>

    <!-- Formulario -->
    <form [formGroup]="presupuestoForm" (ngSubmit)="guardarPresupuesto()">
      <div class="form-section">
        <h3>Estimación de Trabajo</h3>
        
        <div class="form-group">
          <label>Horas estimadas</label>
          <input 
            type="number" 
            formControlName="horas_estimadas"
            (input)="calcularTotal()"
            min="0"
            step="0.5"
            placeholder="0.0">
          <div *ngIf="presupuestoForm.get('horas_estimadas')?.invalid && presupuestoForm.get('horas_estimadas')?.touched" class="error-message">
            <span *ngIf="presupuestoForm.get('horas_estimadas')?.errors?.['required']">Las horas estimadas son requeridas</span>
            <span *ngIf="presupuestoForm.get('horas_estimadas')?.errors?.['min']">Las horas deben ser mayor o igual a 0</span>
            <span *ngIf="presupuestoForm.get('horas_estimadas')?.errors?.['max']">Las horas no pueden exceder 1000</span>
          </div>
        </div>

        <div class="form-group">
          <label>Total estimado (€)</label>
          <input 
            type="number" 
            formControlName="total_estimado"
            min="0"
            step="0.01"
            placeholder="0.00">
          <div *ngIf="presupuestoForm.get('total_estimado')?.invalid && presupuestoForm.get('total_estimado')?.touched" class="error-message">
            <span *ngIf="presupuestoForm.get('total_estimado')?.errors?.['required']">El total estimado es requerido</span>
            <span *ngIf="presupuestoForm.get('total_estimado')?.errors?.['min']">El total debe ser mayor o igual a 0</span>
            <span *ngIf="presupuestoForm.get('total_estimado')?.errors?.['max']">El total no puede exceder 1,000,000</span>
          </div>
        </div>
      </div>

      <!-- Materiales -->
      <div class="form-section">
        <div class="section-header">
          <h3>Materiales Estimados</h3>
          <div class="header-actions">
            <button type="button" class="btn-select-inventory" (click)="abrirSelectorMateriales()">
              <ion-icon name="list-outline"></ion-icon>
              Seleccionar del Inventario
            </button>
            <button type="button" class="btn-add" (click)="agregarMaterial()">
              <ion-icon name="add-circle-outline"></ion-icon>
              Agregar Manualmente
            </button>
          </div>
        </div>

        <!-- Selector de materiales del inventario -->
        <div *ngIf="mostrarSelectorMateriales" class="inventory-selector">
          <div class="selector-header">
            <h4>Seleccionar Materiales del Inventario</h4>
            <button type="button" class="btn-close" (click)="cerrarSelectorMateriales()">
              <ion-icon name="close"></ion-icon>
            </button>
          </div>
          
          <!-- Búsqueda de productos -->
          <div class="search-container">
            <input 
              type="text" 
              [(ngModel)]="busquedaProducto"
              (input)="filtrarProductos($event)"
              placeholder="Buscar productos..."
              class="search-input">
            <ion-icon name="search-outline"></ion-icon>
          </div>

          <!-- Estado de carga de productos -->
          <div *ngIf="loadingProductos" class="loading-products">
            <ion-icon name="refresh-outline" class="spinning"></ion-icon>
            <span>Cargando productos...</span>
          </div>

          <!-- Error al cargar productos -->
          <div *ngIf="errorProductos" class="error-products">
            <ion-icon name="alert-circle-outline"></ion-icon>
            <span>{{ errorProductos }}</span>
          </div>

          <!-- Lista de productos -->
          <div *ngIf="!loadingProductos && !errorProductos" class="products-list">
            <div 
              *ngFor="let producto of productosFiltrados" 
              class="product-item"
              (click)="agregarMaterialDelInventario(producto)">
              <div class="product-info">
                <div class="product-header">
                  <span class="product-code">{{ producto.codigo }}</span>
                  <span class="product-price">{{ producto.precio_neto | currency:'EUR':'symbol':'1.2-2' }}</span>
                </div>
                <span class="product-name">{{ producto.nombre }}</span>
                <div class="product-details">
                  <span class="product-stock">Stock: {{ producto.cantidad_disponible }} {{ producto.unidad }}</span>
                  <span class="product-description">{{ producto.descripcion }}</span>
                </div>
              </div>
              <ion-icon name="add-circle-outline" class="add-icon"></ion-icon>
            </div>
          </div>

          <!-- Sin productos -->
          <div *ngIf="!loadingProductos && !errorProductos && productosFiltrados.length === 0" class="no-products">
            <ion-icon name="cube-outline"></ion-icon>
            <p>No se encontraron productos</p>
          </div>
        </div>

        <!-- Lista de materiales añadidos -->
        <div class="materiales-list" *ngIf="materiales.length > 0">
          <h4>Materiales añadidos</h4>
          <div class="material-item" *ngFor="let material of materiales; let i = index">
            <div class="material-info">
              <div class="material-header">
                <span class="material-name">{{ getNombreProducto(material.material_id) }}</span>
                <span class="material-price">{{ material.precio_neto_al_momento | currency:'EUR':'symbol':'1.2-2' }}</span>
              </div>
              <div class="material-fields">
                <div class="field-group">
                  <label>Cantidad:</label>
                  <input 
                    type="number" 
                    [value]="material.cantidad_estimada"
                    (change)="actualizarCantidadMaterial(i, $event)"
                    min="1"
                    class="quantity-input">
                </div>
                
                <div class="field-group">
                  <label>Precio unitario:</label>
                  <input 
                    type="number" 
                    [value]="material.precio_neto_al_momento"
                    (input)="actualizarPrecioMaterial(i, $event)"
                    min="0"
                    step="0.01"
                    placeholder="0.00">
                </div>
              </div>
            </div>
            
            <button type="button" class="btn-remove" (click)="eliminarMaterial(i)">
              <ion-icon name="trash-outline"></ion-icon>
            </button>
          </div>

          <!-- Resumen de costos -->
          <div class="costo-total">
            <strong>Costo total de materiales: {{ calcularCostoTotalMateriales() | currency:'EUR':'symbol':'1.2-2' }}</strong>
          </div>
        </div>

        <div class="no-materiales" *ngIf="materiales.length === 0">
          <p>No se han agregado materiales al presupuesto</p>
        </div>
      </div>

      <!-- Botones -->
      <div class="form-actions">
        <button type="button" class="btn-secondary" (click)="volver()">
          Cancelar
        </button>
        <button 
          type="submit" 
          class="btn-primary" 
          [disabled]="!presupuestoForm.valid || loading || !avisoId"
          [class.btn-disabled]="!presupuestoForm.valid || loading || !avisoId">
          <ion-icon name="save-outline"></ion-icon>
          {{ loading ? 'Guardando...' : (modoEdicion ? 'Actualizar Presupuesto' : 'Guardar Presupuesto') }}
        </button>
      </div>
      
      <!-- Información de estado -->
      <div *ngIf="!presupuestoForm.valid && presupuestoForm.touched" class="form-status">
        <p class="status-error">Por favor, complete todos los campos requeridos correctamente</p>
      </div>
      <div *ngIf="!avisoId" class="form-status">
        <p class="status-error">No se ha seleccionado un aviso</p>
      </div>
    </form>
  </div>
</ion-content> 