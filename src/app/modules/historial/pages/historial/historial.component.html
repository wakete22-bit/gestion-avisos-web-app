<ion-content>  
  <section class="dashboard-table">
    <!-- Header Section -->
    <div class="table-header">
      <div class="table-header-left">
        <div class="table-title">Tabla de servicios completados</div>
        <div class="table-meta">Servicios completados: {{ totalAvisos }}</div>  
      </div>
      
      <!-- Mobile Search Bar -->
      <div class="mobile-search">
        <input type="text" placeholder="Buscar servicio..." />
        <ion-icon name="search-outline"></ion-icon>
      </div>

      <!-- Desktop Search and Actions -->
      <div class="table-search desktop-only">
        <input type="text" placeholder="Buscar..." />
        <select>
          <option>Ordenar por: Recientes</option>
        </select>
        <div class="header-actions">
          <button class="btn-add">
            <ion-icon name="eye-outline" style="font-size: 18px;"></ion-icon>
            Ver facturas
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile Actions -->
    <div class="mobile-actions">
      <select class="mobile-filter">
        <option>Ordenar: Recientes</option>
        <option>Ordenar: Antiguos</option>
        <option>Ordenar: Urgentes</option>
      </select>
      <div class="mobile-buttons">
        <button class="btn-add">
          Ver facturas
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-state">
      <div class="loading-spinner">
        <ion-icon name="refresh-outline" class="spinning"></ion-icon>
        <p>Cargando historial...</p>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="error-state">
      <div class="error-message">
        <ion-icon name="alert-circle-outline"></ion-icon>
        <p>{{ error }}</p>
        <button class="btn-retry" (click)="refrescarHistorial()">
          <ion-icon name="refresh-outline"></ion-icon>
          Reintentar
        </button>
      </div>
    </div>

    <!-- Compact Table View (grid, igual que avisos) -->
    <div *ngIf="!loading && !error" class="compact-historial-table">
      <div class="historial-table">
        <div class="table-header">
          <div class="header-row">
            <div class="header-cell">Número</div>
            <div class="header-cell">Cliente</div>
            <div class="header-cell">Detalle</div>
            <div class="header-cell desktop-only">Fecha</div>
            <div class="header-cell desktop-only">Urgente</div>
            <div class="header-cell desktop-only">Dirección</div>
            <div class="header-cell">Acciones</div>
          </div>
        </div>
        <div class="table-body">
          <div *ngFor="let aviso of avisos" class="aviso-row"
               [ngClass]="{
                 'en-curso': aviso.estado === 'En curso',
                 'pendiente': aviso.estado === 'Pendiente',
                 'completado': aviso.estado === 'Completado'
               }">
            <div class="aviso-cell numero-aviso">#{{ aviso.id?.substring(0, 8) || 'N/A' }}</div>
            <div class="aviso-cell nombre-cliente">{{ aviso.nombre_cliente_aviso }}</div>
            <div class="aviso-cell detalle-servicio">
              <div class="detalle-texto" [title]="aviso.descripcion_problema">{{ aviso.descripcion_problema }}</div>
            </div>
            <div class="aviso-cell fecha-aviso desktop-only">{{ aviso.fecha_creacion | date:'dd/MM/yyyy' }}</div>
            <div class="aviso-cell urgente-aviso desktop-only">
              <ion-icon *ngIf="aviso.urgencia === 'Alta' || aviso.es_urgente" name="alert-circle" class="urgente-icon" title="Aviso urgente"></ion-icon>
              <ion-icon *ngIf="aviso.urgencia !== 'Alta' && !aviso.es_urgente" name="close" class="no-urgente-icon" title="No urgente"></ion-icon>
            </div>
            <div class="aviso-cell direccion-aviso desktop-only">{{ aviso.direccion_cliente_aviso }}</div>
            <div class="aviso-cell acciones">
              <button class="btn-ver" title="Ver detalles">
                <ion-icon name="eye-outline"></ion-icon>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div *ngIf="totalAvisos > 0" class="table-pagination">
      <span class="pagination-info">
        Mostrando datos {{ ((paginaActual - 1) * porPagina) + 1 }} a {{ Math.min(paginaActual * porPagina, totalAvisos) }} de {{ totalAvisos }} servicios
      </span>
      <div class="pagination">
        <!-- Botón Primera Página -->
        <button 
          class="pagination-btn" 
          [disabled]="!puedeAnterior()"
          (click)="primeraPagina()"
          title="Primera página">
          <ion-icon name="chevron-back-outline"></ion-icon>
          <ion-icon name="chevron-back-outline"></ion-icon>
        </button>

        <!-- Botón Página Anterior -->
        <button 
          class="pagination-btn" 
          [disabled]="!puedeAnterior()"
          (click)="paginaAnterior()"
          title="Página anterior">
          <ion-icon name="chevron-back-outline"></ion-icon>
        </button>

        <!-- Páginas -->
        <ng-container *ngFor="let pagina of obtenerRangoPaginas()">
          <button 
            class="pagination-btn" 
            [class.active]="pagina === paginaActual"
            (click)="cambiarPagina(pagina)">
            {{ pagina }}
          </button>
        </ng-container>

        <!-- Botón Página Siguiente -->
        <button 
          class="pagination-btn" 
          [disabled]="!puedeSiguiente()"
          (click)="paginaSiguiente()"
          title="Página siguiente">
          <ion-icon name="chevron-forward-outline"></ion-icon>
        </button>

        <!-- Botón Última Página -->
        <button 
          class="pagination-btn" 
          [disabled]="!puedeSiguiente()"
          (click)="ultimaPagina()"
          title="Última página">
          <ion-icon name="chevron-forward-outline"></ion-icon>
          <ion-icon name="chevron-forward-outline"></ion-icon>
        </button>
      </div>
    </div>
  </section>
</ion-content>
