<div class="factura-container">
  <!-- Loading State para edición -->
  <div *ngIf="loading && isEditing" class="loading-state">
    <div class="loading-spinner">
      <ion-icon name="refresh-outline" class="spinning"></ion-icon>
      <p>Cargando factura para editar...</p>
    </div>
  </div>

  <div class="factura-formulario" *ngIf="!loading || !isEditing">
    <div class="header-container">  
      <h2>{{ isEditing ? 'Editar Factura' : 'Crear Factura' }}</h2>
      <div class="actions-preview">
        <button type="button" class="btn-outline" (click)="toggleVistaPrevia()">
          <ion-icon name="eye-outline"></ion-icon>
          <span class="button-text">Vista previa</span>
        </button>
      </div>
    </div>
    

    <form [formGroup]="facturaForm">
      <div class="grid-datos">
        <div class="form-group">
          <label>Número Factura</label>
          <input type="text" formControlName="numeroFactura" placeholder="#876370A" />
        </div>
        <div class="form-group">
          <label>Fecha de emisión</label>
          <input type="date" formControlName="fecha" />
        </div>
        
        <!-- Selector de cliente -->
        <div class="form-group cliente-selector">
          <label>Cliente</label>
          <div class="cliente-input-container">
            <input 
              type="text" 
              [(ngModel)]="terminoBusqueda" 
              (input)="buscarClientes()"
              (focus)="abrirSelectorClientes()"
              placeholder="Buscar cliente por nombre, CIF o email..."
              class="cliente-search-input"
              [ngModelOptions]="{standalone: true}">
            <button type="button" class="btn-search-cliente" (click)="abrirSelectorClientes()">
              <ion-icon name="search-outline"></ion-icon>
            </button>
          </div>
          
          <!-- Cliente seleccionado -->
          <div *ngIf="clienteSeleccionado" class="cliente-seleccionado">
            <div class="cliente-info">
              <span class="cliente-nombre">{{ clienteSeleccionado.nombre_completo }}</span>
              <span class="cliente-details">{{ clienteSeleccionado.cif }} • {{ clienteSeleccionado.email }}</span>
            </div>
            <button type="button" class="btn-clear-cliente" (click)="limpiarClienteSeleccionado()">
              <ion-icon name="close-outline"></ion-icon>
            </button>
          </div>
          
          <!-- Lista de clientes -->
          <div *ngIf="mostrarSelectorClientes" class="clientes-dropdown">
            <div class="clientes-header">
              <span>Seleccionar cliente</span>
              <button type="button" class="btn-close-dropdown" (click)="cerrarSelectorClientes()">
                <ion-icon name="close-outline"></ion-icon>
              </button>
            </div>
            <div class="clientes-list">
              <div 
                *ngFor="let cliente of clientesFiltrados" 
                class="cliente-item"
                (click)="seleccionarCliente(cliente)">
                <div class="cliente-item-info">
                  <span class="cliente-item-nombre">{{ cliente.nombre_completo }}</span>
                  <span class="cliente-item-details">
                    {{ cliente.cif || 'Sin CIF' }} • {{ cliente.email || 'Sin email' }}
                  </span>
                </div>
                <ion-icon name="person-outline" class="cliente-item-icon"></ion-icon>
              </div>
              <div *ngIf="clientesFiltrados.length === 0" class="no-clientes">
                No se encontraron clientes
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Nombre</label>
          <input type="text" formControlName="nombre" placeholder="Ejemplo" readonly />
        </div>
        <div class="form-group">
          <label>Dirección</label>
          <input type="text" formControlName="direccion" placeholder="Calle" readonly />
        </div>
        <div class="form-group">
          <label>CIF/NIF</label>
          <input type="text" formControlName="cif" placeholder="12345678A" readonly />
        </div>
        <div class="form-group">
          <label>Correo electrónico</label>
          <input type="email" formControlName="email" placeholder="ejemplo@gmail.com" readonly />
        </div>
      </div>

      <!-- Repuestos -->
      <section class="tabla-section">
        <div class="tabla-header">
          <span>Repuestos Utilizados</span>
          <button type="button" class="icon-btn add-btn" (click)="agregarRepuesto()"><span>+</span></button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Cantidad</th>
              <th>Neto</th>
              <th>PVP</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let repuesto of repuestos; let i = index">
              <td>
                <input type="text" [(ngModel)]="repuesto.nombre" [ngModelOptions]="{standalone: true}" placeholder="Nombre del repuesto" class="table-input">
              </td>
              <td>
                <input type="number" [(ngModel)]="repuesto.cantidad" [ngModelOptions]="{standalone: true}" min="0" step="0.01" class="table-input">
              </td>
              <td>
                <input type="number" [(ngModel)]="repuesto.precio_neto" [ngModelOptions]="{standalone: true}" min="0" step="0.01" class="table-input" placeholder="0.00">
              </td>
              <td class="success">
                <input type="number" [(ngModel)]="repuesto.precio_pvp" [ngModelOptions]="{standalone: true}" min="0" step="0.01" class="table-input" placeholder="0.00">
              </td>
              <td class="trash-btn">
                <button type="button" class="icon-btn danger" (click)="eliminarRepuesto(i)">
                  <ion-icon name="trash"></ion-icon>
                </button>
              </td>
            </tr>
            <tr *ngIf="repuestos.length === 0" class="empty-row">
              <td colspan="5" class="text-center">No hay repuestos añadidos</td>
            </tr>
            <tr class="total-row" *ngIf="repuestos.length > 0">
              <td colspan="2">Total</td>
              <td>{{ totalRepuestosNeto | currency:'EUR':'symbol':'1.2-2' }}</td>
              <td class="success">{{ totalRepuestosPvp | currency:'EUR':'symbol':'1.2-2' }}</td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Mano de obra -->
      <section class="tabla-section">
        <div class="tabla-header">
          <span>Mano de Obra</span>
          <button type="button" class="icon-btn add-btn" (click)="agregarManoObra()"><span>+</span></button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Cantidad</th>
              <th>PVP</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let mano of manoObra; let i = index">
              <td>
                <input type="text" [(ngModel)]="mano.nombre" [ngModelOptions]="{standalone: true}" placeholder="Descripción del trabajo" class="table-input">
              </td>
              <td>
                <input type="number" [(ngModel)]="mano.cantidad" [ngModelOptions]="{standalone: true}" min="0" step="0.01" class="table-input" placeholder="Horas">
              </td>
              <td class="success">
                <input type="number" [(ngModel)]="mano.precio_pvp" [ngModelOptions]="{standalone: true}" min="0" step="0.01" class="table-input" placeholder="0.00">
              </td>
              <td class="trash-btn">
                <button type="button" class="icon-btn danger" (click)="eliminarManoObra(i)">
                  <ion-icon name="trash"></ion-icon>
                </button>
              </td>
            </tr>
            <tr *ngIf="manoObra.length === 0" class="empty-row">
              <td colspan="4" class="text-center">No hay mano de obra añadida</td>
            </tr>
            <tr class="total-row" *ngIf="manoObra.length > 0">
              <td colspan="2">Total</td>
              <td class="success">{{ totalManoObra | currency:'EUR':'symbol':'1.2-2' }}</td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Desplazamiento -->
      <section class="tabla-section">
        <div class="tabla-header">
          <span>Desplazamiento</span>
          <button type="button" class="icon-btn add-btn" (click)="agregarDesplazamiento()"><span>+</span></button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Cantidad</th>
              <th>PVP</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let desplazamiento of desplazamientos; let i = index">
              <td>
                <input type="text" [(ngModel)]="desplazamiento.nombre" [ngModelOptions]="{standalone: true}" placeholder="Tipo de desplazamiento" class="table-input">
              </td>
              <td>
                <input type="number" [(ngModel)]="desplazamiento.cantidad" [ngModelOptions]="{standalone: true}" min="0" step="0.01" class="table-input" placeholder="Cantidad">
              </td>
              <td class="success">
                <input type="number" [(ngModel)]="desplazamiento.precio_pvp" [ngModelOptions]="{standalone: true}" min="0" step="0.01" class="table-input" placeholder="0.00">
              </td>
              <td class="trash-btn">
                <button type="button" class="icon-btn danger" (click)="eliminarDesplazamiento(i)">
                  <ion-icon name="trash"></ion-icon>
                </button>
              </td>
            </tr>
            <tr *ngIf="desplazamientos.length === 0" class="empty-row">
              <td colspan="4" class="text-center">No hay desplazamientos añadidos</td>
            </tr>
            <tr class="total-row" *ngIf="desplazamientos.length > 0">
              <td colspan="2">Total</td>
              <td class="success">{{ totalDesplazamiento | currency:'EUR':'symbol':'1.2-2' }}</td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </section>

      <section class="tabla-section">
        <div class="tabla-header" style="margin-bottom: 20px;">
          <span>Detalles descripción</span>
        </div>

        <div class="form-group">
          <textarea formControlName="notas" placeholder="Notas"></textarea>
        </div>
      </section>

    </form>
  </div>

  <!-- Vista previa -->
  <div class="factura-preview" [class.active]="mostrarVistaPrevia">
    <div class="header-container">
      <h2>Vista previa</h2>
      <div class="actions-preview">
        <button type="button" class="btn-outline" (click)="descargarFactura()">
          <ion-icon name="download"></ion-icon>
          <span class="button-text">Descargar</span>
        </button>
        <button type="button" class="btn-primary" (click)="imprimirFactura()">
          <ion-icon name="print"></ion-icon>
          <span class="button-text">Imprimir</span>
        </button>
        <button type="button" class="btn-close" (click)="toggleVistaPrevia()">
          <ion-icon name="close-outline"></ion-icon>
          <span class="button-text">Cerrar</span>
        </button>
      </div>  
    </div>
    <div class="preview-header">
      <div class="logo-box">
        <img src="assets/icon/favicon.png" alt="Logo" />
      </div>
      <div class="empresa-datos">
        <div>
          <span class="empresa-nombre">Datos de empresa</span>
          <span>Nombre de empresa</span>
          <address>Dirección de empresa</address>
          <span>Ciudad de empresa</span>
          <span>CIF de empresa</span>
          <span style="margin-top: 20px;">ejemplodominio.es</span>
          <span>+34 123 45 56 65</span>
        </div>
        <div class="factura-info">
          <label class="factura-label">Factura</label>
          <label style="color: #111827; font-weight: 500;">Nº FACTURA</label>
          <label>{{ facturaForm.get('numeroFactura')?.value || 'N/A' }}</label>
          <label style="color: #111827; font-weight: 500;">FECHA DE EMISIÓN</label>
          <label>{{ facturaForm.get('fecha')?.value ? (facturaForm.get('fecha')?.value | date:'longDate':'':'es') : 'N/A' }}</label>
        </div>
      </div>
    </div>

    <!-- Datos del cliente -->
    <div class="cliente-datos">
      <h3>Datos del Cliente</h3>
      <div class="cliente-info">
        <p><strong>Nombre:</strong> {{ facturaForm.get('nombre')?.value || 'Sin nombre' }}</p>
        <p><strong>Dirección:</strong> {{ facturaForm.get('direccion')?.value || 'Sin dirección' }}</p>
        <p><strong>CIF/NIF:</strong> {{ facturaForm.get('cif')?.value || 'Sin CIF' }}</p>
        <p><strong>Email:</strong> {{ facturaForm.get('email')?.value || 'Sin email' }}</p>
      </div>
    </div>

    <div class="preview-tabla">
      <table>
        <thead>
          <tr>
            <th>Repuestos utilizados</th>
            <th>CANTIDAD</th>
            <th>NETO</th>
            <th>PVP</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let repuesto of repuestos">
            <td>{{ repuesto.nombre || 'Sin nombre' }}</td>
            <td>{{ repuesto.cantidad || 0 }}</td>
            <td>{{ repuesto.precio_neto || 0 | currency:'EUR':'symbol':'1.2-2' }}</td>
            <td>{{ repuesto.precio_pvp || 0 | currency:'EUR':'symbol':'1.2-2' }}</td>
          </tr>
          <tr *ngIf="repuestos.length === 0">
            <td colspan="4" class="text-center">No hay repuestos</td>
          </tr>
          <tr class="total-row" *ngIf="repuestos.length > 0">
            <td><b>TOTAL</b></td>
            <td></td>
            <td class="success">{{ totalRepuestosNeto | currency:'EUR':'symbol':'1.2-2' }}</td>
            <td class="success">{{ totalRepuestosPvp | currency:'EUR':'symbol':'1.2-2' }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="preview-tabla">
      <table>
        <thead>
          <tr>
            <th>Mano de obra/Kilometraje</th>
            <th>CANTIDAD</th>
            <th>PVP</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let mano of manoObra">
            <td>{{ mano.nombre || 'Sin descripción' }}</td>
            <td>{{ mano.cantidad || 0 }}h</td>
            <td>{{ mano.precio_pvp || 0 | currency:'EUR':'symbol':'1.2-2' }}</td>
          </tr>
          <tr *ngFor="let desplazamiento of desplazamientos">
            <td>{{ desplazamiento.nombre || 'Sin descripción' }}</td>
            <td>{{ desplazamiento.cantidad || 0 }}</td>
            <td>{{ desplazamiento.precio_pvp || 0 | currency:'EUR':'symbol':'1.2-2' }}</td>
          </tr>
          <tr *ngIf="manoObra.length === 0 && desplazamientos.length === 0">
            <td colspan="3" class="text-center">No hay mano de obra ni desplazamientos</td>
          </tr>
          <tr class="total-row" *ngIf="manoObra.length > 0 || desplazamientos.length > 0">
            <td colspan="2"><b>TOTAL</b></td>
            <td class="success">{{ totalManoObra + totalDesplazamiento | currency:'EUR':'symbol':'1.2-2' }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="preview-totales-box">
      <div class="totales-row">
        <span>Subtotal</span>
        <span>{{ subtotal | currency:'EUR':'symbol':'1.2-2' }}</span>
      </div>
      <div class="totales-row">
        <span>IVA (21%)</span>
        <span>{{ iva | currency:'EUR':'symbol':'1.2-2' }}</span>
      </div>
      <div class="totales-row total-final">
        <span>TOTAL</span>
        <span>{{ total | currency:'EUR':'symbol':'1.2-2' }}</span>
      </div>
    </div>

    <div class="preview-notas">
      <b>Notas</b>
      <div class="notas-texto">
        {{ facturaForm.get('notas')?.value || 'Sin notas adicionales' }}
      </div>
    </div>
    <div class="preview-footer">
      <span>Nombre de empresa</span>
      <span>+34 698 12 12 12</span>
      <span>ejemploemail.com</span>
    </div>
  </div>

  <!-- Footer con botones de acción -->
  <ion-footer class="factura-footer" [translucent]="true">
    <ion-toolbar>
      <div class="footer-buttons">
        <button 
          type="button"
          class="btn btn-outline" 
          (click)="enviarFactura()" 
          [disabled]="loading || !facturaForm.valid">
          <ion-icon name="send-outline"></ion-icon>
          {{ loading ? 'Enviando...' : (isEditing ? 'Actualizar factura' : 'Enviar factura') }}
        </button>
        
        <button 
          type="button"
          class="btn btn-primary" 
          (click)="generarFactura()" 
          [disabled]="loading || !facturaForm.valid">
          <ion-icon name="save-outline"></ion-icon>
          {{ loading ? 'Generando...' : (isEditing ? 'Guardar cambios' : 'Generar factura') }}
        </button>
      </div>
    </ion-toolbar>
  </ion-footer>
</div>